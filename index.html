<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì‘ì „ìƒí™©ì‹¤</title>
    <script src="gamedata.js"></script>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        *, *::before, *::after { box-sizing: border-box; }
        body { background-color: #1e2330; color: #d8dce6; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding-bottom: 100px; }
        .container { max-width: 600px; margin: 0 auto; padding: 12px; }

        .box { background: #2a3040; border: 1px solid #3d4a5c; border-radius: 12px; padding: 14px; margin-bottom: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .neon-blue { border-left: 4px solid #5ba8c8; }
        .neon-green { border-left: 4px solid #6bbd7a; }
        .neon-purple { border-left: 4px solid #a87ccf; }
        .neon-red { border-left: 4px solid #d47474; }

        input, select, textarea { width: 100%; min-width: 0; padding: 10px 12px; margin: 4px 0; background: #354050; border: 1px solid #4d5a6e; color: #e0e4ec; border-radius: 6px; font-size: 14px; }
        button { width: 100%; padding: 11px; margin-top: 5px; background: #3a4758; color: #e0e4ec; border: 1px solid #4d5a6e; border-radius: 6px; font-weight: bold; cursor: pointer; }
        button:disabled { color: #6a7080; border-color: #3d4a5c; cursor: not-allowed; }
        .hidden { display: none !important; }

        /* --- ë± ì»¨í…Œì´ë„ˆ --- */
        .deck-container {
            display: flex; flex-wrap: wrap; gap: 6px;
            justify-content: flex-start; align-items: flex-start;
            background: #323d50; padding: 10px; border-radius: 8px; margin: 10px 0;
        }

        .hero-card { display: flex; flex-direction: column; align-items: center; flex: 1 0 80px; max-width: calc(33.33% - 4px); background: #2a3444; border-radius: 8px; padding: 5px; border: 1px solid #3d4a5c; overflow: hidden; }
        .hero-slot { width: 48px; height: 48px; border-radius: 50%; background: #4a5568; border: 2px solid #5f6d82; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; margin-bottom: 4px; flex-shrink: 0; }
        .hero-slot img { width: 100%; height: 100%; object-fit: cover; object-position: top 10%; }

        .equipment-grid { display: grid; width: 100%; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: auto auto; gap: 2px; grid-template-areas: "w1 a1 acc" "w2 a2 acc"; }
        .gear-slot, .acc-slot { background: #3a4758; border: 1px solid #4d5a6e; border-radius: 3px; display: flex; align-items: center; justify-content: center; color: #c0c8d8; cursor: pointer; text-align: center; overflow: hidden; padding: 2px; }
        .gear-slot { flex-direction: column; font-size: 8.5px; line-height: 1.25; min-height: 28px; }
        .acc-slot { font-size: 8.5px; line-height: 1.2; }
        .slot-w1 { grid-area: w1; border-color: #7a4a4a; color: #f0c0c0; }
        .slot-a1 { grid-area: a1; border-color: #4a4a7a; color: #c0c0f0; }
        .slot-w2 { grid-area: w2; border-color: #7a4a4a; color: #f0c0c0; }
        .slot-a2 { grid-area: a2; border-color: #4a4a7a; color: #c0c0f0; }
        .acc-slot { grid-area: acc; border-color: #7a6a3a; color: #f0e8c0; }

        .pet-wrapper { flex: 1 0 80px; max-width: calc(33.33% - 4px); display: flex; align-items: center; justify-content: center; background: #2a3444; border-radius: 8px; padding: 5px; border: 1px dashed #5f6d82; }
        .pet-slot { width: 62px; height: 62px; border-radius: 8px; background: #3a4758; border: 2px dashed #5f6d82; overflow: hidden; display:flex; align-items:center; justify-content:center; cursor: pointer; font-size: 10px; color: #8090a8; text-align: center; }
        .pet-slot img { width: 100%; height: 100%; object-fit: cover; }

        /* ê³µëµ ì¹´ë“œ */
        .strategy-card { background: #323d50; border: 1px solid #4d5a6e; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; text-align: left; }
        .strategy-deck-preview { display: flex; gap: 4px; margin: 8px 0; flex-wrap: wrap; }
        .strategy-icon { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #5f6d82; overflow: hidden; background: #3a4758; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #a0a8b8; }
        .strategy-icon img { width: 100%; height: 100%; object-fit: cover; object-position: top 10%; }

        #activeStrategyNote { background: #3a4758; color: #f0d060; border: 1px solid #c8a840; padding: 10px; margin-bottom: 10px; border-radius: 6px; text-align: left; font-size: 0.9em; display: none; }

        /* ëª¨ë‹¬ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(15,20,30,0.85); align-items: center; justify-content: center; }
        .modal-content { background-color: #2a3040; padding: 15px; border-radius: 12px; width: 90%; max-width: 450px; max-height: 80vh; display: flex; flex-direction: column; border: 1px solid #4d5a6e; }
        .hero-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; overflow-y: auto; padding: 10px; align-content: start; }
        .hero-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .hero-circle { width: 48px; height: 48px; border-radius: 50%; border: 2px solid #5f6d82; overflow: hidden; background: #3a4758; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #a0a8b8; }
        .hero-circle img { width: 100%; height: 100%; object-fit: cover; object-position: top 15%; }
        .hero-name { font-size: 11px; color: #c0c8d8; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 50px;}

        .gear-modal-grid { display: flex; gap: 5px; height: 300px; }
        .gear-col { flex: 1; overflow-y: auto; background: #2a3444; border: 1px solid #4d5a6e; border-radius: 4px; display:flex; flex-direction:column;}
        .gear-btn, .acc-btn { padding: 12px; background: transparent; color: #a0a8b8; border: none; border-bottom: 1px solid #3d4a5c; text-align: left; cursor: pointer; }
        .gear-btn.selected { background: #2a6058; color: #fff; font-weight: bold; }
        .acc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; overflow-y: auto; max-height: 380px; margin-top:10px;}
        .acc-btn { border:1px solid #4d5a6e; background:#3a4758; border-radius:6px; text-align:center; padding:6px 2px; display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; }
        .acc-btn img { width:36px; height:36px; object-fit:contain; }
        .acc-btn span { font-size:9px; color:#c0c8d8; line-height:1.2; word-break:keep-all; }

        /* --- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ --- */
        .tab-nav { display: flex; gap: 0; margin-bottom: 16px; border-radius: 8px; overflow: hidden; border: 1px solid #4d5a6e; }
        .tab-btn { flex: 1; padding: 11px 4px; background: #2a3040; color: #8090a8; border: none; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tab-btn.active { background: #3a4758; color: #f0d060; border-bottom: 3px solid #f0d060; }

        /* --- ê³µì„±ì „ ìŠ¤í‚¬ ë²„íŠ¼ --- */
        .skill-btns { display: flex; gap: 2px; margin-top: 4px; width: 100%; }
        .skill-btn { flex: 1; padding: 3px 1px; font-size: 9px; font-weight: bold; border-radius: 3px; border: 1px solid #5f6d82; background: #323d50; color: #a0a8b8; cursor: pointer; text-align: center; width: auto; min-width: 0; overflow: hidden; }
        .skill-btn:hover { background: #4a5568; color: #fff; }
        .skill-btn.s1 { border-color: #c89840; color: #f0c860; }
        .skill-btn.s2 { border-color: #4090c0; color: #60b8e8; }

        /* --- ìŠ¤í‚¬ íŒŒì´í”„ë¼ì¸ --- */
        .pipeline-area { background: #253040; border: 1px solid #4d5a6e; border-radius: 8px; padding: 12px; margin-top: 10px; }
        .pipeline-display { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; min-height: 36px; padding: 8px; background: #1e2830; border-radius: 6px; overflow: hidden; }
        .pipeline-item { display: inline-flex; align-items: center; gap: 3px; background: #2e3a50; border: 1px solid #5f6d82; border-radius: 4px; padding: 4px 6px; font-size: 11px; color: #d8dce6; max-width: 100%; overflow: hidden; }
        .pipeline-item .pi-icon { width: 20px; height: 20px; border-radius: 50%; overflow: hidden; flex-shrink: 0; }
        .pipeline-item .pi-icon img { width: 100%; height: 100%; object-fit: cover; object-position: top 10%; }
        .pipeline-item.s1 { border-color: #c89840; }
        .pipeline-item.s2 { border-color: #4090c0; }
        .pipeline-arrow { color: #6a7a90; font-size: 14px; }
        .pipeline-controls { display: flex; gap: 8px; margin-top: 8px; }
        .pipeline-controls button { width: auto; flex: 1; padding: 8px; font-size: 12px; }

        /* --- ìš”ì¼ ì„ íƒ --- */
        .day-nav { display: flex; gap: 3px; margin-bottom: 12px; }
        .day-btn { flex: 1; padding: 9px 2px; background: #323d50; color: #8090a8; border: 1px solid #4d5a6e; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; min-width: 0; overflow: hidden; }
        .day-btn.active { background: #a87ccf; color: #fff; border-color: #a87ccf; }
        .day-btn.sat { }
        .day-btn.sun { }
        .day-btn.sat.active { background: #4090c0; border-color: #4090c0; }
        .day-btn.sun.active { background: #d47474; border-color: #d47474; }

        /* --- íŒŒê´´ì‹  ì‚¬í™© ì„ íƒ --- */
        .sahwang-nav { display: flex; gap: 6px; margin-bottom: 12px; }
        .sahwang-btn { flex: 1; padding: 10px 4px; background: #323d50; color: #8090a8; border: 2px solid #4d5a6e; border-radius: 8px; font-size: 13px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .sahwang-btn .sh-icon { width: 36px; height: 36px; border-radius: 50%; overflow: hidden; border: 2px solid #5f6d82; }
        .sahwang-btn .sh-icon img { width: 100%; height: 100%; object-fit: cover; object-position: top 10%; }
        .sahwang-btn.active { background: #4a3060; border-color: #a87ccf; color: #e0d0f0; }

        /* --- ê°•ë¦¼ ì›ì •ëŒ€ --- */
        .advent-boss-nav { display: flex; gap: 5px; margin-bottom: 12px; flex-wrap: wrap; }
        .advent-boss-btn { flex: 1; min-width: 58px; padding: 8px 4px; background: #323d50; color: #8090a8; border: 2px solid #4d5a6e; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 3px; position: relative; width: auto; }
        .advent-boss-img { width: 36px; height: 36px; border-radius: 50%; overflow: hidden; border: 2px solid #5f6d82; background: #4a5568; display: flex; align-items: center; justify-content: center; }
        .advent-boss-img img { width: 100%; height: 100%; object-fit: cover; object-position: top 10%; }
        .advent-boss-btn.active { background: #4a3060; border-color: #a87ccf; color: #e0d0f0; }
        .advent-boss-btn.active .advent-boss-img { border-color: #a87ccf; }
        .advent-boss-btn.cleared .advent-boss-img { border-color: #6bbd7a; }
        .advent-boss-btn.final-boss.active { background: #602030; border-color: #d47474; color: #f0d0d0; }
        .advent-boss-btn.locked { cursor: not-allowed; opacity: 0.5; }
        .clear-badge { position: absolute; top: 3px; right: 3px; background: #6bbd7a; color: #1e2330; border-radius: 50%; width: 15px; height: 15px; font-size: 9px; display: flex; align-items: center; justify-content: center; font-weight: bold; line-height: 1; }
        .team-divider { border-color: #4d5a6e; margin: 14px 0; }
        .team-label { margin: 0 0 8px 0; padding: 6px 10px; border-radius: 6px; font-size: 13px; display: inline-block; }
        .team1-label { background: #1e3050; color: #80b8e0; border-left: 3px solid #4090c0; }
        .team2-label { background: #40203a; color: #e080c0; border-left: 3px solid #c04090; }

        /* --- ë¡œë”© í™”ë©´ --- */
        #loadingArea { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e2330; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 48px; height: 48px; border: 4px solid #3d4a5c; border-top-color: #f0d060; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- ê¶Œí•œ ë±ƒì§€ --- */
        .badge-admin { display:inline-block; font-size:10px; padding:2px 7px; border-radius:3px; background:#4a3060; color:#a87ccf; font-weight:bold; }
        .badge-user  { display:inline-block; font-size:10px; padding:2px 7px; border-radius:3px; background:#1e3050; color:#5ba8c8; font-weight:bold; }

        /* --- ì‚¬ìš©ì ì •ë³´ ë°” --- */
        #userInfoBar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding:8px 12px; background:#2a3040; border-radius:8px; border:1px solid #3d4a5c; }
        #userInfoBar .ui-name { color:#f0d060; font-weight:bold; font-size:14px; }
        #userInfoBar .ui-btns { display:flex; gap:6px; }
        #userInfoBar .ui-btns button { width:auto; padding:5px 10px; font-size:12px; margin:0; }

        /* --- ë©¤ë²„ ê´€ë¦¬ ì¹´ë“œ --- */
        .member-card { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#323d50; border-radius:8px; margin-bottom:6px; gap:8px; }
        .member-card .mc-name { color:#d8dce6; font-size:13px; }
        .member-card .mc-btns { display:flex; gap:5px; flex-shrink:0; }
        .member-card .mc-btns button { width:auto; padding:5px 10px; font-size:11px; margin:0; }

        /* --- ê°€ì…ì‹ ì²­ ì˜ì—­ --- */
        #signupArea { margin-top:12px; padding-top:12px; border-top:1px solid #3d4a5c; }

        /* --- ëŠ¥ë ¥ì¹˜ ë²„íŠ¼/í‘œì‹œ --- */
        .stats-btn { font-size:9px; padding:2px 4px; margin-top:3px; background:#1e2a3a; border:1px solid #3d5a7a; color:#7ab0d8; width:100%; border-radius:3px 3px 0 0; cursor:pointer; }
        .stats-btn.has-stats { border-color:#5ba8c8; color:#a0d8f0; background:#1a2f45; }
        .stats-btn:only-child, .stats-btn + :not(.hero-stats-display) { border-radius:3px; }
        .hero-stats-display { width:100%; background:#111d2b; border:1px solid #5ba8c8; border-top:none; border-radius:0 0 4px 4px; padding:5px 6px; }
        .sd-row { display:flex; justify-content:space-between; align-items:baseline; gap:4px; padding:1.5px 0; border-bottom:1px solid #1e2e40; }
        .sd-row:last-child { border-bottom:none; }
        .sd-label { font-size:10px; color:#6a8aaa; flex-shrink:0; white-space:nowrap; }
        .sd-val   { font-size:11px; color:#60c8f0; font-weight:bold; text-align:right; word-break:break-all; }
    </style>
</head>
<body>

<div id="loadingArea" class="hidden">
    <div class="spinner"></div>
    <p id="loadingMsg" style="color:#8090a8; font-size: 15px;">ì„œë²„ ì—°ê²° ì¤‘...</p>
    <button id="loadingCancelBtn" onclick="cancelAutoLogin()" class="hidden" style="margin-top:10px; width:auto; padding:10px 24px; background:#3a4758; border:1px solid #4d5a6e; border-radius:6px; color:#d8dce6;">ë‹¤ì‹œ ì‹œë„</button>
</div>

<div class="container">
    <h2 style="color:#f0d060; text-shadow:0 0 8px rgba(240,208,96,0.3);">âš”ï¸ ì‘ì „ìƒí™©ì‹¤</h2>

    <div id="loginArea" class="box neon-blue">
        <h3>ğŸ” ë¡œê·¸ì¸</h3>
        <input type="text" id="myNick" placeholder="ë‹‰ë„¤ì„">
        <input type="password" id="myKey" placeholder="í‚¤ (ë¹„ë°€ë²ˆí˜¸)">
        <p id="loginMsg" style="color:#8090a8; display:none;">ì ‘ì† ì¤‘...</p>
        <button onclick="tryLogin()">ì ‘ì†í•˜ê¸°</button>
        <button onclick="toggleSignup()" style="background:#2a3a4a; border-color:#5ba8c8; color:#5ba8c8; margin-top:6px;">ğŸ“ ê°€ì… ì‹ ì²­</button>

        <div id="signupArea" class="hidden">
            <h4 style="color:#6bbd7a; margin:0 0 8px 0; text-align:left;">ì‹ ê·œ ê°€ì… ì‹ ì²­</h4>
            <input type="text" id="signupNick" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„">
            <input type="password" id="signupKey" placeholder="ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)">
            <input type="password" id="signupKeyConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
            <p id="signupMsg" style="display:none; font-size:13px; margin:4px 0;"></p>
            <button onclick="submitSignup(event)" style="background:#2a6050; border-color:#6bbd7a; color:#6bbd7a;">ì‹ ì²­í•˜ê¸°</button>
            <button onclick="toggleSignup()" style="background:#8a4040;">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="mainArea" class="hidden">

        <div id="userInfoBar">
            <div>
                <span id="userNickDisplay" class="ui-name"></span>
                <span id="userRoleDisplay" style="margin-left:6px;"></span>
            </div>
            <div class="ui-btns">
                <button onclick="openPwChangeModal(false)" style="background:#3a4758;">ğŸ”‘ ë¹„ë²ˆë³€ê²½</button>
                <button onclick="logout()" style="background:#8a4040;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('guild')">ê¸¸ë“œì „</button>
            <button class="tab-btn" onclick="switchTab('siege')">ê³µì„±ì „</button>
            <button class="tab-btn" onclick="switchTab('advent')">ê°•ë¦¼ì›ì •</button>
            <button class="tab-btn hidden" id="adminTabBtn" onclick="switchTab('admin')">âš™ï¸ ê´€ë¦¬</button>
        </div>

        <div id="guildWarTab">
        <div class="box neon-green">
            <h3>1. íƒ€ê²Ÿ ë° ê³µëµ í™•ì¸</h3>
            <select id="enemySelect" onchange="selectEnemy()">
                <option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
            </select>

            <div id="enemyDeckVisual" class="deck-container" style="justify-content: center; min-height: 56px;">
                <span style="color:#5f6d82; line-height:60px;">ìƒëŒ€ ì •ë³´ ëŒ€ê¸° ì¤‘</span>
            </div>
            <input type="hidden" id="currentEnemyDeck">

            <div id="strategyBox" style="margin-top:10px;"></div>
        </div>

        <div class="box neon-purple">
            <h3>2. ë‚´ ê³µê²©íŒ€ êµ¬ì„±</h3>
            <div id="activeStrategyNote"></div>
            <div class="info-row">
                <select id="myFormation">
                    <option value="ê¸°ë³¸">ê¸°ë³¸ ì§„í˜•</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option>
                </select>
                <input type="text" id="myKeyItems" placeholder="ë©”ëª¨ (í« ìŠ¤í‚¬ ë“±)">
            </div>
            <div class="deck-container" id="myBattleDeckContainer"></div>
            <input type="hidden" id="myBattleDeckResult"><input type="hidden" id="myBattlePetResult">
        </div>

        <div class="box neon-red">
            <h3>3. ê²°ê³¼ ê¸°ë¡</h3>
            <div style="display:flex; gap:10px;">
                <button onclick="record(event,'WIN')" style="background:#3a7a50;">â­â­â­ ìŠ¹ë¦¬</button>
                <button onclick="record(event,'LOSE')" style="background:#8a4040;">âŒ íŒ¨ë°°</button>
            </div>
        </div>

        <button id="toggleAdminBtn" onclick="toggleAdmin()" class="hidden" style="background:#3a4758; margin-top:20px;">ğŸ› ï¸ ê³µëµ/ì êµ° ê´€ë¦¬</button>

        <div id="adminArea" class="hidden" style="margin-top:20px;">
            <div class="box neon-blue">
                <h3>ğŸ“œ ì‹ ê·œ ê³µëµ ë“±ë¡</h3>
                <select id="targetEnemySelect"></select>
                <div class="info-row">
                    <select id="newFormation"><option value="ê¸°ë³¸">ê¸°ë³¸</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option></select>
                    <input type="text" id="newKeyItems" placeholder="íŠ¹ì´ì‚¬í•­">
                </div>
                <div class="deck-container" id="newAttackDeckContainer"></div>
                <input type="hidden" id="newAttackDeckResult"><input type="hidden" id="newAttackPetResult">
                <textarea id="newStrategyNote" placeholder="ìƒì„¸ ê³µëµ ì‘ì„±" style="height:60px;"></textarea>
                <button onclick="addStrategy(event)">ê³µëµ ë“±ë¡ ì™„ë£Œ</button>
            </div>
            <div class="box neon-blue">
                <h3>ğŸ‘¾ ì êµ° ì¶”ê°€</h3>
                <input type="text" id="newEnemyName" placeholder="ì  ë‹‰ë„¤ì„">
                <div class="deck-container" onclick="openSelector('enemy', 'HERO')" style="justify-content:center; cursor:pointer;">
                    <div id="preview_enemy_1" class="hero-slot">+</div><div id="preview_enemy_2" class="hero-slot">+</div><div id="preview_enemy_3" class="hero-slot">+</div>
                </div>
                <input type="hidden" id="newEnemyDeckResult">
                <button onclick="addNewEnemy(event)">ì êµ° ë“±ë¡ ì™„ë£Œ</button>
            </div>
        </div>
        </div><!-- /guildWarTab -->

        <div id="siegeWarTab" class="hidden">

        <div class="day-nav">
            <button class="day-btn" onclick="switchSiegeDay('mon')">ì›”</button>
            <button class="day-btn" onclick="switchSiegeDay('tue')">í™”</button>
            <button class="day-btn" onclick="switchSiegeDay('wed')">ìˆ˜</button>
            <button class="day-btn" onclick="switchSiegeDay('thu')">ëª©</button>
            <button class="day-btn" onclick="switchSiegeDay('fri')">ê¸ˆ</button>
            <button class="day-btn sat" onclick="switchSiegeDay('sat')">í† </button>
            <button class="day-btn sun" onclick="switchSiegeDay('sun')">ì¼</button>
        </div>

        <div class="box neon-purple">
            <h3 id="siegeDayTitle">ê³µì„±ì „ íŒ€ êµ¬ì„±</h3>
            <div class="info-row">
                <select id="siegeFormation">
                    <option value="ê¸°ë³¸">ê¸°ë³¸ ì§„í˜•</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option>
                </select>
                <input type="text" id="siegeKeyItems" placeholder="ë©”ëª¨">
            </div>
            <div class="deck-container" id="siegeDeckContainer"></div>

            <div class="pipeline-area">
                <h4 style="color:#a0a8b8; margin:0 0 8px 0;">ìŠ¤í‚¬ íŒŒì´í”„ë¼ì¸</h4>
                <div class="pipeline-display" id="pipelineDisplay">
                    <span style="color:#5f6d82;">ìŠ¤í‚¬ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìˆœì„œë¥¼ ì§€ì •í•˜ì„¸ìš”</span>
                </div>
                <div class="pipeline-controls">
                    <button onclick="undoPipeline()" style="background:#4a5568;">ë˜ëŒë¦¬ê¸°</button>
                    <button onclick="clearPipeline()" style="background:#8a4040;">ì´ˆê¸°í™”</button>
                </div>
                <div style="margin-top:8px; padding:6px; background:#2a3444; border-radius:4px;">
                    <span style="font-size:11px; color:#8090a8;">ê²°ê³¼: </span>
                    <span id="pipelineText" style="font-size:11px; color:#6bbd7a;"></span>
                </div>
            </div>

            <button onclick="saveSiege(event)" style="background:#3a7a50; margin-top:10px;">ì €ì¥</button>
        </div>
        </div><!-- /siegeWarTab -->

        <div id="adventTab" class="hidden">
            <div class="advent-boss-nav" id="adventBossNav"></div>

            <div class="box neon-purple" id="adventBossSection">
                <h3 id="adventBossTitle" style="margin:0 0 12px 0;">ë³´ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>

                <div class="team-label team1-label">âš”ï¸ 1íŒ€</div>
                <div style="display:flex; gap:6px; margin:6px 0;">
                    <select id="adventFormation_1" style="flex:1;">
                        <option value="ê¸°ë³¸">ê¸°ë³¸ ì§„í˜•</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option>
                    </select>
                    <input type="text" id="adventKeyItems_1" placeholder="ë©”ëª¨" style="flex:2;">
                </div>
                <div class="deck-container" id="adventDeckContainer_1"></div>
                <div class="pipeline-area">
                    <h4 style="color:#a0a8b8; margin:0 0 8px 0;">ìŠ¤í‚¬ íŒŒì´í”„ë¼ì¸</h4>
                    <div class="pipeline-display" id="adventPipelineDisplay_1"><span style="color:#5f6d82;">ìŠ¤í‚¬ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìˆœì„œë¥¼ ì§€ì •í•˜ì„¸ìš”</span></div>
                    <div class="pipeline-controls">
                        <button onclick="undoAdventPipeline(1)" style="background:#4a5568;">ë˜ëŒë¦¬ê¸°</button>
                        <button onclick="clearAdventPipeline(1)" style="background:#8a4040;">ì´ˆê¸°í™”</button>
                    </div>
                    <div style="margin-top:8px; padding:6px; background:#2a3444; border-radius:4px;">
                        <span style="font-size:11px; color:#8090a8;">ê²°ê³¼: </span>
                        <span id="adventPipelineText_1" style="font-size:11px; color:#6bbd7a;"></span>
                    </div>
                </div>

                <hr class="team-divider">

                <div class="team-label team2-label">âš”ï¸ 2íŒ€</div>
                <div style="display:flex; gap:6px; margin:6px 0;">
                    <select id="adventFormation_2" style="flex:1;">
                        <option value="ê¸°ë³¸">ê¸°ë³¸ ì§„í˜•</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option>
                    </select>
                    <input type="text" id="adventKeyItems_2" placeholder="ë©”ëª¨" style="flex:2;">
                </div>
                <div class="deck-container" id="adventDeckContainer_2"></div>
                <div class="pipeline-area">
                    <h4 style="color:#a0a8b8; margin:0 0 8px 0;">ìŠ¤í‚¬ íŒŒì´í”„ë¼ì¸</h4>
                    <div class="pipeline-display" id="adventPipelineDisplay_2"><span style="color:#5f6d82;">ìŠ¤í‚¬ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìˆœì„œë¥¼ ì§€ì •í•˜ì„¸ìš”</span></div>
                    <div class="pipeline-controls">
                        <button onclick="undoAdventPipeline(2)" style="background:#4a5568;">ë˜ëŒë¦¬ê¸°</button>
                        <button onclick="clearAdventPipeline(2)" style="background:#8a4040;">ì´ˆê¸°í™”</button>
                    </div>
                    <div style="margin-top:8px; padding:6px; background:#2a3444; border-radius:4px;">
                        <span style="font-size:11px; color:#8090a8;">ê²°ê³¼: </span>
                        <span id="adventPipelineText_2" style="font-size:11px; color:#6bbd7a;"></span>
                    </div>
                </div>

                <button onclick="saveAdvent(event)" style="background:#3a7a50; margin-top:10px;">ğŸ’¾ ì €ì¥</button>
            </div>
        </div><!-- /adventTab -->

        <div id="adminMgmtTab" class="hidden">
            <div class="box neon-blue">
                <h3>ğŸ“‹ ê°€ì… ì‹ ì²­ ëª©ë¡</h3>
                <div id="pendingMembersList"><p style="color:#5f6d82;">ë¡œë”© ì¤‘...</p></div>
            </div>
            <div class="box neon-green">
                <h3>ğŸ‘¥ ë©¤ë²„ ê´€ë¦¬</h3>
                <div id="allMembersList"><p style="color:#5f6d82;">ë¡œë”© ì¤‘...</p></div>
            </div>
        </div><!-- /adminMgmtTab -->

    </div>
</div>

<div id="selectorModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">ì„ íƒ</h3>
        <input type="text" id="searchBox" onkeyup="filterItems()" placeholder="ê²€ìƒ‰...">
        <div id="itemGrid" class="hero-grid"></div>
        <button onclick="closeSelectorModal()" style="background:#8a4040; margin-top:10px;">ì·¨ì†Œ</button>
    </div>
</div>

<div id="gearModal" class="modal">
    <div class="modal-content">
        <h3 id="gearModalTitle" style="margin-top:0;">ì¥ë¹„ ì„¤ì •</h3>
        <div class="gear-modal-grid">
            <div class="gear-col"><h4>ì„¸íŠ¸</h4><div id="gearSetList"></div></div>
            <div class="gear-col"><h4>ì£¼ì˜µì…˜</h4><div id="gearOptionList"></div></div>
        </div>
        <div style="padding:10px; background:#3a4758; text-align:center;"><span id="gearPreviewText" style="color:#6bbd7a;">-</span></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="confirmGear()" style="background:#3a7a50;">í™•ì¸</button>
            <button onclick="closeGearModal()" style="background:#8a4040;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="pwChangeModal" class="modal" style="z-index:1100;">
    <div class="modal-content" style="max-width:360px;">
        <h3 style="margin-top:0; color:#f0d060;">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
        <p id="pwChangeReason" style="color:#d47474; font-size:13px; margin:0 0 10px 0;"></p>
        <input type="password" id="pwNew" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)">
        <input type="password" id="pwNewConfirm" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
        <p id="pwChangeMsg" style="display:none; color:#d47474; font-size:13px; margin:4px 0;"></p>
        <button onclick="changePassword(event)" style="background:#3a7a50; margin-top:10px;">ë³€ê²½í•˜ê¸°</button>
        <button id="pwSkipBtn" onclick="closePwChangeModal()" style="background:#4a5568;">ë‚˜ì¤‘ì—</button>
    </div>
</div>

<div id="heroStatsModal" class="modal" style="z-index:1100;">
    <div class="modal-content" style="max-width:420px;">
        <h3 style="margin-top:0; color:#f0d060;">ğŸ“Š ìºë¦­í„° ì´í•© ëŠ¥ë ¥ì¹˜</h3>
        <p id="heroStatsHeroName" style="color:#a87ccf; font-size:13px; margin:0 0 12px 0;"></p>
        <div id="heroStatsFields" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; overflow-y:auto; max-height:55vh;"></div>
        <div style="display:flex; gap:8px; margin-top:14px;">
            <button onclick="confirmStats()" style="background:#3a7a50;">í™•ì¸</button>
            <button onclick="closeStatsModal()" style="background:#8a4040;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="accModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">ì¥ì‹ êµ¬ ì„ íƒ</h3>
        <input type="text" id="accSearchBox" onkeyup="filterAccItems()" placeholder="ê²€ìƒ‰...">
        <div id="accItemGrid" class="hero-grid"></div>
        <button onclick="closeAccModal()" style="background:#8a4040; margin-top:10px;">ì·¨ì†Œ</button>
    </div>
</div>

<script>
    // âš™ï¸ Supabase ì„¤ì •
    const SUPABASE_URL = "https://zobzzgvbqmkistvdlexi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvYnp6Z3ZicW1raXN0dmRsZXhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzAzODMsImV4cCI6MjA4NzQ0NjM4M30.uVjldZvtNsiA-_OAMf4y_Q_S0fHCnDHQinqQ4R10zS0"; // âš ï¸ ëŒ€ì‹œë³´ë“œ > Settings > API > anon public key ì…ë ¥

    // --- ì„¤ì •ê°’ ---
    const SESSION_TIMEOUT = 60 * 60 * 1000;

    // ë°ì´í„° ì •ì˜
    const DATA_HEROES = (typeof HEROES !== 'undefined') ? HEROES : ["ë£¨ë””", "ì—ë°˜", "ì œì´ë¸Œ"];
    const DATA_PETS = (typeof PETS !== 'undefined') ? PETS : ["ë£¨", "ì´ë¦°", "ë¦¬ì²¼", "í¬ë¦¬", "íŒŒì´í¬", "ë¸ë¡œ", "ìœˆë””", "ìœ ", "ì—°ì§€", "ì¹´ëŒ", "ë©œíŒ¨ë¡œ", "ì•„ì´ë°˜", "ì¹´ë Œ", "ë¦¬ì¿ ", "ì¥¬ì‹œ", "í—¬ë ˆí•€", "í—¤ë¦¬í•€", "ì œë‹ˆí¼", "ìœ ìš°", "í¬ë¡œì•„", "íŒŒë¼ê³¤", "ë…¸íŠ¸", "ë² ì´", "ë‹ˆí‚¤", "ì„¸ë¦¬", "R-rl", "í‘¸ë¦¬", "ì•„ì•¼", "ë¼êµ¬ë¦¬", "í•´ë¥´í”¼", "ì‚¬ë€", "ë‹ˆë‚˜", "í’ì†Œí˜‘", "ë®¤ë®¤", "ë¯¹", "ë”ì§€", "ì—ë¦¬", "ë¯¸ë¯¹", "ë‘"];

    const GEAR_SETS = ["ì„ ë´‰ì¥", "ì¶”ì ì", "ì„±ê¸°ì‚¬", "ìˆ˜ë¬¸ì¥", "ìˆ˜í˜¸ì", "ì•”ì‚´ì", "ë³µìˆ˜ì", "ì£¼ìˆ ì‚¬", "ì¡°ìœ¨ì"];
    const OPTS_WEAPON = ["ì•½ì  ê³µê²© í™•ë¥ ", "ì¹˜ëª…íƒ€ í™•ë¥ ", "ì¹˜ëª…íƒ€ í”¼í•´", "ëª¨ë“  ê³µê²©ë ¥(%)", "ëª¨ë“  ê³µê²©ë ¥", "ë°©ì–´ë ¥(%)", "ë°©ì–´ë ¥", "ìƒëª…ë ¥(%)", "ìƒëª…ë ¥", "íš¨ê³¼ì ì¤‘"];
    const OPTS_ARMOR = ["ë°›ëŠ”í”¼í•´ê°ì†Œ", "ë§‰ê¸°í™•ë¥ ", "ëª¨ë“  ê³µê²©ë ¥(%)", "ëª¨ë“  ê³µê²©ë ¥", "ë°©ì–´ë ¥(%)", "ë°©ì–´ë ¥", "ìƒëª…ë ¥(%)", "ìƒëª…ë ¥", "íš¨ê³¼ì €í•­"];
    const GEAR_ACCESSORIES = (typeof ACC !== 'undefined') ? ACC : ["ë¶€í™œì˜ ë°˜ì§€", "ë¶ˆì‚¬ì˜ ë°˜ì§€", "ê¶ŒëŠ¥ì˜ ë°˜ì§€", "ê¸°í•©ì˜ ë°˜ì§€"];

    // --- ëŠ¥ë ¥ì¹˜ í•„ë“œ ì •ì˜ ---
    const STAT_FIELDS = [
        {key:'atkPhys',   label:'ê³µê²©ë ¥(ë¬¼ë¦¬)',   short:'ë¬¼ê³µ'},
        {key:'atkMagic',  label:'ê³µê²©ë ¥(ë§ˆë²•)',   short:'ë§ˆê³µ'},
        {key:'def',       label:'ë°©ì–´ë ¥',         short:'ë°©ì–´'},
        {key:'hp',        label:'ìƒëª…ë ¥',         short:'ìƒëª…'},
        {key:'speed',     label:'ì†ê³µ',           short:'ì†ê³µ'},
        {key:'critRate',  label:'ì¹˜ëª…íƒ€ í™•ë¥ ',    short:'ì¹˜í™•'},
        {key:'critDmg',   label:'ì¹˜ëª…íƒ€ í”¼í•´',    short:'ì¹˜í”¼'},
        {key:'weakAtk',   label:'ì•½ì  ê³µê²© í™•ë¥ ', short:'ì•½ê³µ'},
        {key:'block',     label:'ë§‰ê¸° í™•ë¥ ',      short:'ë§‰ê¸°'},
        {key:'dmgReduce', label:'ë°›ê¸° í”¼í•´ ê°ì†Œ', short:'ë°›í”¼'},
        {key:'effAcc',    label:'íš¨ê³¼ ì ì¤‘',      short:'íš¨ì '},
        {key:'effRes',    label:'íš¨ê³¼ ì €í•­',      short:'íš¨ì €'},
    ];

    // ë¹ˆ ì˜ì›… ìŠ¬ë¡¯ ìƒì„±
    const emptyHero = () => ({name:"", w1:"", a1:"", w2:"", a2:"", acc:"", stats:{}});

    // --- ë± ì§ë ¬í™”/íŒŒì‹± í—¬í¼ ---
    function parseHeroToken(p) {
        // "[stats...]" íŒŒì‹±
        let stats = {}, token = p;
        const bs = p.lastIndexOf('['), be = p.lastIndexOf(']');
        if(bs > -1 && be > bs) {
            p.substring(bs+1, be).split(';').forEach(pair => {
                const ci = pair.indexOf(':');
                if(ci > 0) stats[pair.substring(0,ci).trim()] = pair.substring(ci+1).trim();
            });
            token = p.substring(0, bs);
        }
        // "Name(w1/a1/w2/a2/acc)" íŒŒì‹±
        const fp = token.indexOf('('), lp = token.lastIndexOf(')');
        const hero = emptyHero();
        hero.stats = stats;
        if(fp > 0 && lp > fp) {
            hero.name = token.substring(0, fp).trim();
            const g = token.substring(fp+1, lp).split('/');
            hero.w1=g[0]||""; hero.a1=g[1]||""; hero.w2=g[2]||""; hero.a2=g[3]||""; hero.acc=g[4]||"";
        } else {
            hero.name = token.trim();
        }
        return hero;
    }

    function serializeHero(x) {
        if(!x.name) return null;
        let base = (x.w1||x.a1||x.w2||x.a2||x.acc)
            ? `${x.name}(${x.w1||"-"}/${x.a1||"-"}/${x.w2||"-"}/${x.a2||"-"}/${x.acc||"-"})`
            : x.name;
        const statsEntries = STAT_FIELDS.filter(f => x.stats && x.stats[f.key]).map(f => `${f.key}:${x.stats[f.key]}`);
        if(statsEntries.length) base += `[${statsEntries.join(';')}]`;
        return base;
    }

    function renderStatsBtn(mode, idx, stats) {
        if(!stats) return '';
        const setStats = STAT_FIELDS.filter(f => stats[f.key]);
        const cnt = setStats.length;
        const btn = `<button class="stats-btn${cnt?' has-stats':''}" onclick="openStatsModal('${mode}',${idx})">ğŸ“Š ëŠ¥ë ¥ì¹˜${cnt?` (${cnt})`:' ì„¤ì •'}</button>`;
        if(!cnt) return btn;
        const rows = setStats.map(f =>
            `<div class="sd-row">
                <span class="sd-label">${f.short}</span>
                <span class="sd-val">${stats[f.key]}</span>
             </div>`
        ).join('');
        return btn + `<div class="hero-stats-display">${rows}</div>`;
    }

    // --- SHA-256 í—¬í¼ ---
    async function sha256(str) {
        const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
        return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // --- ì´ë¯¸ì§€ ê²½ë¡œ í—¬í¼ ---
    function heroImg(n) { return `images/heros/${n}.png`; }
    function petImg(n)  { return `images/pets/${n}.png`; }
    function accImg(n)  { return `images/accesories/${n}.png`; }
    function getAccAbbr(name) {
        if(!name) return "";
        let s = name, grade = "";
        if(s.startsWith("ê³ ê¸‰ ")) { grade = "â˜…"; s = s.slice(3); }
        else if(s.startsWith("ë‚¡ì€ ")) { grade = "â–¼"; s = s.slice(3); }
        return grade + s.replace("ì˜ ë°˜ì§€", "").replace(" ë°˜ì§€", "");
    }

    // ë³€ìˆ˜
    let myDeckState = Array(3).fill().map(emptyHero);
    let adminDeckState = Array(3).fill().map(emptyHero);
    let myPetState = "", adminPetState = "", tempEnemyHeroes = [];
    let globalData = { members: [], enemies: [], strategies: [] };
    let currentMode = "", currentGearIndex = 0, currentGearSlot = "", tempGearSet = "", tempGearOpt = "", tempHeroIndex = 0;
    let currentStatsMode = "", currentStatsIdx = 0;

    // ì‚¬ìš©ì ì„¸ì…˜ ì •ë³´
    let currentUserRole = '';       // 'admin' | 'user'
    let currentUserMustChangePw = false;

    // ê°•ë¦¼ ì›ì •ëŒ€ ë³€ìˆ˜
    const ADVENT_BOSSES = ['íƒœì˜¤', 'ì¹´ì¼', 'ì—°í¬', 'ì¹´ë¥´ë§ˆ'];
    const ADVENT_FINAL_BOSS = 'íŒŒê´´ì‹ ';
    let currentAdventBoss = ADVENT_BOSSES[0];
    let adventData = {};
    [...ADVENT_BOSSES, ADVENT_FINAL_BOSS].forEach(boss => {
        adventData[boss] = {
            team1: { deck: Array(5).fill().map(emptyHero), pet:"", pipeline:[], formation:"ê¸°ë³¸", memo:"" },
            team2: { deck: Array(5).fill().map(emptyHero), pet:"", pipeline:[], formation:"ê¸°ë³¸", memo:"" },
            cleared: false
        };
    });

    // ê³µì„±ì „ ë³€ìˆ˜
    const DAYS = ['mon','tue','wed','thu','fri','sat','sun'];
    const DAY_LABELS = {mon:'ì›”',tue:'í™”',wed:'ìˆ˜',thu:'ëª©',fri:'ê¸ˆ',sat:'í† ',sun:'ì¼'};
    let currentSiegeDay = "";
    let siegeData = {};
    DAYS.forEach(d => { siegeData[d] = { deck: Array(5).fill().map(emptyHero), pet:"", pipeline:[], formation:"ê¸°ë³¸", memo:"" }; });
    let siegeDeckState = siegeData.mon.deck;
    let siegePetState = "";
    let skillPipeline = [];

    // --- ì´ˆê¸°í™” ë° ì„¸ì…˜ ì²´í¬ ---
    window.onload = function() {
        checkSession();

        document.addEventListener('click', refreshSession);
        document.addEventListener('keydown', refreshSession);
        document.addEventListener('touchstart', refreshSession);

        renderInteractiveDeck('myBattle');
        renderInteractiveDeck('attack');

        const jsDay = new Date().getDay();
        const dayMap = [6,0,1,2,3,4,5];
        switchSiegeDay(DAYS[dayMap[jsDay]]);

        renderAdventBossNav();
        loadAdventBossState(currentAdventBoss);
    };

    function checkSession() {
        const savedNick = localStorage.getItem("guildWarNick");
        const expiryTime = localStorage.getItem("guildWarExpiry");

        if (savedNick && expiryTime) {
            const now = new Date().getTime();
            if (now > parseInt(expiryTime)) {
                logout("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
            } else {
                document.getElementById('loadingArea').classList.remove('hidden');
                document.getElementById('loginArea').classList.add('hidden');
                document.getElementById('myNick').value = savedNick;
                tryLogin(true);
            }
        }
    }

    function refreshSession() {
        if (!document.getElementById('mainArea').classList.contains('hidden')) {
            localStorage.setItem("guildWarExpiry", new Date().getTime() + SESSION_TIMEOUT);
        }
    }

    function logout(msg = "") {
        localStorage.removeItem("guildWarNick");
        localStorage.removeItem("guildWarExpiry");
        if(msg) alert(msg);
        location.reload();
    }

    // --- Supabase REST API í—¬í¼ ---
    async function sbFetch(method, table, body=null, params="", extraHeaders={}, signal=null) {
        const url = `${SUPABASE_URL}/rest/v1/${table}${params}`;
        const opts = {
            method,
            headers: {
                "apikey": SUPABASE_ANON_KEY,
                "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
                "Content-Type": "application/json",
                ...extraHeaders
            }
        };
        if(signal) opts.signal = signal;
        if(body !== null) opts.body = JSON.stringify(body);
        const r = await fetch(url, opts);
        if(!r.ok) throw new Error(await r.text());
        const text = await r.text();
        return text ? JSON.parse(text) : null;
    }

    // --- ë¡œê·¸ì¸ ---
    let _loginAbortController = null;
    let _loginTimeoutId = null;

    function cancelAutoLogin() {
        if(_loginAbortController) _loginAbortController.abort();
        clearTimeout(_loginTimeoutId);
        document.getElementById('loadingArea').classList.add('hidden');
        document.getElementById('loginArea').classList.remove('hidden');
    }

    async function tryLogin(isAuto=false) {
        const nick = document.getElementById('myNick').value;
        const key  = document.getElementById('myKey').value;
        const msg  = document.getElementById('loginMsg');

        if(!isAuto && (!nick||!key)) return alert("ì…ë ¥í•˜ì„¸ìš”");

        msg.style.display = 'block';
        if(!isAuto) msg.innerText = "ì„œë²„ ì—°ê²° ì¤‘...";

        let signal = undefined;
        if(isAuto) {
            _loginAbortController = new AbortController();
            _loginTimeoutId = setTimeout(() => {
                _loginAbortController.abort();
                document.getElementById('loadingMsg').innerText = "ì—°ê²°ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤.";
                document.getElementById('loadingCancelBtn').classList.remove('hidden');
            }, 10000);
            signal = _loginAbortController.signal;
        }

        try {
            const nickParam = encodeURIComponent(nick);
            const [members, enemies, strategies, siege, advent] = await Promise.all([
                sbFetch("GET", "members",    null, "?select=*", {}, signal),
                sbFetch("GET", "enemies",    null, "?select=*", {}, signal),
                sbFetch("GET", "strategies", null, "?select=*", {}, signal),
                sbFetch("GET", "siege",      null, `?select=*&nickname=eq.${nickParam}`, {}, signal),
                sbFetch("GET", "advent",     null, `?select=*&nickname=eq.${nickParam}`, {}, signal)
            ]);

            clearTimeout(_loginTimeoutId);

            // advent ì»¬ëŸ¼ëª… ë³€í™˜ (snake_case â†’ camelCase)
            const adventMapped = (advent||[]).map(row => ({
                nickname:       row.nickname,
                boss:           row.boss,
                team1Deck:      row.team1_deck      || "",
                team1Pet:       row.team1_pet        || "",
                team1Formation: row.team1_formation  || "ê¸°ë³¸",
                team1Memo:      row.team1_memo       || "",
                team1Pipeline:  row.team1_pipeline   || "",
                team2Deck:      row.team2_deck       || "",
                team2Pet:       row.team2_pet        || "",
                team2Formation: row.team2_formation  || "ê¸°ë³¸",
                team2Memo:      row.team2_memo       || "",
                team2Pipeline:  row.team2_pipeline   || "",
                cleared:        row.cleared          || "false"
            }));

            globalData = {
                members:    members    || [],
                enemies:    enemies    || [],
                strategies: strategies || [],
                siege:      siege      || [],
                advent:     adventMapped
            };

            let valid = false;
            let memberRecord = null;

            if(!isAuto) {
                const hashedKey = await sha256(key);
                memberRecord = globalData.members.find(m => String(m.nick) === nick && String(m.key) === hashedKey);
                if(memberRecord) {
                    if(memberRecord.status === 'active') {
                        valid = true;
                    } else if(memberRecord.status === 'pending') {
                        document.getElementById('loadingArea').classList.add('hidden');
                        document.getElementById('loginArea').classList.remove('hidden');
                        msg.innerText = "ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.";
                        msg.style.color = "#f0d060";
                        return;
                    } else {
                        document.getElementById('loadingArea').classList.add('hidden');
                        document.getElementById('loginArea').classList.remove('hidden');
                        msg.innerText = "ê°€ì…ì´ ê±°ì ˆëœ ê³„ì •ì…ë‹ˆë‹¤.";
                        msg.style.color = "#d47474";
                        return;
                    }
                }
            } else {
                // ìë™ ë¡œê·¸ì¸: ìƒíƒœ í™•ì¸
                memberRecord = globalData.members.find(m => String(m.nick) === nick);
                if(memberRecord && memberRecord.status !== 'active') {
                    clearTimeout(_loginTimeoutId);
                    logout("ê³„ì •ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
                    return;
                }
                valid = true; // ìë™ ë¡œê·¸ì¸ì€ localStorage ì‹ ë¢°
            }

            document.getElementById('loadingArea').classList.add('hidden');
            document.getElementById('loadingCancelBtn').classList.add('hidden');
            document.getElementById('loadingMsg').innerText = "ì„œë²„ ì—°ê²° ì¤‘...";

            if(valid) {
                // ì—­í•  ì„¤ì •
                currentUserRole = memberRecord ? (memberRecord.role || 'user') : 'user';
                currentUserMustChangePw = memberRecord ? (memberRecord.must_change_pw || false) : false;

                localStorage.setItem("guildWarNick", nick);
                refreshSession();
                document.getElementById('loginArea').classList.add('hidden');
                document.getElementById('mainArea').classList.remove('hidden');

                // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                document.getElementById('userNickDisplay').innerText = nick;
                document.getElementById('userRoleDisplay').innerHTML =
                    currentUserRole === 'admin'
                        ? '<span class="badge-admin">ê´€ë¦¬ì</span>'
                        : '<span class="badge-user">ì‚¬ìš©ì</span>';

                // ê´€ë¦¬ì UI í‘œì‹œ
                if(currentUserRole === 'admin') {
                    document.getElementById('adminTabBtn').classList.remove('hidden');
                    document.getElementById('toggleAdminBtn').classList.remove('hidden');
                }

                renderDropdowns();
                loadSiegeFromServer(nick);
                loadAdventFromServer(nick);

                // ì²« ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                if(currentUserMustChangePw) openPwChangeModal(true);
            } else {
                document.getElementById('loginArea').classList.remove('hidden');
                msg.innerText = "ë‹‰ë„¤ì„ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                msg.style.color = "#d47474";
            }
        } catch(e) {
            clearTimeout(_loginTimeoutId);
            document.getElementById('loadingArea').classList.add('hidden');
            document.getElementById('loadingCancelBtn').classList.add('hidden');
            document.getElementById('loadingMsg').innerText = "ì„œë²„ ì—°ê²° ì¤‘...";
            document.getElementById('loginArea').classList.remove('hidden');
            msg.innerText = e.name === 'AbortError' ? "ì—°ê²° ì‹œê°„ ì´ˆê³¼. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”." : "í†µì‹ ì˜¤ë¥˜";
            msg.style.color = "#d47474";
        }
    }

    function renderDropdowns() {
        const sel = document.getElementById('enemySelect'), adm = document.getElementById('targetEnemySelect');
        const v = sel.value;
        sel.innerHTML='<option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>'; adm.innerHTML='<option value="">-- ëŒ€ìƒ ì„ íƒ --</option>';
        globalData.enemies.forEach(e => { sel.add(new Option(e.name, e.name)); adm.add(new Option(e.name, e.name)); });
        if(v) sel.value = v;
    }

    // --- í…ìŠ¤íŠ¸ ì²˜ë¦¬ ---
    function getAbbr(t) {
        if(!t) return "";
        const m = {
            "ì„ ë´‰ì¥":"ì„ ë´‰", "ì¶”ì ì":"ì¶”ì ", "ì„±ê¸°ì‚¬":"ì„±ê¸°", "ìˆ˜ë¬¸ì¥":"ìˆ˜ë¬¸", "ìˆ˜í˜¸ì":"ìˆ˜í˜¸", "ì•”ì‚´ì":"ì•”ì‚´", "ë³µìˆ˜ì":"ë³µìˆ˜", "ì£¼ìˆ ì‚¬":"ì£¼ìˆ ", "ì¡°ìœ¨ì":"ì¡°ìœ¨",
            "ì•½ì  ê³µê²© í™•ë¥ ":"ì•½ê³µ", "ì¹˜ëª…íƒ€ í™•ë¥ ":"ì¹˜í™•", "ì¹˜ëª…íƒ€ í”¼í•´":"ì¹˜í”¼", "ëª¨ë“  ê³µê²©ë ¥(%)":"ê³µ%", "ëª¨ë“  ê³µê²©ë ¥":"ê³µ",
            "ë°©ì–´ë ¥(%)":"ë°©%", "ë°©ì–´ë ¥":"ë°©", "ìƒëª…ë ¥(%)":"ìƒ%", "ìƒëª…ë ¥":"ìƒ", "íš¨ê³¼ì ì¤‘":"íš¨ì ", "íš¨ê³¼ì €í•­":"íš¨ì €", "ë°›ëŠ”í”¼í•´ê°ì†Œ":"ë°›í”¼", "ë§‰ê¸°í™•ë¥ ":"ë§‰ê¸°",
            "ë¶€í™œì˜ ë°˜ì§€":"ë¶€í™œ", "ë¶ˆì‚¬ì˜ ë°˜ì§€":"ë¶ˆì‚¬", "ê¶ŒëŠ¥ì˜ ë°˜ì§€":"ê¶ŒëŠ¥", "ê¸°í•©ì˜ ë°˜ì§€":"ê¸°í•©", "ì² ë²½ì˜ ë°˜ì§€":"ì² ë²½",
            "ê±´ê°•ì˜ ë°˜ì§€":"ê±´ê°•", "í† ë²Œì˜ ë°˜ì§€":"í† ë²Œ", "ê³µì„±ì˜ ë°˜ì§€":"ê³µì„±", "ì„¬ë©¸ì˜ ë°˜ì§€":"ì„¬ë©¸", "ê·¼ì„±ì˜ ë°˜ì§€":"ê·¼ì„±"
        };
        return m[t] || t;
    }

    function formatGearSlot(fullText) {
        if(!fullText) return "";
        const firstParen = fullText.indexOf('(');
        const lastParen = fullText.lastIndexOf(')');
        if(firstParen > 0 && lastParen > firstParen) {
            const set = fullText.substring(0, firstParen);
            const opt = fullText.substring(firstParen + 1, lastParen);
            return `${getAbbr(set)}<br>${getAbbr(opt)}`;
        }
        return getAbbr(fullText);
    }

    // --- ë± ë Œë”ë§ ---
    function renderInteractiveDeck(mode) {
        const container = document.getElementById(mode==='myBattle'?'myBattleDeckContainer':'newAttackDeckContainer');
        const state = mode==='myBattle'?myDeckState:adminDeckState;
        const pState = mode==='myBattle'?myPetState:adminPetState;

        let h = "";
        state.forEach((o, i) => {
            const img = o.name ?
                `<img src="${heroImg(o.name)}" onerror="this.style.display='none'; this.parentNode.innerText='${o.name[0]}'">`
                : "+";
            const accContent = o.acc
                ? `<img src="${accImg(o.acc)}" style="width:22px;height:22px;object-fit:contain;" onerror="this.style.display='none'"><span style="font-size:7px;line-height:1;">${getAccAbbr(o.acc)}</span>`
                : 'Acc';

            h += `<div class="hero-card">
                    <div class="hero-slot" onclick="openSelector('${mode}','HERO',${i})">${img}</div>
                    <div class="equipment-grid">
                        <div class="gear-slot slot-w1" onclick="openGear('${mode}',${i},'w1')">${formatGearSlot(o.w1)||"W1"}</div>
                        <div class="gear-slot slot-a1" onclick="openGear('${mode}',${i},'a1')">${formatGearSlot(o.a1)||"A1"}</div>
                        <div class="acc-slot" onclick="openAcc('${mode}',${i})" style="flex-direction:column;">${accContent}</div>
                        <div class="gear-slot slot-w2" onclick="openGear('${mode}',${i},'w2')">${formatGearSlot(o.w2)||"W2"}</div>
                        <div class="gear-slot slot-a2" onclick="openGear('${mode}',${i},'a2')">${formatGearSlot(o.a2)||"A2"}</div>
                    </div>
                    ${o.name ? renderStatsBtn(mode, i, o.stats) : ''}
                  </div>`;
        });

        const pImg = pState ?
            `<img src="${petImg(pState)}" onerror="this.style.display='none'; this.parentNode.innerText='${pState}'">`
            : "<span style='font-size:10px;color:#888'>PET</span>";

        h += `<div class="pet-wrapper"><div class="pet-slot" onclick="openSelector('${mode}','PET')">${pImg}</div></div>`;
        container.innerHTML = h;

        const res = state.filter(x=>x.name).map(x => serializeHero(x)).join(", ");
        document.getElementById(mode==='myBattle'?'myBattleDeckResult':'newAttackDeckResult').value = res;
        document.getElementById(mode==='myBattle'?'myBattlePetResult':'newAttackPetResult').value = pState;
    }

    // --- ê°ì¢… ëª¨ë‹¬ ---
    function openSelector(mode, type, idx=0) {
        if(mode==='enemy') { currentMode=mode; openCommonModal('HERO'); return; }
        currentMode=mode; tempHeroIndex=idx;
        document.getElementById('modalTitle').innerText = type==='HERO'?"ì˜ì›… ì„ íƒ":"í« ì„ íƒ";
        openCommonModal(type);
    }
    function openCommonModal(type) {
        document.getElementById('searchBox').value=""; renderItemGrid(type);
        document.getElementById('selectorModal').style.display='flex';
    }
    // í˜„ì¬ ëª¨ë“œì—ì„œ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì˜ì›… ëª©ë¡ (í¸ì§‘ ì¤‘ì¸ ìŠ¬ë¡¯ ì œì™¸)
    function getUsedHeroes(mode) {
        if(mode === 'enemy') return [...tempEnemyHeroes];
        const state = getDeckState(mode);
        return state.filter((h, i) => h.name && i !== tempHeroIndex).map(h => h.name);
    }

    function renderItemGrid(type, filter="") {
        const g = document.getElementById('itemGrid'); g.innerHTML="";
        const src = type==='HERO'?DATA_HEROES:DATA_PETS;
        const usedHeroes = type==='HERO' ? getUsedHeroes(currentMode) : [];
        src.filter(x=>x.includes(filter)).forEach(item => {
            const isUsed = usedHeroes.includes(item);
            const d = document.createElement('div'); d.className='hero-item';
            const imgSrc = type === 'HERO' ? heroImg(item) : petImg(item);
            if(isUsed) {
                d.style.cssText = 'opacity:0.3; pointer-events:none;';
                d.innerHTML=`<div class="hero-circle"><img src="${imgSrc}" onerror="this.style.display='none'; this.parentNode.innerText='${item[0]}'"></div><div class="hero-name">${item}</div>`;
            } else {
                d.onclick=()=>{confirmSel(type,item)};
                d.innerHTML=`<div class="hero-circle"><img src="${imgSrc}" onerror="this.style.display='none'; this.parentNode.innerText='${item[0]}'"></div><div class="hero-name">${item}</div>`;
            }
            g.appendChild(d);
        });
    }
    function filterItems() { renderItemGrid(document.getElementById('modalTitle').innerText.includes("ì˜ì›…")?'HERO':'PET', document.getElementById('searchBox').value); }
    function getDeckState(mode) {
        if(mode==='myBattle') return myDeckState;
        if(mode==='siege') return siegeDeckState;
        if(mode==='advent1') return adventData[currentAdventBoss].team1.deck;
        if(mode==='advent2') return adventData[currentAdventBoss].team2.deck;
        return adminDeckState;
    }
    function renderDeckByMode(mode) {
        if(mode==='siege') renderSiegeDeck();
        else if(mode==='advent1') renderAdventDeck(1);
        else if(mode==='advent2') renderAdventDeck(2);
        else renderInteractiveDeck(mode);
    }

    function confirmSel(type, val) {
        if(currentMode==='enemy') { if(tempEnemyHeroes.length>=3) return alert("3ëª…ê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤"); tempEnemyHeroes.push(val); updateEnemyPrev(); }
        else {
            if(type==='HERO') getDeckState(currentMode)[tempHeroIndex].name=val;
            else {
                if(currentMode==='myBattle') myPetState=val;
                else if(currentMode==='siege') siegePetState=val;
                else if(currentMode==='advent1') adventData[currentAdventBoss].team1.pet=val;
                else if(currentMode==='advent2') adventData[currentAdventBoss].team2.pet=val;
                else adminPetState=val;
            }
            renderDeckByMode(currentMode);
        }
        closeSelectorModal();
    }
    function closeSelectorModal() { document.getElementById('selectorModal').style.display='none'; }

    // ì¥ë¹„
    function openGear(mode, idx, slot) {
        const s = getDeckState(mode); if(!s[idx].name) return alert("ì˜ì›… ë¨¼ì €");
        currentMode=mode; currentGearIndex=idx; currentGearSlot=slot; tempGearSet=""; tempGearOpt="";
        document.getElementById('gearPreviewText').innerText="-";
        const sd=document.getElementById('gearSetList'); sd.innerHTML="";
        GEAR_SETS.forEach(x=>{
            const b=document.createElement('button'); b.className="gear-btn"; b.innerText=x;
            b.onclick=()=>{tempGearSet=x; hl(sd,b); upG();}; sd.appendChild(b);
        });
        const od=document.getElementById('gearOptionList'); od.innerHTML="";
        (slot.includes('w')?OPTS_WEAPON:OPTS_ARMOR).forEach(x=>{
            const b=document.createElement('button'); b.className="gear-btn"; b.innerText=x;
            b.onclick=()=>{tempGearOpt=x; hl(od,b); upG();}; od.appendChild(b);
        });
        const r=document.createElement('button'); r.className="gear-btn"; r.innerText="(í•´ì œ)"; r.style.color="#d47474";
        r.onclick=()=>{tempGearSet="EMPTY"; confirmGear();}; od.appendChild(r);
        document.getElementById('gearModal').style.display='flex';
    }
    function hl(p,t) { Array.from(p.children).forEach(c=>c.classList.remove('selected')); t.classList.add('selected'); }
    function upG() { document.getElementById('gearPreviewText').innerText = `${tempGearSet}(${tempGearOpt})`; }
    function confirmGear() {
        const s = getDeckState(currentMode);
        if(tempGearSet==="EMPTY") s[currentGearIndex][currentGearSlot]="";
        else { if(!tempGearSet||!tempGearOpt) return alert("ë‘˜ ë‹¤ ì„ íƒ"); s[currentGearIndex][currentGearSlot]=`${tempGearSet}(${tempGearOpt})`; }
        renderDeckByMode(currentMode); closeGearModal();
    }
    function closeGearModal() { document.getElementById('gearModal').style.display='none'; }

    // ì¥ì‹ êµ¬
    function openAcc(mode, idx) {
        const s=getDeckState(mode); if(!s[idx].name) return alert("ì˜ì›… ë¨¼ì €");
        currentMode=mode; currentGearIndex=idx;
        document.getElementById('accSearchBox').value='';
        renderAccGrid('');
        document.getElementById('accModal').style.display='flex';
    }
    function renderAccGrid(filter) {
        const g=document.getElementById('accItemGrid'); g.innerHTML='';

        // í•´ì œ í•­ëª© (ê²€ìƒ‰ ì—†ì„ ë•Œë§Œ í‘œì‹œ)
        if(!filter) {
            const r=document.createElement('div'); r.className='hero-item';
            r.innerHTML=`<div class="hero-circle" style="border-color:#d47474;background:#3a2a2a;"><span style="font-size:22px;color:#d47474;">âœ•</span></div><div class="hero-name" style="color:#d47474;">í•´ì œ</div>`;
            r.onclick=()=>{ getDeckState(currentMode)[currentGearIndex].acc=""; renderDeckByMode(currentMode); closeAccModal(); };
            g.appendChild(r);
        }

        GEAR_ACCESSORIES.filter(x=>!filter||x.includes(filter)).forEach(x=>{
            const d=document.createElement('div'); d.className='hero-item';
            d.innerHTML=`<div class="hero-circle" style="border-radius:8px;"><img src="${accImg(x)}" style="object-fit:contain;" onerror="this.style.display='none';this.parentNode.innerText='${x[0]}'"></div><div class="hero-name" style="white-space:normal;max-width:54px;text-align:center;line-height:1.3;">${x}</div>`;
            d.onclick=()=>{ getDeckState(currentMode)[currentGearIndex].acc=x; renderDeckByMode(currentMode); closeAccModal(); };
            g.appendChild(d);
        });
    }
    function filterAccItems() { renderAccGrid(document.getElementById('accSearchBox').value); }
    function closeAccModal() { document.getElementById('accModal').style.display='none'; }

    // --- ê³µëµ ì ìš© ---
    function resetMyDeck() {
        myDeckState = Array(3).fill().map(emptyHero);
        myPetState = "";
        document.getElementById('myFormation').value = "ê¸°ë³¸";
        document.getElementById('myKeyItems').value = "";
        document.getElementById('activeStrategyNote').style.display = 'none';
        renderInteractiveDeck('myBattle');
    }

    function selectEnemy() {
        const n=document.getElementById('enemySelect').value; const e=globalData.enemies.find(x=>x.name===n);
        const v=document.getElementById('enemyDeckVisual');
        document.getElementById('activeStrategyNote').style.display = 'none';

        if(!n) {
            v.innerHTML="<span style='color:#5f6d82;line-height:60px'>ìƒëŒ€ ì •ë³´ ëŒ€ê¸° ì¤‘</span>";
            document.getElementById('strategyBox').innerHTML="";
            resetMyDeck();
            return;
        }
        if(!e) return v.innerHTML="<span style='color:#5f6d82;line-height:60px'>ì •ë³´ ì—†ìŒ</span>";
        document.getElementById('currentEnemyDeck').value=e.deck;

        let h="";
        e.deck.split(',').forEach(x=>{
            const name=x.split('(')[0].trim();
            h+=`<div class="hero-slot" style="margin:0 2px; border-color:#d47474;"><img src="${heroImg(name)}" onerror="this.style.display='none';this.parentNode.innerText='${name[0]}'"></div>`;
        });
        v.innerHTML=h;

        const sb=document.getElementById('strategyBox');
        const list=globalData.strategies.filter(x=>x.target===n);
        if(list.length>0) {
            let sh="";
            list.forEach((s,i)=>{
                let icons="";
                s.attack.split(',').forEach(k=>{
                    const firstParen = k.indexOf('(');
                    const name = firstParen > 0 ? k.substring(0, firstParen).trim() : k.trim();
                    icons+=`<div class="strategy-icon"><img src="${heroImg(name)}" onerror="this.style.display='none';"></div>`;
                });
                sh+=`<div class="strategy-card" onclick='applyStrategy(${JSON.stringify(s)})'>
                        <div style="display:flex;justify-content:space-between;"><span style="color:#f0d060">ì¶”ì²œ #${i+1} (${s.formation})</span><span style="font-size:0.8em;color:#8090a8">${s.pet}</span></div>
                        <div class="strategy-deck-preview">${icons}</div>
                        <div style="font-size:0.8em;color:#6bbd7a">ğŸ’¡ ${s.items||""}</div>
                     </div>`;
            });
            sb.innerHTML=sh;
        } else sb.innerHTML="<p style='color:#5f6d82'>ê³µëµ ì—†ìŒ</p>";
    }

    function applyStrategy(s) {
        myDeckState = Array(3).fill().map(emptyHero);
        const parts = s.attack.split(',').map(p=>p.trim());

        parts.forEach((p, i) => {
            if(i>=3) return;
            myDeckState[i] = parseHeroToken(p);
        });

        myPetState = s.pet || "";
        document.getElementById('myFormation').value = s.formation || "ê¸°ë³¸";
        document.getElementById('myKeyItems').value = s.items || "";

        const noteBox = document.getElementById('activeStrategyNote');
        if(s.note) {
            noteBox.style.display = 'block';
            noteBox.innerHTML = `<strong>ğŸ“ ê³µëµ ë…¸íŠ¸:</strong><br>${s.note.replace(/\n/g, '<br>')}`;
        } else {
            noteBox.style.display = 'none';
        }

        renderInteractiveDeck('myBattle');
        document.querySelector('.neon-purple').scrollIntoView({behavior:'smooth'});
        refreshSession();
    }

    // --- ë°ì´í„° ì“°ê¸° (Supabase) ---
    async function addStrategy(ev) {
        const t=document.getElementById('targetEnemySelect').value, d=document.getElementById('newAttackDeckResult').value;
        const p=document.getElementById('newAttackPetResult').value, f=document.getElementById('newFormation').value;
        const i=document.getElementById('newKeyItems').value, n=document.getElementById('newStrategyNote').value;
        const a=document.getElementById('myNick').value;

        if(!t||!d) return alert("í•„ìˆ˜ ì…ë ¥ ëˆ„ë½");

        const btn = ev.target; const orig = btn.innerText;
        btn.disabled=true; btn.innerText="ì²˜ë¦¬ ì¤‘...";
        try {
            await sbFetch("POST", "strategies",
                { target:t, attack:d, pet:p, formation:f, items:i, note:n, author:a },
                "", {"Prefer":"return=minimal"});

            alert("ê³µëµ ë“±ë¡ ì™„ë£Œ!");
            globalData.strategies.push({target:t, attack:d, pet:p, formation:f, items:i, note:n, author:a});
            if(document.getElementById('enemySelect').value === t) selectEnemy();

            document.getElementById('newKeyItems').value=""; document.getElementById('newStrategyNote').value="";
            adminDeckState = Array(3).fill().map(emptyHero);
            adminPetState = "";
            renderInteractiveDeck('attack');
            refreshSession();
        } catch(e) { alert("ì „ì†¡ ì˜¤ë¥˜"); }
        btn.disabled=false; btn.innerText=orig;
    }

    async function addNewEnemy(ev) {
        const n=document.getElementById('newEnemyName').value, d=document.getElementById('newEnemyDeckResult').value;
        if(!n||!d) return alert("ì…ë ¥ ëˆ„ë½");

        const btn = ev.target; const orig = btn.innerText;
        btn.disabled=true; btn.innerText="ì²˜ë¦¬ ì¤‘...";
        try {
            await sbFetch("POST", "enemies",
                { name:n, deck:d },
                "", {"Prefer":"return=minimal"});

            alert("ì êµ° ë“±ë¡ ì™„ë£Œ!");
            globalData.enemies.push({name:n, deck:d});
            renderDropdowns();
            document.getElementById('newEnemyName').value="";
            tempEnemyHeroes=[]; updateEnemyPrev();
            refreshSession();
        } catch(e) { alert("ì „ì†¡ ì˜¤ë¥˜"); }
        btn.disabled=false; btn.innerText=orig;
    }

    async function record(ev, r) {
        const t=document.getElementById('enemySelect').value, d=document.getElementById('myBattleDeckResult').value;
        if(!t||!d) return alert("í•„ìˆ˜ ì •ë³´ ëˆ„ë½");

        const btn = ev.target; const orig = btn.innerText;
        btn.disabled=true; btn.innerText="ì²˜ë¦¬ ì¤‘...";
        try {
            await sbFetch("POST", "battle_records", {
                nickname:   document.getElementById('myNick').value,
                enemy_name: t,
                enemy_deck: document.getElementById('currentEnemyDeck').value,
                my_deck:    d,
                pet:        document.getElementById('myBattlePetResult').value,
                formation:  document.getElementById('myFormation').value,
                result:     r
            }, "", {"Prefer":"return=minimal"});

            alert("ê¸°ë¡ ì™„ë£Œ!");
            refreshSession();
        } catch(e) { alert("ì „ì†¡ ì˜¤ë¥˜"); }
        btn.disabled=false; btn.innerText=orig;
    }

    function updateEnemyPrev() {
        for(let i=1; i<=3; i++) document.getElementById(`preview_enemy_${i}`).innerHTML=tempEnemyHeroes[i-1]?`<img src="${heroImg(tempEnemyHeroes[i-1])}" style="width:100%;height:100%;object-fit:cover;">`:"+";
        document.getElementById('newEnemyDeckResult').value=tempEnemyHeroes.join(',');
        if(tempEnemyHeroes.length > 0)
            document.getElementById('newEnemyName').value = tempEnemyHeroes.join(' | ');
    }

    function toggleAdmin() { document.getElementById('adminArea').classList.toggle('hidden'); }

    // --- íƒ­ ì „í™˜ ---
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const tabMap = ['guild','siege','advent','admin'];
        const idx = tabMap.indexOf(tab);
        const btns = document.querySelectorAll('.tab-btn');
        if(idx >= 0 && btns[idx]) btns[idx].classList.add('active');

        document.getElementById('guildWarTab').classList.toggle('hidden', tab!=='guild');
        document.getElementById('siegeWarTab').classList.toggle('hidden', tab!=='siege');
        document.getElementById('adventTab').classList.toggle('hidden', tab!=='advent');
        document.getElementById('adminMgmtTab').classList.toggle('hidden', tab!=='admin');

        if(tab === 'admin') loadAdminTab();
    }

    // --- ê°€ì… ì‹ ì²­ ---
    function toggleSignup() {
        document.getElementById('signupArea').classList.toggle('hidden');
        document.getElementById('signupMsg').style.display = 'none';
    }

    async function submitSignup(ev) {
        const nick = document.getElementById('signupNick').value.trim();
        const key  = document.getElementById('signupKey').value;
        const keyC = document.getElementById('signupKeyConfirm').value;
        const msg  = document.getElementById('signupMsg');

        const showMsg = (text, color='#d47474') => {
            msg.style.display='block'; msg.style.color=color; msg.innerText=text;
        };

        if(!nick || !key) return showMsg('ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        if(key.length < 4)  return showMsg('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        if(key !== keyC)    return showMsg('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');

        const btn = ev.target; const orig = btn.innerText;
        btn.disabled=true; btn.innerText='ì‹ ì²­ ì¤‘...';
        try {
            const existing = await sbFetch("GET", "members", null, `?nick=eq.${encodeURIComponent(nick)}&select=id`);
            if(existing && existing.length > 0) {
                showMsg('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
            } else {
                const hashedKey = await sha256(key);
                await sbFetch("POST", "members",
                    { nick, key: hashedKey, role:'user', status:'pending', must_change_pw:false },
                    "", {"Prefer":"return=minimal"});
                showMsg('ì‹ ì²­ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.', '#6bbd7a');
                document.getElementById('signupNick').value='';
                document.getElementById('signupKey').value='';
                document.getElementById('signupKeyConfirm').value='';
            }
        } catch(e) { showMsg('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
        btn.disabled=false; btn.innerText=orig;
    }

    // --- ì˜ì›… ëŠ¥ë ¥ì¹˜ ëª¨ë‹¬ ---
    function openStatsModal(mode, idx) {
        const state = getDeckState(mode);
        const hero = state[idx];
        if(!hero || !hero.name) return alert("ì˜ì›…ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”");
        currentStatsMode = mode;
        currentStatsIdx = idx;
        document.getElementById('heroStatsHeroName').innerText = `${hero.name} â€” ëª©í‘œ ëŠ¥ë ¥ì¹˜`;
        const stats = hero.stats || {};
        document.getElementById('heroStatsFields').innerHTML = STAT_FIELDS.map(f =>
            `<div>
                <label style="font-size:11px;color:#8090a8;display:block;margin-bottom:2px;">${f.label}</label>
                <input type="text" id="stat_${f.key}" value="${stats[f.key]||''}" placeholder="ì˜ˆ: 000ì´ìƒ">
            </div>`
        ).join('');
        document.getElementById('heroStatsModal').style.display = 'flex';
    }
    function closeStatsModal() {
        document.getElementById('heroStatsModal').style.display = 'none';
    }
    function confirmStats() {
        const state = getDeckState(currentStatsMode);
        if(!state || !state[currentStatsIdx]) return;
        const stats = {};
        STAT_FIELDS.forEach(f => {
            const val = document.getElementById(`stat_${f.key}`).value.trim();
            if(val) stats[f.key] = val;
        });
        state[currentStatsIdx].stats = stats;
        renderDeckByMode(currentStatsMode);
        closeStatsModal();
    }

    // --- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ---
    function openPwChangeModal(forced=false) {
        document.getElementById('pwChangeReason').innerText =
            forced ? 'âš ï¸ ì²« ë¡œê·¸ì¸ì…ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”.' : '';
        document.getElementById('pwSkipBtn').style.display = forced ? 'none' : '';
        document.getElementById('pwNew').value = '';
        document.getElementById('pwNewConfirm').value = '';
        document.getElementById('pwChangeMsg').style.display = 'none';
        document.getElementById('pwChangeModal').style.display = 'flex';
    }
    function closePwChangeModal() {
        document.getElementById('pwChangeModal').style.display = 'none';
    }
    async function changePassword(ev) {
        const newKey  = document.getElementById('pwNew').value;
        const confirm = document.getElementById('pwNewConfirm').value;
        const msgEl   = document.getElementById('pwChangeMsg');
        const showMsg = (t) => { msgEl.style.display='block'; msgEl.innerText=t; };

        if(!newKey || newKey.length < 4) return showMsg('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        if(newKey !== confirm) return showMsg('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');

        const btn = ev.target; const orig = btn.innerText;
        btn.disabled=true; btn.innerText='ë³€ê²½ ì¤‘...';
        try {
            const nick = document.getElementById('myNick').value;
            const hashedKey = await sha256(newKey);
            await sbFetch("PATCH", "members",
                { key: hashedKey, must_change_pw: false },
                `?nick=eq.${encodeURIComponent(nick)}`,
                {"Prefer":"return=minimal"});
            currentUserMustChangePw = false;
            closePwChangeModal();
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch(e) { showMsg('ë³€ê²½ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
        btn.disabled=false; btn.innerText=orig;
    }

    // --- ê´€ë¦¬ì: ë©¤ë²„ ê´€ë¦¬ ---
    async function loadAdminTab() {
        await Promise.all([loadPendingMembers(), loadAllMembers()]);
    }

    async function loadPendingMembers() {
        const el = document.getElementById('pendingMembersList');
        el.innerHTML = '<p style="color:#8090a8;">ë¡œë”© ì¤‘...</p>';
        try {
            const rows = await sbFetch("GET", "members", null, "?status=eq.pending&select=*&order=id.asc");
            if(!rows || rows.length === 0) {
                el.innerHTML = '<p style="color:#5f6d82;">ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return;
            }
            el.innerHTML = rows.map(m => `
                <div class="member-card">
                    <span class="mc-name">${m.nick}</span>
                    <div class="mc-btns">
                        <button onclick="approveMember(${m.id})" style="background:#3a7a50;">ìŠ¹ì¸</button>
                        <button onclick="rejectMember(${m.id},'${m.nick}')" style="background:#8a4040;">ê±°ì ˆ</button>
                    </div>
                </div>`).join('');
        } catch(e) { el.innerHTML = '<p style="color:#d47474;">ë¡œë“œ ì˜¤ë¥˜</p>'; }
    }

    async function loadAllMembers() {
        const el = document.getElementById('allMembersList');
        el.innerHTML = '<p style="color:#8090a8;">ë¡œë”© ì¤‘...</p>';
        try {
            const rows = await sbFetch("GET", "members", null, "?status=eq.active&select=*&order=nick.asc");
            if(!rows || rows.length === 0) {
                el.innerHTML = '<p style="color:#5f6d82;">ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return;
            }
            const myNick = document.getElementById('myNick').value;
            el.innerHTML = rows.map(m => `
                <div class="member-card">
                    <div>
                        <span class="mc-name">${m.nick}</span>
                        <span class="${m.role==='admin'?'badge-admin':'badge-user'}" style="margin-left:6px;">${m.role==='admin'?'ê´€ë¦¬ì':'ì‚¬ìš©ì'}</span>
                        ${m.must_change_pw ? '<span style="margin-left:4px;font-size:10px;color:#f0d060;">ğŸ”‘</span>' : ''}
                    </div>
                    <div class="mc-btns">
                        ${m.nick !== myNick ? `
                            <button onclick="toggleMemberRole(${m.id},'${m.role}')" style="background:#3a4758;" title="ê¶Œí•œ ë³€ê²½">${m.role==='admin'?'â†’ì‚¬ìš©ì':'â†’ê´€ë¦¬ì'}</button>
                            <button onclick="forcePwReset(${m.id})" style="background:#4a5040;" title="ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­">ğŸ”‘</button>
                            <button onclick="kickMember(${m.id},'${m.nick}')" style="background:#8a4040;">ì¶”ë°©</button>
                        ` : '<span style="font-size:11px;color:#5f6d82;">(ë³¸ì¸)</span>'}
                    </div>
                </div>`).join('');
        } catch(e) { el.innerHTML = '<p style="color:#d47474;">ë¡œë“œ ì˜¤ë¥˜</p>'; }
    }

    async function approveMember(id) {
        try {
            await sbFetch("PATCH","members",{status:'active'},`?id=eq.${id}`,{"Prefer":"return=minimal"});
            await loadPendingMembers(); await loadAllMembers();
        } catch(e) { alert('ì˜¤ë¥˜'); }
    }
    async function rejectMember(id, nick) {
        if(!confirm(`${nick}ë‹˜ì˜ ì‹ ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        try {
            await sbFetch("PATCH","members",{status:'rejected'},`?id=eq.${id}`,{"Prefer":"return=minimal"});
            await loadPendingMembers();
        } catch(e) { alert('ì˜¤ë¥˜'); }
    }
    async function toggleMemberRole(id, currentRole) {
        const newRole = currentRole === 'admin' ? 'user' : 'admin';
        if(!confirm(`ê¶Œí•œì„ '${newRole === 'admin' ? 'ê´€ë¦¬ì' : 'ì‚¬ìš©ì'}'ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        try {
            await sbFetch("PATCH","members",{role:newRole},`?id=eq.${id}`,{"Prefer":"return=minimal"});
            await loadAllMembers();
        } catch(e) { alert('ì˜¤ë¥˜'); }
    }
    async function forcePwReset(id) {
        if(!confirm('ë‹¤ìŒ ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì„ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            await sbFetch("PATCH","members",{must_change_pw:true},`?id=eq.${id}`,{"Prefer":"return=minimal"});
            await loadAllMembers();
        } catch(e) { alert('ì˜¤ë¥˜'); }
    }
    async function kickMember(id, nick) {
        if(!confirm(`${nick}ë‹˜ì„ ì¶”ë°©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        try {
            await sbFetch("PATCH","members",{status:'rejected'},`?id=eq.${id}`,{"Prefer":"return=minimal"});
            await loadAllMembers();
        } catch(e) { alert('ì˜¤ë¥˜'); }
    }

    // --- ìš”ì¼ ì „í™˜ ---
    function saveCurrentDayState() {
        if(!currentSiegeDay) return;
        const sd = siegeData[currentSiegeDay];
        sd.deck = siegeDeckState.map(o => ({...o}));
        sd.pet = siegePetState;
        sd.pipeline = skillPipeline.map(p => ({...p}));
        sd.formation = document.getElementById('siegeFormation').value;
        sd.memo = document.getElementById('siegeKeyItems').value;
    }

    function loadDayState(day) {
        const sd = siegeData[day];
        siegeDeckState = sd.deck;
        siegePetState = sd.pet;
        skillPipeline = sd.pipeline;
        document.getElementById('siegeFormation').value = sd.formation || "ê¸°ë³¸";
        document.getElementById('siegeKeyItems').value = sd.memo || "";
        document.getElementById('siegeDayTitle').innerText = `ê³µì„±ì „ íŒ€ êµ¬ì„± (${DAY_LABELS[day]}ìš”ì¼)`;
    }

    function switchSiegeDay(day) {
        saveCurrentDayState();
        currentSiegeDay = day;
        loadDayState(day);

        document.querySelectorAll('.day-btn').forEach((btn, i) => {
            btn.classList.toggle('active', DAYS[i] === day);
        });
        renderSiegeDeck();
        renderPipeline();
    }

    // --- ì„œë²„ì—ì„œ ê³µì„±ì „ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ---
    function loadSiegeFromServer(nick) {
        if(!globalData.siege) return;
        globalData.siege.filter(s => s.nickname === nick).forEach(s => {
            if(!siegeData[s.day]) return;
            const sd = siegeData[s.day];
            sd.formation = s.formation || "ê¸°ë³¸";
            sd.memo = s.memo || "";
            sd.pet = s.pet || "";

            if(s.deck) {
                sd.deck = Array(5).fill().map(emptyHero);
                s.deck.split(',').map(p=>p.trim()).forEach((p, i) => {
                    if(i>=5) return;
                    sd.deck[i] = parseHeroToken(p);
                });
            }

            sd.pipeline = [];
            if(s.pipeline) {
                s.pipeline.split('â†’').map(x=>x.trim()).filter(x=>x).forEach(token => {
                    const m = token.match(/^(.+)\(S(\d)\)$/);
                    if(m) sd.pipeline.push({hero: m[1], skill: parseInt(m[2])});
                });
            }
        });

        loadDayState(currentSiegeDay);
        renderSiegeDeck();
        renderPipeline();
    }

    // --- ê³µì„±ì „ ì €ì¥ ---
    async function saveSiege(ev) {
        saveCurrentDayState();
        const sd = siegeData[currentSiegeDay];
        const nick = document.getElementById('myNick').value;

        const deckStr = sd.deck.filter(x=>x.name).map(x => serializeHero(x)).join(", ");

        const pipeStr = sd.pipeline.map(p => `${p.hero}(S${p.skill})`).join(" \u2192 ");

        if(!deckStr) return alert("ì˜ì›…ì„ ë°°ì¹˜í•´ì£¼ì„¸ìš”");

        const btn = ev.target; const orig = btn.innerText;
        btn.disabled=true; btn.innerText="ì²˜ë¦¬ ì¤‘...";
        try {
            await sbFetch("POST", "siege", {
                nickname:  nick,
                day:       currentSiegeDay,
                deck:      deckStr,
                pet:       sd.pet,
                formation: sd.formation,
                memo:      sd.memo,
                pipeline:  pipeStr
            }, "?on_conflict=nickname,day", {"Prefer":"resolution=merge-duplicates,return=minimal"});

            alert(`${DAY_LABELS[currentSiegeDay]}ìš”ì¼ ê³µì„±ì „ ì €ì¥ ì™„ë£Œ!`);
            refreshSession();
        } catch(e) { alert("ì €ì¥ ì˜¤ë¥˜"); }
        btn.disabled=false; btn.innerText=orig;
    }

    // --- ê³µì„±ì „ ë± ë Œë”ë§ ---
    function renderSiegeDeck() {
        const container = document.getElementById('siegeDeckContainer');
        let h = "";
        siegeDeckState.forEach((o, i) => {
            const img = o.name ?
                `<img src="${heroImg(o.name)}" onerror="this.style.display='none'; this.parentNode.innerText='${o.name[0]}'">`
                : "+";
            const accContent = o.acc
                ? `<img src="${accImg(o.acc)}" style="width:22px;height:22px;object-fit:contain;" onerror="this.style.display='none'"><span style="font-size:7px;line-height:1;">${getAccAbbr(o.acc)}</span>`
                : 'Acc';

            h += `<div class="hero-card">
                    <div class="hero-slot" onclick="openSelector('siege','HERO',${i})">${img}</div>
                    <div class="equipment-grid">
                        <div class="gear-slot slot-w1" onclick="openGear('siege',${i},'w1')">${formatGearSlot(o.w1)||"W1"}</div>
                        <div class="gear-slot slot-a1" onclick="openGear('siege',${i},'a1')">${formatGearSlot(o.a1)||"A1"}</div>
                        <div class="acc-slot" onclick="openAcc('siege',${i})" style="flex-direction:column;">${accContent}</div>
                        <div class="gear-slot slot-w2" onclick="openGear('siege',${i},'w2')">${formatGearSlot(o.w2)||"W2"}</div>
                        <div class="gear-slot slot-a2" onclick="openGear('siege',${i},'a2')">${formatGearSlot(o.a2)||"A2"}</div>
                    </div>
                    <div class="skill-btns">
                        <button class="skill-btn s1" onclick="addSkill(${i},1)" ${o.name?'':'disabled'}>ìŠ¤í‚¬1</button>
                        <button class="skill-btn s2" onclick="addSkill(${i},2)" ${o.name?'':'disabled'}>ìŠ¤í‚¬2</button>
                    </div>
                    ${o.name ? renderStatsBtn('siege', i, o.stats) : ''}
                  </div>`;
        });

        const pImg = siegePetState ?
            `<img src="${petImg(siegePetState)}" onerror="this.style.display='none'; this.parentNode.innerText='${siegePetState}'">`
            : "<span style='font-size:10px;color:#888'>PET</span>";

        h += `<div class="pet-wrapper"><div class="pet-slot" onclick="openSelector('siege','PET')">${pImg}</div></div>`;
        container.innerHTML = h;
    }

    // --- ìŠ¤í‚¬ íŒŒì´í”„ë¼ì¸ ---
    function addSkill(heroIdx, skillNum) {
        const name = siegeDeckState[heroIdx].name;
        if(!name) return;
        skillPipeline.push({hero: name, skill: skillNum});
        renderPipeline();
    }

    function undoPipeline() { skillPipeline.pop(); renderPipeline(); }
    function clearPipeline() { skillPipeline = []; renderPipeline(); }

    function renderPipeline() {
        const display = document.getElementById('pipelineDisplay');
        const textEl = document.getElementById('pipelineText');

        if(skillPipeline.length === 0) {
            display.innerHTML = "<span style='color:#5f6d82;'>ìŠ¤í‚¬ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìˆœì„œë¥¼ ì§€ì •í•˜ì„¸ìš”</span>";
            textEl.innerText = "";
            return;
        }

        let h = "";
        skillPipeline.forEach((item, i) => {
            if(i > 0) h += `<span class="pipeline-arrow">\u2192</span>`;
            h += `<div class="pipeline-item s${item.skill}">
                    <div class="pi-icon"><img src="${heroImg(item.hero)}" onerror="this.style.display='none';"></div>
                    ${item.hero}(S${item.skill})
                  </div>`;
        });
        display.innerHTML = h;

        textEl.innerText = skillPipeline.map(item => `${item.hero}(S${item.skill})`).join(" \u2192 ");
    }


    // ============================================================
    //  ê°•ë¦¼ ì›ì •ëŒ€
    // ============================================================

    function renderAdventBossNav() {
        const nav = document.getElementById('adventBossNav');
        if(!nav) return;
        let h = "";

        [...ADVENT_BOSSES, ADVENT_FINAL_BOSS].forEach(boss => {
            const isActive = currentAdventBoss === boss;
            const isFinal = boss === ADVENT_FINAL_BOSS;
            const imgStyle = isFinal ? ' style="background:#5a2030; border-color:#d47474;"' : '';
            const btnClass = `advent-boss-btn${isActive?' active':''}${isFinal?' final-boss':''}`;
            h += `<button class="${btnClass}" onclick="switchAdventBoss('${boss}')">
                    <div class="advent-boss-img"${imgStyle}><img src="${heroImg(boss)}" onerror="this.style.display='none'; this.parentNode.innerText='${boss[0]}'"></div>
                    <span>${boss}</span>
                  </button>`;
        });

        nav.innerHTML = h;
    }

    function switchAdventBoss(boss) {
        saveCurrentAdventBossState();
        currentAdventBoss = boss;
        loadAdventBossState(boss);
        renderAdventBossNav();
    }

    function saveCurrentAdventBossState() {
        if(!currentAdventBoss) return;
        const bd = adventData[currentAdventBoss];
        bd.team1.formation = document.getElementById('adventFormation_1').value;
        bd.team1.memo = document.getElementById('adventKeyItems_1').value;
        bd.team2.formation = document.getElementById('adventFormation_2').value;
        bd.team2.memo = document.getElementById('adventKeyItems_2').value;
    }

    function loadAdventBossState(boss) {
        const bd = adventData[boss];
        document.getElementById('adventBossTitle').innerText = `ë³´ìŠ¤: ${boss}`;
        document.getElementById('adventFormation_1').value = bd.team1.formation || "ê¸°ë³¸";
        document.getElementById('adventKeyItems_1').value = bd.team1.memo || "";
        document.getElementById('adventFormation_2').value = bd.team2.formation || "ê¸°ë³¸";
        document.getElementById('adventKeyItems_2').value = bd.team2.memo || "";
        renderAdventDeck(1);
        renderAdventDeck(2);
        renderAdventPipeline(1);
        renderAdventPipeline(2);
    }

    function renderAdventDeck(teamNum) {
        const container = document.getElementById(`adventDeckContainer_${teamNum}`);
        if(!container) return;
        const mode = `advent${teamNum}`;
        const teamKey = `team${teamNum}`;
        const state = adventData[currentAdventBoss][teamKey].deck;
        const petState = adventData[currentAdventBoss][teamKey].pet;

        let h = "";
        state.forEach((o, i) => {
            const img = o.name ?
                `<img src="${heroImg(o.name)}" onerror="this.style.display='none'; this.parentNode.innerText='${o.name[0]}'">` : "+";
            const accContent = o.acc
                ? `<img src="${accImg(o.acc)}" style="width:22px;height:22px;object-fit:contain;" onerror="this.style.display='none'"><span style="font-size:7px;line-height:1;">${getAccAbbr(o.acc)}</span>`
                : 'Acc';
            h += `<div class="hero-card">
                    <div class="hero-slot" onclick="openSelector('${mode}','HERO',${i})">${img}</div>
                    <div class="equipment-grid">
                        <div class="gear-slot slot-w1" onclick="openGear('${mode}',${i},'w1')">${formatGearSlot(o.w1)||"W1"}</div>
                        <div class="gear-slot slot-a1" onclick="openGear('${mode}',${i},'a1')">${formatGearSlot(o.a1)||"A1"}</div>
                        <div class="acc-slot" onclick="openAcc('${mode}',${i})" style="flex-direction:column;">${accContent}</div>
                        <div class="gear-slot slot-w2" onclick="openGear('${mode}',${i},'w2')">${formatGearSlot(o.w2)||"W2"}</div>
                        <div class="gear-slot slot-a2" onclick="openGear('${mode}',${i},'a2')">${formatGearSlot(o.a2)||"A2"}</div>
                    </div>
                    <div class="skill-btns">
                        <button class="skill-btn s1" onclick="addAdventSkill(${teamNum},${i},1)" ${o.name?'':'disabled'}>ìŠ¤í‚¬1</button>
                        <button class="skill-btn s2" onclick="addAdventSkill(${teamNum},${i},2)" ${o.name?'':'disabled'}>ìŠ¤í‚¬2</button>
                    </div>
                    ${o.name ? renderStatsBtn(mode, i, o.stats) : ''}
                  </div>`;
        });

        const pImg = petState ?
            `<img src="${petImg(petState)}" onerror="this.style.display='none'; this.parentNode.innerText='${petState}'">` :
            "<span style='font-size:10px;color:#888'>PET</span>";
        h += `<div class="pet-wrapper"><div class="pet-slot" onclick="openSelector('${mode}','PET')">${pImg}</div></div>`;
        container.innerHTML = h;
    }

    function renderAdventPipeline(teamNum) {
        const pipeline = adventData[currentAdventBoss][`team${teamNum}`].pipeline;
        const display = document.getElementById(`adventPipelineDisplay_${teamNum}`);
        const textEl = document.getElementById(`adventPipelineText_${teamNum}`);
        if(!display) return;

        if(pipeline.length === 0) {
            display.innerHTML = "<span style='color:#5f6d82;'>ìŠ¤í‚¬ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìˆœì„œë¥¼ ì§€ì •í•˜ì„¸ìš”</span>";
            textEl.innerText = "";
            return;
        }

        let h = "";
        pipeline.forEach((item, i) => {
            if(i > 0) h += `<span class="pipeline-arrow">\u2192</span>`;
            h += `<div class="pipeline-item s${item.skill}">
                    <div class="pi-icon"><img src="${heroImg(item.hero)}" onerror="this.style.display='none';"></div>
                    ${item.hero}(S${item.skill})
                  </div>`;
        });
        display.innerHTML = h;
        textEl.innerText = pipeline.map(p => `${p.hero}(S${p.skill})`).join(" \u2192 ");
    }

    function addAdventSkill(teamNum, heroIdx, skillNum) {
        const name = adventData[currentAdventBoss][`team${teamNum}`].deck[heroIdx].name;
        if(!name) return;
        adventData[currentAdventBoss][`team${teamNum}`].pipeline.push({hero: name, skill: skillNum});
        renderAdventPipeline(teamNum);
    }

    function undoAdventPipeline(teamNum) { adventData[currentAdventBoss][`team${teamNum}`].pipeline.pop(); renderAdventPipeline(teamNum); }
    function clearAdventPipeline(teamNum) { adventData[currentAdventBoss][`team${teamNum}`].pipeline = []; renderAdventPipeline(teamNum); }

    async function saveAdvent(ev) {
        saveCurrentAdventBossState();
        const bd = adventData[currentAdventBoss];
        const nick = document.getElementById('myNick').value;

        const deckStr = (team) => team.deck.filter(x=>x.name).map(x => serializeHero(x)).join(", ");
        const pipeStr = (team) => team.pipeline.map(p => `${p.hero}(S${p.skill})`).join(" \u2192 ");

        if(!deckStr(bd.team1) && !deckStr(bd.team2)) return alert("ìµœì†Œ 1íŒ€ ì´ìƒ ì˜ì›…ì„ ë°°ì¹˜í•´ì£¼ì„¸ìš”");

        const btn = ev.target; const orig = btn.innerText;
        btn.disabled=true; btn.innerText="ì²˜ë¦¬ ì¤‘...";
        try {
            await sbFetch("POST", "advent", {
                nickname:        nick,
                boss:            currentAdventBoss,
                team1_deck:      deckStr(bd.team1),
                team1_pet:       bd.team1.pet,
                team1_formation: bd.team1.formation,
                team1_memo:      bd.team1.memo,
                team1_pipeline:  pipeStr(bd.team1),
                team2_deck:      deckStr(bd.team2),
                team2_pet:       bd.team2.pet,
                team2_formation: bd.team2.formation,
                team2_memo:      bd.team2.memo,
                team2_pipeline:  pipeStr(bd.team2),
                cleared:         "false"
            }, "?on_conflict=nickname,boss", {"Prefer":"resolution=merge-duplicates,return=minimal"});

            alert(`${currentAdventBoss} ì €ì¥ ì™„ë£Œ!`);
            renderAdventBossNav();
            refreshSession();
        } catch(e) { alert("ì €ì¥ ì˜¤ë¥˜"); }
        btn.disabled=false; btn.innerText=orig;
    }

    function loadAdventFromServer(nick) {
        if(!globalData.advent) return;

        const parseDeck = (deckStr) => {
            const deck = Array(5).fill().map(emptyHero);
            if(!deckStr) return deck;
            deckStr.split(',').map(p=>p.trim()).forEach((p, i) => {
                if(i>=5) return;
                deck[i] = parseHeroToken(p);
            });
            return deck;
        };

        const parsePipe = (pipeStr) => {
            const pipe = [];
            if(!pipeStr) return pipe;
            pipeStr.split('\u2192').map(x=>x.trim()).filter(x=>x).forEach(token => {
                const m = token.match(/^(.+)\(S(\d)\)$/);
                if(m) pipe.push({hero: m[1], skill: parseInt(m[2])});
            });
            return pipe;
        };

        globalData.advent.filter(s => s.nickname === nick).forEach(s => {
            const boss = s.boss;
            if(!adventData[boss]) return;
            const bd = adventData[boss];
            bd.team1 = { deck: parseDeck(s.team1Deck), pet: s.team1Pet||"", formation: s.team1Formation||"ê¸°ë³¸", memo: s.team1Memo||"", pipeline: parsePipe(s.team1Pipeline) };
            bd.team2 = { deck: parseDeck(s.team2Deck), pet: s.team2Pet||"", formation: s.team2Formation||"ê¸°ë³¸", memo: s.team2Memo||"", pipeline: parsePipe(s.team2Pipeline) };
        });

        loadAdventBossState(currentAdventBoss);
        renderAdventBossNav();
    }

</script>
</body>
</html>
