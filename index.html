<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸¸ë“œì „ ì‘ì „ìƒí™©ì‹¤ v5</title>
    <script src="gamedata.js"></script>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; text-align: center; padding-bottom: 100px;}
        .container { max-width: 450px; margin: 0 auto; padding: 15px; }
        .box { background: #1e1e1e; border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 20px; position: relative; }
        .neon-green { border-left: 4px solid #00ff00; }
        .neon-purple { border-left: 4px solid #d500f9; }
        .neon-red { border-left: 4px solid #ff4444; }

        input, select, textarea { width: 95%; padding: 10px; margin: 5px 0; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 5px; }
        button { width: 100%; padding: 12px; margin-top: 5px; background: #333; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }

        /* ë± í”„ë¦¬ë·° ì˜ì—­ (ì˜ì›… 5 + í« 1) */
        .deck-container {
            display: flex; gap: 8px; justify-content: center; align-items: center;
            background: #252525; padding: 10px; border-radius: 8px; margin: 10px 0;
        }
        .hero-group { display: flex; gap: 4px; }
        .pet-slot {
            width: 40px; height: 40px; border-radius: 8px; background: #333; border: 2px dashed #666;
            display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden;
        }
        .pet-slot img { width: 100%; height: 100%; object-fit: cover; }
        .pet-label { font-size: 8px; position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); text-align: center; }

        .hero-slot {
            width: 45px; height: 45px; border-radius: 50%; background: #444; border: 2px solid #555;
            display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer;
        }
        .hero-slot img { width: 100%; height: 100%; object-fit: cover; object-position: top 15%; }

        /* ì¥ë¹„/ì§„í˜• ì •ë³´ ë°•ìŠ¤ */
        .info-row { display: flex; gap: 5px; justify-content: space-between; margin-bottom: 5px; }
        .info-row select { width: 48%; }
        .info-row input { width: 48%; }

        /* ê³µëµ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .strategy-card {
            background: #2a2a2a; border: 1px solid #444; border-radius: 8px;
            padding: 10px; margin-bottom: 10px; cursor: pointer; text-align: left;
        }
        .strategy-card:hover { border-color: gold; background: #333; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background-color: #1e1e1e; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; height: 70vh; display: flex; flex-direction: column; }
        .hero-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; overflow-y: auto; flex-grow: 1; padding: 5px;}
        .hero-item { text-align: center; cursor: pointer; }
        .hero-circle { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #555; overflow: hidden; margin: 0 auto;}
        .hero-circle.selected { border-color: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .hero-circle img { width: 100%; height: 100%; object-fit: cover; object-position: top 15%; }
        .hero-name { font-size: 10px; color: #ccc; margin-top: 3px; }
    </style>
</head>
<body>

<div class="container">
    <h2>âš”ï¸ ê¸¸ë“œì „ ì‘ì „ìƒí™©ì‹¤</h2>

    <div id="loginArea" class="box" style="border-left: 4px solid #00ffff;">
        <h3>ğŸ” ë¡œê·¸ì¸</h3>
        <input type="text" id="myNick" placeholder="ë‹‰ë„¤ì„">
        <button onclick="login()">ì ‘ì†í•˜ê¸°</button>
    </div>

    <div id="mainArea" class="hidden">

        <div class="box neon-green">
            <h3>1. íƒ€ê²Ÿ ë° ê³µëµ í™•ì¸</h3>
            <select id="enemySelect" onchange="selectEnemy()">
                <option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
            </select>
            <div id="enemyDeckVisual" class="deck-container">
                <span style="color:#666; font-size:0.8em;">ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
            </div>
            <input type="hidden" id="currentEnemyDeck">

            <div id="strategyBox" style="margin-top:10px;"></div>
        </div>

        <div class="box neon-purple">
            <h3>2. ë‚´ ê³µê²©íŒ€ êµ¬ì„±</h3>

            <div class="info-row">
                <select id="myFormation">
                    <option value="ê¸°ë³¸">ê¸°ë³¸ ì§„í˜•</option>
                    <option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤ ì§„í˜•</option>
                    <option value="ê³µê²©">ê³µê²© ì§„í˜•</option>
                    <option value="ë³´í˜¸">ë³´í˜¸ ì§„í˜•</option>
                </select>
                <input type="text" id="myKeyItems" placeholder="í•µì‹¬ ì¥ë¹„/ì¥ì‹ êµ¬ (ì˜ˆ: ë¦°-ê¶ŒëŠ¥)">
            </div>

            <div class="deck-container">
                <div class="hero-group" onclick="openSelector('myBattle', 'HERO')">
                    <div id="preview_myBattle_1" class="hero-slot">+</div>
                    <div id="preview_myBattle_2" class="hero-slot">+</div>
                    <div id="preview_myBattle_3" class="hero-slot">+</div>
                    <div id="preview_myBattle_4" class="hero-slot">+</div>
                    <div id="preview_myBattle_5" class="hero-slot">+</div>
                </div>

                <div style="width:1px; height:40px; background:#444; margin:0 5px;"></div>

                <div id="preview_myBattle_pet" class="pet-slot" onclick="openSelector('myBattle', 'PET')">
                    <span style="font-size:10px; color:#888;">PET</span>
                </div>
            </div>

            <input type="hidden" id="myBattleDeckResult">
            <input type="hidden" id="myBattlePetResult">
        </div>

        <div class="box neon-red">
            <h3>3. ê²°ê³¼ ê¸°ë¡</h3>
            <button onclick="record('WIN')" style="background:#2e7d32;">â­â­â­ ìŠ¹ë¦¬</button>
            <button onclick="record('LOSE')" style="background:#c62828;">âŒ íŒ¨ë°°</button>
        </div>

        <button onclick="toggleAdmin()" style="background:#444;">ğŸ› ï¸ ê³µëµ ë“±ë¡ (ê´€ë¦¬ì)</button>

        <div id="adminArea" class="hidden" style="margin-top:20px;">
            <div class="box">
                <h3>ğŸ“œ ì‹ ê·œ ê³µëµ ë“±ë¡</h3>
                <select id="targetEnemySelect"></select>

                <div class="info-row">
                    <select id="newFormation">
                        <option value="ê¸°ë³¸">ê¸°ë³¸ ì§„í˜•</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option>
                    </select>
                    <input type="text" id="newKeyItems" placeholder="ì¥ë¹„/ì¥ì‹ êµ¬ íŒ">
                </div>

                <div class="deck-container">
                    <div class="hero-group" onclick="openSelector('attack', 'HERO')">
                        <div id="preview_attack_1" class="hero-slot">+</div><div id="preview_attack_2" class="hero-slot">+</div><div id="preview_attack_3" class="hero-slot">+</div><div id="preview_attack_4" class="hero-slot">+</div><div id="preview_attack_5" class="hero-slot">+</div>
                    </div>
                    <div style="width:1px; height:40px; background:#444; margin:0 5px;"></div>
                    <div id="preview_attack_pet" class="pet-slot" onclick="openSelector('attack', 'PET')">PET</div>
                </div>

                <input type="hidden" id="newAttackDeckResult">
                <input type="hidden" id="newAttackPetResult">
                <textarea id="newStrategyNote" placeholder="ìƒì„¸ ê³µëµ ì‘ì„±"></textarea>
                <button onclick="addStrategy()">ê³µëµ ë“±ë¡</button>
            </div>

            <div class="box">
                <h3>ğŸ‘¾ ì êµ° ì¶”ê°€</h3>
                <input type="text" id="newEnemyName" placeholder="ì  ë‹‰ë„¤ì„">
                <div class="deck-container" onclick="openSelector('enemy', 'HERO')">
                    <div id="preview_enemy_1" class="hero-slot">+</div><div id="preview_enemy_2" class="hero-slot">+</div><div id="preview_enemy_3" class="hero-slot">+</div><div id="preview_enemy_4" class="hero-slot">+</div><div id="preview_enemy_5" class="hero-slot">+</div>
                </div>
                <input type="hidden" id="newEnemyDeckResult">
                <button onclick="addNewEnemy()">ì êµ° ë“±ë¡</button>
            </div>
        </div>
    </div>
</div>

<div id="selectorModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">ì„ íƒ</h3>
        <input type="text" id="searchBox" onkeyup="filterItems()" placeholder="ê²€ìƒ‰...">
        <div id="itemGrid" class="hero-grid"></div>
        <button onclick="confirmSelection()" style="background:#2e7d32; margin-top:10px;">ì™„ë£Œ</button>
        <button onclick="closeModal()" style="background:#c62828;">ì·¨ì†Œ</button>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxcfZ8GN_hHkBMefYdeQg5MG-SPQ8cLg2lW_A8F-9azQj5lOkVQp57m6WFa97IHDvHn/exec"; // ë³¸ì¸ URL

    // ë°ì´í„° ë¡œë“œ í™•ì¸ ë° ê¸°ë³¸ í« ë°ì´í„° (í¬ë¡¤ë§ ì•ˆëì„ ê²½ìš° ëŒ€ë¹„)
    const DATA_HEROES = (typeof HEROES !== 'undefined') ? HEROES : ["ì—ë°˜", "ë£¨ë””", "ì¹´ë¦°"];
    const DATA_PETS = (typeof PETS !== 'undefined' && PETS.length > 0) ? PETS : ["ìœ ", "ë¸ë¡œ", "ë¦¬ì²¼", "í¬ë¦¬", "ì œë¸Œ", "íŒŒì´í¬", "ë¦°", "ì´ë¦°"];

    let globalData = { enemies: [], strategies: [] };

    // ì„ íƒ ìƒíƒœ ë³€ìˆ˜
    let currentMode = ""; // 'myBattle', 'attack', 'enemy'
    let currentType = ""; // 'HERO', 'PET'
    let tempSelected = []; // ì˜ì›…ì€ ë°°ì—´
    let tempSelectedPet = ""; // í«ì€ ë‹¨ì¼ ê°’

    // --- ì´ˆê¸°í™” ---
    window.onload = function() {
        if(localStorage.getItem("nick")) {
            document.getElementById('myNick').value = localStorage.getItem("nick");
            login();
        }
    };

    function login() {
        const nick = document.getElementById('myNick').value;
        if(!nick) return alert("ë‹‰ë„¤ì„ ì…ë ¥");
        localStorage.setItem("nick", nick);
        document.getElementById('loginArea').classList.add('hidden');
        document.getElementById('mainArea').classList.remove('hidden');
        loadData();
    }

    function loadData() {
        fetch(GAS_URL).then(r=>r.json()).then(d => {
            globalData = d;
            renderDropdowns();
        });
    }

    function renderDropdowns() {
        const sel = document.getElementById('enemySelect');
        const admSel = document.getElementById('targetEnemySelect');
        const cur = sel.value;
        sel.innerHTML = '<option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
        admSel.innerHTML = '<option value="">-- ëŒ€ìƒ ì„ íƒ --</option>';
        globalData.enemies.forEach(e => {
            sel.add(new Option(e.name, e.name));
            admSel.add(new Option(e.name, e.name));
        });
        if(cur) sel.value = cur;
    }

    // --- 1. íƒ€ê²Ÿ ì„ íƒ ë° ê³µëµ ë¡œë“œ ---
    function selectEnemy() {
        const name = document.getElementById('enemySelect').value;
        const enemy = globalData.enemies.find(e => e.name === name);
        const deckBox = document.getElementById('enemyDeckVisual');

        if(!enemy) {
            deckBox.innerHTML = "<span>ì •ë³´ ì—†ìŒ</span>";
            return;
        }

        document.getElementById('currentEnemyDeck').value = enemy.deck;

        // ì  ë± ë Œë”ë§ (ì˜ì›…ë§Œ)
        let html = "<div class='hero-group'>";
        enemy.deck.split(',').forEach(h => {
            html += `<div class="hero-slot" style="border-color:#ff4444;"><img src="images/${h}.png" onerror="this.parentNode.innerText='${h[0]}'"></div>`;
        });
        html += "</div>";
        deckBox.innerHTML = html;

        // ê³µëµ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        const stratBox = document.getElementById('strategyBox');
        const strats = globalData.strategies.filter(s => s.target === name);

        if(strats.length > 0) {
            let sHtml = "";
            strats.forEach((s, i) => {
                // í« ì´ë¯¸ì§€ ì²˜ë¦¬
                const petImg = s.pet ? `<img src="images/${s.pet}.png" style="width:20px; vertical-align:middle; border-radius:50%;">` : "";

                sHtml += `<div class="strategy-card" onclick='applyStrategy(${JSON.stringify(s)})'>
                            <div style="display:flex; justify-content:space-between;">
                                <h4 style="margin:0; color:gold;">ì¶”ì²œ #${i+1} (${s.formation})</h4>
                                <span style="font-size:0.8em; color:#aaa;">${petImg} ${s.pet||"í«X"}</span>
                            </div>
                            <div style="margin:5px 0;">${renderIcons(s.attack)}</div>
                            <div style="font-size:0.8em; color:#88ff88;">ğŸ› ï¸ ${s.items || "ì¥ë¹„ ì •ë³´ ì—†ìŒ"}</div>
                            <div style="font-size:0.8em; color:#ccc;">Tip: ${s.note}</div>
                          </div>`;
            });
            stratBox.innerHTML = sHtml;
        } else {
            stratBox.innerHTML = "<p style='color:#666;'>ê³µëµì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        }
    }

    function renderIcons(listStr) {
        if (!listStr) return "";
        let h = "";
        listStr.split(',').forEach(item => {
            h += `<img src="images/${item}.png" style="width:30px; height:30px; border-radius:50%; margin-right:2px;" onerror="this.style.display='none'">`;
        });
        return h;
    }

    // --- 2. ê³µëµ ì ìš© (í´ë¦­ ì‹œ ë‚´ ì…‹íŒ…ìœ¼ë¡œ ë³µì‚¬) ---
    function applyStrategy(s) {
        // ì˜ì›… ë³µì‚¬
        document.getElementById('myBattleDeckResult').value = s.attack;
        updatePreview('myBattle', s.attack.split(','), 'HERO');

        // í« ë³µì‚¬
        document.getElementById('myBattlePetResult').value = s.pet || "";
        updatePreview('myBattle', s.pet, 'PET');

        // ì§„í˜• & ì¥ë¹„ ë³µì‚¬
        document.getElementById('myFormation').value = s.formation || "ê¸°ë³¸";
        document.getElementById('myKeyItems').value = s.items || "";

        document.querySelector('.neon-purple').scrollIntoView({behavior:'smooth'});
    }

    // --- 3. ëª¨ë‹¬ ì—´ê¸° (ì˜ì›…/í« êµ¬ë¶„) ---
    function openSelector(mode, type) {
        currentMode = mode;
        currentType = type;

        document.getElementById('modalTitle').innerText = type === 'HERO' ? "ì˜ì›… ì„ íƒ (ìµœëŒ€ 5)" : "í« ì„ íƒ (1ë§ˆë¦¬)";
        document.getElementById('searchBox').value = "";

        // ì„ì‹œ ì €ì¥ì†Œ ì´ˆê¸°í™”
        if (type === 'HERO') tempSelected = [];
        else tempSelectedPet = "";

        renderGrid();
        document.getElementById('selectorModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('selectorModal').style.display = 'none'; }

    function renderGrid(filterText = "") {
        const grid = document.getElementById('itemGrid');
        grid.innerHTML = "";

        const sourceData = currentType === 'HERO' ? DATA_HEROES : DATA_PETS;
        const list = sourceData.filter(item => item.includes(filterText));

        list.forEach(item => {
            const div = document.createElement('div');
            div.className = 'hero-item';
            div.onclick = () => selectItem(item, div);

            // ì„ íƒ ì—¬ë¶€ ì²´í¬
            let isSel = false;
            if(currentType === 'HERO') isSel = tempSelected.includes(item);
            else isSel = (tempSelectedPet === item);

            div.innerHTML = `
                <div class="hero-circle ${isSel?'selected':''}">
                    <img src="images/${item}.png" onerror="this.parentNode.innerText='${item.substr(0,2)}'">
                </div>
                <div class="hero-name">${item}</div>
            `;
            grid.appendChild(div);
        });
    }

    function selectItem(name, div) {
        const circle = div.querySelector('.hero-circle');

        if (currentType === 'HERO') {
            if (tempSelected.includes(name)) {
                tempSelected = tempSelected.filter(n => n !== name);
                circle.classList.remove('selected');
            } else {
                if (tempSelected.length >= 5) return alert("5ëª…ê¹Œì§€ì…ë‹ˆë‹¤.");
                tempSelected.push(name);
                circle.classList.add('selected');
            }
        } else {
            // í«ì€ í•˜ë‚˜ë§Œ ì„ íƒ (ê¸°ì¡´ ì„ íƒ í•´ì œ íš¨ê³¼)
            document.querySelectorAll('.hero-circle.selected').forEach(el => el.classList.remove('selected'));
            tempSelectedPet = name;
            circle.classList.add('selected');
        }
    }

    function filterItems() {
        renderGrid(document.getElementById('searchBox').value);
    }

    function confirmSelection() {
        if (currentType === 'HERO') {
            const val = tempSelected.join(',');
            const inputId = currentMode === 'myBattle' ? 'myBattleDeckResult' :
                (currentMode === 'attack' ? 'newAttackDeckResult' : 'newEnemyDeckResult');
            document.getElementById(inputId).value = val;
            updatePreview(currentMode, tempSelected, 'HERO');
        } else {
            const val = tempSelectedPet;
            const inputId = currentMode === 'myBattle' ? 'myBattlePetResult' : 'newAttackPetResult';
            document.getElementById(inputId).value = val;
            updatePreview(currentMode, val, 'PET');
        }
        closeModal();
    }

    function updatePreview(mode, data, type) {
        if (type === 'HERO') {
            // data is array
            for(let i=1; i<=5; i++) {
                document.getElementById(`preview_${mode}_${i}`).innerHTML = "+";
            }
            data.forEach((h, i) => {
                if(i<5) document.getElementById(`preview_${mode}_${i+1}`).innerHTML = `<img src="images/${h}.png" style="width:100%; height:100%; object-fit:cover; object-position:top 15%;">`;
            });
        } else {
            // data is string (pet name)
            const el = document.getElementById(`preview_${mode}_pet`);
            if(data) el.innerHTML = `<img src="images/${data}.png" style="width:100%; height:100%; object-fit:cover;">`;
            else el.innerHTML = "<span style='font-size:10px; color:#888;'>PET</span>";
        }
    }

    // --- 4. ë°ì´í„° ì „ì†¡ (ë“±ë¡/ê¸°ë¡) ---
    function addStrategy() {
        const target = document.getElementById('targetEnemySelect').value;
        const deck = document.getElementById('newAttackDeckResult').value;
        const pet = document.getElementById('newAttackPetResult').value;
        const form = document.getElementById('newFormation').value;
        const items = document.getElementById('newKeyItems').value;
        const note = document.getElementById('newStrategyNote').value;

        if(!target || !deck) return alert("ëŒ€ìƒê³¼ ê³µê²©ë± í•„ìˆ˜");

        fetch(GAS_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type":"application/json"},
            body: JSON.stringify({
                action: "add_strategy",
                targetEnemy: target, attackDeck: deck, pet: pet, formation: form, keyItems: items, note: note, author: document.getElementById('myNick').value
            })
        }).then(() => {
            alert("ê³µëµ ë“±ë¡ ì™„ë£Œ");
            location.reload(); // ê°„í¸í•˜ê²Œ ë¦¬ë¡œë“œ ì²˜ë¦¬ (ë°ì´í„° ê°±ì‹  ìœ„í•´)
        });
    }

    function record(result) {
        const target = document.getElementById('enemySelect').value;
        const myDeck = document.getElementById('myBattleDeckResult').value;
        const myPet = document.getElementById('myBattlePetResult').value;
        const myForm = document.getElementById('myFormation').value;

        if(!target || !myDeck) return alert("íƒ€ê²Ÿê³¼ ë± ì„¤ì • í•„ìˆ˜");

        fetch(GAS_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type":"application/json"},
            body: JSON.stringify({
                action: "record",
                nickname: document.getElementById('myNick').value,
                enemyName: target,
                enemyDeck: document.getElementById('currentEnemyDeck').value,
                myDeck: myDeck,
                pet: myPet,
                formation: myForm,
                result: result
            })
        }).then(() => alert("ê¸°ë¡ ì™„ë£Œ!"));
    }

    function toggleAdmin() { document.getElementById('adminArea').classList.toggle('hidden'); }
    function addNewEnemy() { /* (ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼) */ }
</script>

</body>
</html>