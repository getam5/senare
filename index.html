<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸¸ë“œì „ ì‘ì „ìƒí™©ì‹¤ vFinal</title>
    <script src="gamedata.js"></script>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ë‹¤í¬ ëª¨ë“œ & ë„¤ì˜¨) --- */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; text-align: center; padding-bottom: 100px; margin: 0; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        .box {
            background: #1e1e1e; border: 1px solid #333; border-radius: 12px;
            padding: 15px; margin-bottom: 20px; position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .neon-blue { border-left: 4px solid #00ffff; }
        .neon-green { border-left: 4px solid #00ff00; }
        .neon-purple { border-left: 4px solid #d500f9; }
        .neon-red { border-left: 4px solid #ff4444; }

        h3 { margin-top: 0; color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.2); }

        input, select, textarea {
            width: 95%; padding: 12px; margin: 5px 0;
            background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 6px;
            font-size: 14px;
        }
        button {
            width: 100%; padding: 12px; margin-top: 5px;
            background: #333; color: white; border: 1px solid #444; border-radius: 6px;
            font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        button:hover { background: #444; border-color: #888; }
        .hidden { display: none; }

        /* --- ë± ì»¨í…Œì´ë„ˆ --- */
        .deck-container {
            display: flex; gap: 8px; justify-content: flex-start; align-items: flex-start;
            background: #252525; padding: 10px; border-radius: 8px; margin: 10px 0;
            overflow-x: auto; min-height: 120px;
        }

        /* ì˜ì›… ì¹´ë“œ (ì˜ì›… + ì¥ë¹„/ì¥ì‹ êµ¬ ê·¸ë¦¬ë“œ) */
        .hero-card {
            display: flex; flex-direction: column; align-items: center;
            width: 110px; flex-shrink: 0;
            background: #202020; border-radius: 8px; padding: 5px; border: 1px solid #333;
        }

        .hero-slot {
            width: 50px; height: 50px; border-radius: 50%; background: #444; border: 2px solid #555;
            display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer;
            margin-bottom: 5px;
        }
        .hero-slot img { width: 100%; height: 100%; object-fit: cover; object-position: top 15%; }

        /* ì¥ë¹„+ì¥ì‹ êµ¬ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ (Grid) */
        .equipment-grid {
            display: grid; width: 100%;
            grid-template-columns: 1fr 1fr 1fr; /* W, A, Acc */
            grid-template-rows: 1fr 1fr; /* 1, 2 */
            gap: 3px;
            grid-template-areas: "w1 a1 acc" "w2 a2 acc";
        }

        .gear-slot, .acc-slot {
            background: #333; border: 1px solid #444; border-radius: 3px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #ccc; cursor: pointer;
            text-align: center; line-height: 1.1; padding: 2px; word-break: keep-all;
        }
        .gear-slot:hover, .acc-slot:hover { border-color: gold; color: gold; }

        .slot-w1 { grid-area: w1; border-color: #552222; color: #ffcccc; height: 25px; }
        .slot-a1 { grid-area: a1; border-color: #222255; color: #ccccff; height: 25px; }
        .slot-w2 { grid-area: w2; border-color: #552222; color: #ffcccc; height: 25px; }
        .slot-a2 { grid-area: a2; border-color: #222255; color: #ccccff; height: 25px; }

        .acc-slot {
            grid-area: acc; border-color: #554400; color: #ffffcc; height: 53px;
            font-size: 10px; writing-mode: horizontal-tb;
        }

        /* í« ìŠ¬ë¡¯ */
        .pet-wrapper {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin-left: 5px; padding-left: 10px; border-left: 1px solid #444; min-width: 50px;
        }
        .pet-slot {
            width: 45px; height: 45px; border-radius: 8px; background: #333; border: 2px dashed #666;
            display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden;
        }
        .pet-slot img { width: 100%; height: 100%; object-fit: cover; }

        /* ì •ë³´ í–‰ */
        .info-row { display: flex; gap: 5px; justify-content: space-between; margin-bottom: 5px; }
        .info-row select { width: 40%; }
        .info-row input { width: 58%; }

        /* ê³µëµ ì¹´ë“œ */
        .strategy-card {
            background: #2a2a2a; border: 1px solid #444; border-radius: 8px;
            padding: 12px; margin-bottom: 10px; cursor: pointer; text-align: left; transition: 0.2s;
        }
        .strategy-card:hover { border-color: gold; background: #333; }
        .strategy-deck-preview img { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #555; margin-right: 2px; object-fit: cover; }

        /* --- ëª¨ë‹¬ --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-content { background-color: #1e1e1e; padding: 20px; border-radius: 12px; width: 95%; max-width: 500px; max-height: 85vh; display: flex; flex-direction: column; border: 1px solid #444; }

        .hero-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; overflow-y: auto; flex-grow: 1; padding: 5px; }
        .hero-item { text-align: center; cursor: pointer; }
        .hero-circle { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #555; overflow: hidden; margin: 0 auto; background: #333; }
        .hero-name { font-size: 10px; color: #ccc; margin-top: 3px; overflow: hidden; }

        /* ì¥ë¹„ ëª¨ë‹¬ (2ë‹¨) */
        .gear-modal-grid { display: flex; gap: 10px; height: 300px; margin-bottom: 10px; }
        .gear-col { flex: 1; display: flex; flex-direction: column; border: 1px solid #444; border-radius: 5px; background: #222; overflow-y: auto; }
        .gear-col h4 { margin: 0; padding: 8px; background: #333; text-align: center; border-bottom: 1px solid #444; position: sticky; top: 0; color: #eee; }
        .gear-btn { padding: 12px; border: none; background: transparent; color: #aaa; text-align: left; border-bottom: 1px solid #333; cursor: pointer; font-size: 14px; }
        .gear-btn:hover { background: #2a2a2a; color: white; }
        .gear-btn.selected { background: #004d40; color: #4db6ac; border-left: 3px solid #009688; font-weight: bold; }

        /* ì¥ì‹ êµ¬ ê·¸ë¦¬ë“œ */
        .acc-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; margin-top: 10px; max-height: 300px; overflow-y: auto; }
        .acc-btn { padding: 10px; background: #333; border: 1px solid #444; color: #ddd; cursor: pointer; border-radius: 4px; }
        .acc-btn:hover { border-color: gold; }

    </style>
</head>
<body>

<div class="container">
    <h2 style="color:gold; text-shadow:0 0 10px gold;">âš”ï¸ ê¸¸ë“œì „ ì‘ì „ìƒí™©ì‹¤</h2>

    <div id="loginArea" class="box neon-blue">
        <h3>ğŸ” ë¡œê·¸ì¸</h3>
        <input type="text" id="myNick" placeholder="ë³¸ì¸ ë‹‰ë„¤ì„ ì…ë ¥">
        <button onclick="login()">ì ‘ì†í•˜ê¸°</button>
    </div>

    <div id="mainArea" class="hidden">

        <div class="box neon-green">
            <h3>1. íƒ€ê²Ÿ ë° ê³µëµ í™•ì¸</h3>
            <select id="enemySelect" onchange="selectEnemy()">
                <option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
            </select>

            <div id="enemyDeckVisual" class="deck-container" style="justify-content: center; min-height: 60px;">
                <span style="color:#666; font-size:0.9em; line-height:60px;">ìƒëŒ€ë¥¼ ì„ íƒí•˜ë©´ ì •ë³´ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</span>
            </div>
            <input type="hidden" id="currentEnemyDeck">

            <div id="strategyBox" style="margin-top:10px;"></div>
        </div>

        <div class="box neon-purple">
            <h3>2. ë‚´ ê³µê²©íŒ€ êµ¬ì„±</h3>
            <div class="info-row">
                <select id="myFormation">
                    <option value="ê¸°ë³¸">ê¸°ë³¸ ì§„í˜•</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option>
                </select>
                <input type="text" id="myKeyItems" placeholder="ê¸°íƒ€ ë©”ëª¨ (í« ìŠ¤í‚¬ ë“±)">
            </div>

            <div class="deck-container" id="myBattleDeckContainer"></div>

            <input type="hidden" id="myBattleDeckResult">
            <input type="hidden" id="myBattlePetResult">
        </div>

        <div class="box neon-red">
            <h3>3. ê²°ê³¼ ê¸°ë¡</h3>
            <div style="display:flex; gap:10px;">
                <button onclick="record('WIN')" style="background:#2e7d32;">â­â­â­ ìŠ¹ë¦¬</button>
                <button onclick="record('LOSE')" style="background:#c62828;">âŒ íŒ¨ë°°</button>
            </div>
        </div>

        <button onclick="toggleAdmin()" style="background:#444; margin-top:20px;">ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë“œ</button>

        <div id="adminArea" class="hidden" style="margin-top:20px;">
            <div class="box neon-blue">
                <h3>ğŸ“œ ì‹ ê·œ ê³µëµ ë“±ë¡</h3>
                <select id="targetEnemySelect"></select>
                <div class="info-row">
                    <select id="newFormation"><option value="ê¸°ë³¸">ê¸°ë³¸</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option></select>
                    <input type="text" id="newKeyItems" placeholder="íŠ¹ì´ì‚¬í•­ ë©”ëª¨">
                </div>
                <div class="deck-container" id="newAttackDeckContainer"></div>
                <input type="hidden" id="newAttackDeckResult">
                <input type="hidden" id="newAttackPetResult">
                <textarea id="newStrategyNote" placeholder="ìƒì„¸ ê³µëµ ì‘ì„±" style="height:60px;"></textarea>
                <button onclick="addStrategy()">ê³µëµ ë“±ë¡ ì™„ë£Œ</button>
            </div>

            <div class="box neon-blue">
                <h3>ğŸ‘¾ ì‹ ê·œ ì êµ° ì¶”ê°€</h3>
                <input type="text" id="newEnemyName" placeholder="ì  ë‹‰ë„¤ì„">
                <div class="deck-container" onclick="openSelector('enemy', 'HERO')" style="cursor:pointer; justify-content:center;">
                    <div id="preview_enemy_1" class="hero-slot" style="margin:0;">+</div>
                    <div id="preview_enemy_2" class="hero-slot" style="margin:0;">+</div>
                    <div id="preview_enemy_3" class="hero-slot" style="margin:0;">+</div>
                    <div id="preview_enemy_4" class="hero-slot" style="margin:0;">+</div>
                    <div id="preview_enemy_5" class="hero-slot" style="margin:0;">+</div>
                </div>
                <input type="hidden" id="newEnemyDeckResult">
                <button onclick="addNewEnemy()">ì êµ° ë“±ë¡ ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<div id="selectorModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">ì„ íƒ</h3>
        <input type="text" id="searchBox" onkeyup="filterItems()" placeholder="ê²€ìƒ‰...">
        <div id="itemGrid" class="hero-grid"></div>
        <button onclick="closeSelectorModal()" style="background:#c62828; margin-top:10px;">ì·¨ì†Œ</button>
    </div>
</div>

<div id="gearModal" class="modal">
    <div class="modal-content">
        <h3 id="gearModalTitle" style="margin-top:0;">ì¥ë¹„ ì„¤ì •</h3>
        <div class="gear-modal-grid">
            <div class="gear-col">
                <h4>ì„¸íŠ¸</h4>
                <div id="gearSetList"></div>
            </div>
            <div class="gear-col">
                <h4>ì£¼ì˜µì…˜</h4>
                <div id="gearOptionList"></div>
            </div>
        </div>
        <div style="padding:10px; background:#333; text-align:center;">
            <span style="color:#aaa;">ì„ íƒ: </span>
            <span id="gearPreviewText" style="color:#00ff00; font-weight:bold;">-</span>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="confirmGear()" style="background:#2e7d32;">í™•ì¸</button>
            <button onclick="closeGearModal()" style="background:#c62828;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="accModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">ì¥ì‹ êµ¬ ì„ íƒ</h3>
        <input type="text" id="customAccInput" placeholder="ì§ì ‘ ì…ë ¥ (ì˜ˆ: 6ì„± ì§ì—…ë°˜ì§€)" style="border:1px solid gold;">
        <button onclick="confirmCustomAcc()" style="background:#444; border:1px solid gold;">ì…ë ¥í•œ ë‚´ìš©ìœ¼ë¡œ ì ìš©</button>
        <hr style="width:100%; border-color:#444; margin:15px 0;">
        <p style="margin:0; color:#aaa;">ë˜ëŠ” ëª©ë¡ì—ì„œ ì„ íƒ</p>
        <div id="accList" class="acc-grid"></div>
        <button onclick="closeAccModal()" style="background:#c62828; margin-top:15px;">ì·¨ì†Œ</button>
    </div>
</div>

<script>
    // âš ï¸ [ì¤‘ìš”] ë°°í¬í•œ Google Apps Script URLì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš” âš ï¸
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxBaA2krC8gZUIb-zxTX9pzsqfQuhErih_l9a_JIbzH_rLhwS7WUTwr8SqsT_60OEdD/exec";

    // ë°ì´í„° ë¡œë“œ í™•ì¸ ë° ê¸°ë³¸ê°’
    const DATA_HEROES = (typeof HEROES !== 'undefined') ? HEROES : ["ë£¨ë””", "ì—ë°˜", "ì œì´ë¸Œ"];

    // [ìˆ˜ì •] ì‚¬ìš©ì ìš”ì²­ í« ëª©ë¡ ì ìš©
    const DATA_PETS = ["ë£¨", "ì´ë¦°", "ë¦¬ì²¼", "í¬ë¦¬", "íŒŒì´í¬", "ë¸ë¡œ", "ìœˆë””", "ìœ ", "ì—°ì§€", "ì¹´ëŒ", "ë©œíŒ¨ë¡œ", "ì•„ì´ë°˜", "ì¹´ë Œ", "ë¦¬ì¿ ", "ì¥¬ì‹œ", "í—¬ë ˆí•€", "í—¤ë¦¬í•€", "ì œë‹ˆí¼", "ìœ ìš°", "í¬ë¡œì•„", "íŒŒë¼ê³¤", "ë…¸íŠ¸", "ë² ì´", "ë‹ˆí‚¤", "ì„¸ë¦¬", "R-rl", "í‘¸ë¦¬", "ì•„ì•¼", "ë¼êµ¬ë¦¬", "í•´ë¥´í”¼", "ì‚¬ë€", "ë‹ˆë‚˜", "í’ì†Œí˜‘", "ë®¤ë®¤", "ë¯¹", "ë”ì§€", "ì—ë¦¬", "ë¯¸ë¯¹", "ë‘"];

    // ì¥ë¹„ ë°ì´í„°
    const GEAR_SETS = ["ì„ ë´‰ì¥", "ì¶”ì ì", "ì„±ê¸°ì‚¬", "ìˆ˜ë¬¸ì¥", "ìˆ˜í˜¸ì", "ì•”ì‚´ì", "ë³µìˆ˜ì", "ì£¼ìˆ ì‚¬", "ì¡°ìœ¨ì"];
    const OPTS_WEAPON = ["ì•½ì  ê³µê²© í™•ë¥ ", "ì¹˜ëª…íƒ€ í™•ë¥ ", "ì¹˜ëª…íƒ€ í”¼í•´", "ëª¨ë“  ê³µê²©ë ¥(%)", "ëª¨ë“  ê³µê²©ë ¥", "ë°©ì–´ë ¥(%)", "ë°©ì–´ë ¥", "ìƒëª…ë ¥(%)", "ìƒëª…ë ¥", "íš¨ê³¼ì ì¤‘"];
    const OPTS_ARMOR = ["ë°›ëŠ”í”¼í•´ê°ì†Œ", "ë§‰ê¸°í™•ë¥ ", "ëª¨ë“  ê³µê²©ë ¥(%)", "ëª¨ë“  ê³µê²©ë ¥", "ë°©ì–´ë ¥(%)", "ë°©ì–´ë ¥", "ìƒëª…ë ¥(%)", "ìƒëª…ë ¥", "íš¨ê³¼ì €í•­"];

    // ì¥ì‹ êµ¬ ë°ì´í„°
    const GEAR_ACCESSORIES = ["ë¶€í™œì˜ ë°˜ì§€", "ë¶ˆì‚¬ì˜ ë°˜ì§€", "ê¶ŒëŠ¥ì˜ ë°˜ì§€", "ê¸°í•©ì˜ ë°˜ì§€", "ì² ë²½ì˜ ë°˜ì§€", "ê±´ê°•ì˜ ë°˜ì§€", "í† ë²Œì˜ ë°˜ì§€", "ê³µì„±ì˜ ë°˜ì§€", "ì„¬ë©¸ì˜ ë°˜ì§€", "ê·¼ì„±ì˜ ë°˜ì§€"];

    // ìƒíƒœ ê´€ë¦¬: {name, w1, a1, w2, a2, acc}
    let myDeckState = Array(5).fill().map(()=>({name:"", w1:"", a1:"", w2:"", a2:"", acc:""}));
    let adminDeckState = Array(5).fill().map(()=>({name:"", w1:"", a1:"", w2:"", a2:"", acc:""}));
    let myPetState = "";
    let adminPetState = "";
    let tempEnemyHeroes = [];

    let globalData = { enemies: [], strategies: [] };

    // ëª¨ë‹¬ ê´€ë ¨ ìƒíƒœ
    let currentMode = "";
    let currentGearIndex = 0;
    let currentGearSlot = "";
    let tempGearSet = "";
    let tempGearOpt = "";
    let tempHeroIndex = 0;

    // --- ì´ˆê¸°í™” ---
    window.onload = function() {
        if(localStorage.getItem("guildWarNick")) {
            document.getElementById('myNick').value = localStorage.getItem("guildWarNick");
            login();
        }
        renderInteractiveDeck('myBattle');
        renderInteractiveDeck('attack');
    };

    function login() {
        const nick = document.getElementById('myNick').value;
        if(!nick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        localStorage.setItem("guildWarNick", nick);
        document.getElementById('loginArea').classList.add('hidden');
        document.getElementById('mainArea').classList.remove('hidden');
        loadData();
    }

    function loadData() {
        fetch(GAS_URL).then(r=>r.json()).then(d => {
            globalData = d;
            renderDropdowns();
        });
    }

    function renderDropdowns() {
        const sel = document.getElementById('enemySelect');
        const admSel = document.getElementById('targetEnemySelect');
        const cur = sel.value;
        sel.innerHTML = '<option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
        admSel.innerHTML = '<option value="">-- ëŒ€ìƒ ì„ íƒ --</option>';
        globalData.enemies.forEach(e => {
            sel.add(new Option(e.name, e.name));
            admSel.add(new Option(e.name, e.name));
        });
        if(cur) sel.value = cur;
    }

    // --- ì¤„ì„ë§ ë³€í™˜ ---
    function getAbbr(text) {
        if(!text) return "";
        const map = {
            "ì„ ë´‰ì¥":"ì„ ë´‰", "ì¶”ì ì":"ì¶”ì ", "ì„±ê¸°ì‚¬":"ì„±ê¸°", "ìˆ˜ë¬¸ì¥":"ìˆ˜ë¬¸", "ìˆ˜í˜¸ì":"ìˆ˜í˜¸", "ì•”ì‚´ì":"ì•”ì‚´", "ë³µìˆ˜ì":"ë³µìˆ˜", "ì£¼ìˆ ì‚¬":"ì£¼ìˆ ", "ì¡°ìœ¨ì":"ì¡°ìœ¨",
            "ì•½ì  ê³µê²© í™•ë¥ ":"ì•½ê³µ", "ì¹˜ëª…íƒ€ í™•ë¥ ":"ì¹˜í™•", "ì¹˜ëª…íƒ€ í”¼í•´":"ì¹˜í”¼", "ëª¨ë“  ê³µê²©ë ¥(%)":"ê³µ%", "ëª¨ë“  ê³µê²©ë ¥":"ê³µ",
            "ë°©ì–´ë ¥(%)":"ë°©%", "ë°©ì–´ë ¥":"ë°©", "ìƒëª…ë ¥(%)":"ìƒ%", "ìƒëª…ë ¥":"ìƒ", "íš¨ê³¼ì ì¤‘":"íš¨ì ", "íš¨ê³¼ì €í•­":"íš¨ì €", "ë°›ëŠ”í”¼í•´ê°ì†Œ":"ë°›í”¼", "ë§‰ê¸°í™•ë¥ ":"ë§‰ê¸°",
            "ë¶€í™œì˜ ë°˜ì§€":"ë¶€í™œ", "ë¶ˆì‚¬ì˜ ë°˜ì§€":"ë¶ˆì‚¬", "ê¶ŒëŠ¥ì˜ ë°˜ì§€":"ê¶ŒëŠ¥", "ê¸°í•©ì˜ ë°˜ì§€":"ê¸°í•©", "ì² ë²½ì˜ ë°˜ì§€":"ì² ë²½",
            "ê±´ê°•ì˜ ë°˜ì§€":"ê±´ê°•", "í† ë²Œì˜ ë°˜ì§€":"í† ë²Œ", "ê³µì„±ì˜ ë°˜ì§€":"ê³µì„±", "ì„¬ë©¸ì˜ ë°˜ì§€":"ì„¬ë©¸", "ê·¼ì„±ì˜ ë°˜ì§€":"ê·¼ì„±"
        };
        return map[text] || text;
    }

    function formatGearSlot(fullText) {
        if(!fullText) return "";
        const match = fullText.match(/^([^(]+)\(([^)]+)\)$/);
        if(match) return `${getAbbr(match[1])}(${getAbbr(match[2])})`;
        return getAbbr(fullText);
    }

    // --- ë± ë Œë”ë§ ---
    function renderInteractiveDeck(mode) {
        const containerId = mode === 'myBattle' ? 'myBattleDeckContainer' : 'newAttackDeckContainer';
        const container = document.getElementById(containerId);
        const state = mode === 'myBattle' ? myDeckState : adminDeckState;
        const petState = mode === 'myBattle' ? myPetState : adminPetState;

        let html = "";
        state.forEach((h, idx) => {
            const imgHtml = h.name ? `<img src="images/${h.name}.png" onerror="this.parentNode.innerText='${h.name[0]}'">` : "+";

            html += `
            <div class="hero-card">
                <div class="hero-slot" onclick="openSelector('${mode}', 'HERO', ${idx})">${imgHtml}</div>
                <div class="equipment-grid">
                    <div class="gear-slot slot-w1" onclick="openGearSelector('${mode}', ${idx}, 'w1')">${formatGearSlot(h.w1) || "W1"}</div>
                    <div class="gear-slot slot-a1" onclick="openGearSelector('${mode}', ${idx}, 'a1')">${formatGearSlot(h.a1) || "A1"}</div>
                    <div class="acc-slot" onclick="openAccSelector('${mode}', ${idx})">${getAbbr(h.acc) || "ì¥ì‹ êµ¬"}</div>
                    <div class="gear-slot slot-w2" onclick="openGearSelector('${mode}', ${idx}, 'w2')">${formatGearSlot(h.w2) || "W2"}</div>
                    <div class="gear-slot slot-a2" onclick="openGearSelector('${mode}', ${idx}, 'a2')">${formatGearSlot(h.a2) || "A2"}</div>
                </div>
            </div>`;
        });

        const petImg = petState ? `<img src="images/${petState}.png">` : "<span style='font-size:10px; color:#888'>PET</span>";
        html += `
        <div class="pet-wrapper">
            <div class="pet-slot" onclick="openSelector('${mode}', 'PET')">${petImg}</div>
        </div>`;

        container.innerHTML = html;

        // DB ì €ì¥ìš© í¬ë§·
        const textResult = state.filter(h=>h.name).map(h => {
            if(h.w1||h.a1||h.w2||h.a2||h.acc) {
                return `${h.name}(${h.w1||"-"}/${h.a1||"-"}/${h.w2||"-"}/${h.a2||"-"}/${h.acc||"-"})`;
            }
            return h.name;
        }).join(", ");

        const targetDeckId = mode === 'myBattle' ? 'myBattleDeckResult' : 'newAttackDeckResult';
        const targetPetId = mode === 'myBattle' ? 'myBattlePetResult' : 'newAttackPetResult';
        document.getElementById(targetDeckId).value = textResult;
        document.getElementById(targetPetId).value = petState;
    }

    // --- ì˜ì›…/í« ì„ íƒ ëª¨ë‹¬ ---
    function openSelector(mode, type, idx=0) {
        if(mode === 'enemy') {
            currentMode = mode;
            openCommonModal('HERO');
            return;
        }
        currentMode = mode;
        tempHeroIndex = idx;
        const title = type === 'HERO' ? "ì˜ì›… ì„ íƒ" : "í« ì„ íƒ";
        document.getElementById('modalTitle').innerText = title;
        openCommonModal(type);
    }

    function openCommonModal(type) {
        document.getElementById('searchBox').value = "";
        renderItemGrid(type);
        document.getElementById('selectorModal').style.display = 'flex';
    }

    function renderItemGrid(type, filter="") {
        const grid = document.getElementById('itemGrid');
        grid.innerHTML = "";
        const source = type === 'HERO' ? DATA_HEROES : DATA_PETS;
        source.filter(i => i.toLowerCase().includes(filter.toLowerCase())).forEach(item => {
            const div = document.createElement('div');
            div.className = 'hero-item';
            div.onclick = () => confirmCommonSelection(type, item);
            div.innerHTML = `<div class="hero-circle"><img src="images/${item}.png" onerror="this.parentNode.innerText='${item[0]}'"></div><div class="hero-name">${item}</div>`;
            grid.appendChild(div);
        });
    }

    function filterItems() {
        const type = document.getElementById('modalTitle').innerText.includes("ì˜ì›…") ? 'HERO' : 'PET';
        renderItemGrid(type, document.getElementById('searchBox').value);
    }

    function confirmCommonSelection(type, val) {
        if(currentMode === 'enemy') {
            if(tempEnemyHeroes.length >= 5) return alert("ìµœëŒ€ 5ëª…ì…ë‹ˆë‹¤.");
            tempEnemyHeroes.push(val);
            updateEnemyPreview();
        } else {
            if(type === 'HERO') {
                const state = currentMode === 'myBattle' ? myDeckState : adminDeckState;
                state[tempHeroIndex].name = val;
            } else {
                if(currentMode === 'myBattle') myPetState = val; else adminPetState = val;
            }
            renderInteractiveDeck(currentMode);
        }
        closeSelectorModal();
    }
    function closeSelectorModal() { document.getElementById('selectorModal').style.display = 'none'; }

    // --- ì¥ë¹„ ì„ íƒ ëª¨ë‹¬ ---
    function openGearSelector(mode, idx, slot) {
        const state = mode === 'myBattle' ? myDeckState : adminDeckState;
        if(!state[idx].name) return alert("ì˜ì›…ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
        currentMode = mode;
        currentGearIndex = idx;
        currentGearSlot = slot;
        tempGearSet = ""; tempGearOpt = "";
        updateGearPreview();
        const isWeapon = slot.includes('w');
        document.getElementById('gearModalTitle').innerText = `${state[idx].name} - ${isWeapon?"ë¬´ê¸°":"ë°©ì–´êµ¬"}`;

        const setDiv = document.getElementById('gearSetList');
        setDiv.innerHTML = "";
        GEAR_SETS.forEach(s => {
            const b = document.createElement('button');
            b.className = "gear-btn"; b.innerText = s;
            b.onclick = () => { tempGearSet = s; updateGearSelection(setDiv, b); };
            setDiv.appendChild(b);
        });

        const optDiv = document.getElementById('gearOptionList');
        optDiv.innerHTML = "";
        const options = isWeapon ? OPTS_WEAPON : OPTS_ARMOR;
        options.forEach(o => {
            const b = document.createElement('button');
            b.className = "gear-btn"; b.innerText = o;
            b.onclick = () => { tempGearOpt = o; updateGearSelection(optDiv, b); };
            optDiv.appendChild(b);
        });
        const resetBtn = document.createElement('button');
        resetBtn.className = "gear-btn"; resetBtn.innerText = "(í•´ì œ)"; resetBtn.style.color = "#ff4444";
        resetBtn.onclick = () => { tempGearSet="EMPTY"; tempGearOpt="EMPTY"; confirmGear(); };
        optDiv.appendChild(resetBtn);
        document.getElementById('gearModal').style.display = 'flex';
    }

    function updateGearSelection(container, targetBtn) {
        Array.from(container.children).forEach(c => c.classList.remove('selected'));
        targetBtn.classList.add('selected');
        updateGearPreview();
    }
    function updateGearPreview() {
        const txt = document.getElementById('gearPreviewText');
        if(!tempGearSet && !tempGearOpt) txt.innerText = "ì„ íƒí•´ì£¼ì„¸ìš”";
        else txt.innerText = `${tempGearSet||"?"}(${tempGearOpt||"?"})`;
    }
    function confirmGear() {
        const state = currentMode === 'myBattle' ? myDeckState : adminDeckState;
        if(tempGearSet==="EMPTY") state[currentGearIndex][currentGearSlot] = "";
        else {
            if(!tempGearSet || !tempGearOpt) return alert("ì„¸íŠ¸ì™€ ì˜µì…˜ì„ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.");
            state[currentGearIndex][currentGearSlot] = `${tempGearSet}(${tempGearOpt})`;
        }
        renderInteractiveDeck(currentMode);
        closeGearModal();
    }
    function closeGearModal() { document.getElementById('gearModal').style.display = 'none'; }

    // --- ì¥ì‹ êµ¬ ì„ íƒ ëª¨ë‹¬ ---
    function openAccSelector(mode, idx) {
        const state = mode === 'myBattle' ? myDeckState : adminDeckState;
        if(!state[idx].name) return alert("ì˜ì›…ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
        currentMode = mode;
        currentGearIndex = idx;

        const listDiv = document.getElementById('accList');
        listDiv.innerHTML = "";
        document.getElementById('customAccInput').value = "";

        GEAR_ACCESSORIES.forEach(acc => {
            const btn = document.createElement('button');
            btn.className = "acc-btn";
            btn.innerText = acc;
            btn.onclick = () => selectAcc(acc);
            listDiv.appendChild(btn);
        });

        const resetBtn = document.createElement('button');
        resetBtn.className = "acc-btn";
        resetBtn.innerText = "(í•´ì œ)";
        resetBtn.style.borderColor = "#ff4444";
        resetBtn.onclick = () => selectAcc("");
        listDiv.appendChild(resetBtn);

        document.getElementById('accModal').style.display = 'flex';
    }

    function confirmCustomAcc() {
        const val = document.getElementById('customAccInput').value;
        if(!val) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        selectAcc(val);
    }

    function selectAcc(val) {
        const state = currentMode === 'myBattle' ? myDeckState : adminDeckState;
        state[currentGearIndex].acc = val;
        renderInteractiveDeck(currentMode);
        closeAccModal();
    }
    function closeAccModal() { document.getElementById('accModal').style.display = 'none'; }

    // --- íƒ€ê²Ÿ ì„ íƒ & ê³µëµ ì ìš© ---
    function selectEnemy() {
        const name = document.getElementById('enemySelect').value;
        const enemy = globalData.enemies.find(e => e.name === name);
        const deckBox = document.getElementById('enemyDeckVisual');

        if(!enemy) return deckBox.innerHTML = "<span style='line-height:60px; color:#888'>ì •ë³´ ì—†ìŒ</span>";
        document.getElementById('currentEnemyDeck').value = enemy.deck;

        let html = "";
        enemy.deck.split(',').forEach(h => {
            const cleanName = h.split('(')[0].trim();
            html += `<div class="hero-slot" style="margin:0 2px; border-color:#ff5555;"><img src="images/${cleanName}.png" onerror="this.parentNode.innerText='${cleanName[0]}'"></div>`;
        });
        deckBox.innerHTML = html;

        const stratBox = document.getElementById('strategyBox');
        const strats = globalData.strategies.filter(s => s.target === name);
        if(strats.length > 0) {
            let sHtml = "";
            strats.forEach((s, i) => {
                let deckIcons = "";
                s.attack.split(',').forEach(item => {
                    const hName = item.split('(')[0].trim();
                    deckIcons += `<img src="images/${hName}.png" onerror="this.style.display='none'">`;
                });
                sHtml += `<div class="strategy-card" onclick='applyStrategy(${JSON.stringify(s)})'>
                            <div class="strategy-header">
                                <span style="color:gold; font-weight:bold;">ì¶”ì²œ #${i+1} (${s.formation})</span>
                                <span style="font-size:0.8em; color:#bbb;">${s.pet||""}</span>
                            </div>
                            <div class="strategy-deck-preview">${deckIcons}</div>
                            <div style="font-size:0.8em; color:#88ff88; margin-top:2px;">ğŸ’¡ ${s.items||"íŠ¹ì´ì‚¬í•­ ì—†ìŒ"}</div>
                          </div>`;
            });
            stratBox.innerHTML = sHtml;
        } else { stratBox.innerHTML = "<p style='color:#666;'>ê³µëµ ì—†ìŒ</p>"; }
    }

    function applyStrategy(s) {
        myDeckState = Array(5).fill().map(()=>({name:"", w1:"", a1:"", w2:"", a2:"", acc:""}));
        const parts = s.attack.split(',').map(p=>p.trim());
        parts.forEach((p, i) => {
            if(i>=5) return;
            const match = p.match(/^([^(]+)(?:\(([^)]+)\))?$/);
            if(match) {
                myDeckState[i].name = match[1].trim();
                if(match[2]) {
                    const g = match[2].split('/');
                    myDeckState[i].w1 = g[0] || ""; myDeckState[i].a1 = g[1] || "";
                    myDeckState[i].w2 = g[2] || ""; myDeckState[i].a2 = g[3] || "";
                    myDeckState[i].acc = g[4] || "";
                }
            } else {
                myDeckState[i].name = p;
            }
        });
        myPetState = s.pet || "";
        document.getElementById('myFormation').value = s.formation || "ê¸°ë³¸";
        document.getElementById('myKeyItems').value = s.items || "";
        renderInteractiveDeck('myBattle');
        document.querySelector('.neon-purple').scrollIntoView({behavior:'smooth'});
    }

    // --- ì „ì†¡ ---
    function sendData(payload, msg) {
        const btn = event.target;
        btn.disabled = true; btn.innerText = "ì „ì†¡ ì¤‘...";
        fetch(GAS_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type":"application/json"},
            body: JSON.stringify(payload)
        }).then(() => { alert(msg); location.reload(); });
    }

    function addStrategy() {
        const target = document.getElementById('targetEnemySelect').value;
        const deck = document.getElementById('newAttackDeckResult').value;
        if(!target || !deck) return alert("í•„ìˆ˜ ì…ë ¥ ëˆ„ë½");
        sendData({
            action: "add_strategy", targetEnemy: target, attackDeck: deck,
            pet: document.getElementById('newAttackPetResult').value,
            formation: document.getElementById('newFormation').value,
            keyItems: document.getElementById('newKeyItems').value,
            note: document.getElementById('newStrategyNote').value,
            author: document.getElementById('myNick').value
        }, "ê³µëµ ë“±ë¡ ì™„ë£Œ");
    }

    function record(result) {
        const target = document.getElementById('enemySelect').value;
        const myDeck = document.getElementById('myBattleDeckResult').value;
        if(!target || !myDeck) return alert("í•„ìˆ˜ ì…ë ¥ ëˆ„ë½");
        const btn = event.target; btn.disabled=true; btn.innerText="ê¸°ë¡ ì¤‘...";
        fetch(GAS_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type":"application/json"},
            body: JSON.stringify({
                action: "record", nickname: document.getElementById('myNick').value,
                enemyName: target, enemyDeck: document.getElementById('currentEnemyDeck').value,
                myDeck: myDeck, pet: document.getElementById('myBattlePetResult').value,
                formation: document.getElementById('myFormation').value, result: result
            })
        }).then(() => { alert("ê¸°ë¡ ì™„ë£Œ!"); btn.disabled=false; btn.innerText=result==='WIN'?"ìŠ¹ë¦¬":"íŒ¨ë°°"; });
    }

    function updateEnemyPreview() {
        for(let i=1; i<=5; i++) {
            const slot = document.getElementById(`preview_enemy_${i}`);
            slot.innerHTML = tempEnemyHeroes[i-1] ? `<img src="images/${tempEnemyHeroes[i-1]}.png" style="width:100%; height:100%; object-fit:cover;">` : "+";
        }
        document.getElementById('newEnemyDeckResult').value = tempEnemyHeroes.join(',');
    }
    function addNewEnemy() {
        const name = document.getElementById('newEnemyName').value;
        const deck = document.getElementById('newEnemyDeckResult').value;
        if(!name || !deck) return alert("ì´ë¦„/ë± ì…ë ¥ í•„ìš”");
        sendData({ action: "add_enemy", enemyName: name, defenseDeck: deck }, "ì êµ° ë“±ë¡ ì™„ë£Œ");
    }

    function toggleAdmin() { document.getElementById('adminArea').classList.toggle('hidden'); }
    function closeSelectorModal() { document.getElementById('selectorModal').style.display = 'none'; }

</script>
</body>
</html>