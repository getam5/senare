<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸¸ë“œì „ í†µí•© ì‹œìŠ¤í…œ v2</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ë‹¤í¬ ëª¨ë“œ) */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; text-align: center; padding-bottom: 80px;}
        .container { max-width: 450px; margin: 0 auto; padding: 15px; }

        /* ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .box {
            background: #1e1e1e; border: 1px solid #333; border-radius: 12px;
            padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            position: relative;
        }
        .neon-blue { border-left: 5px solid #00ffff; }
        .neon-green { border-left: 5px solid #00ff00; }
        .neon-red { border-left: 5px solid #ff4444; }

        /* ì…ë ¥ í¼ & ë²„íŠ¼ */
        input, select, textarea {
            width: 90%; padding: 12px; margin: 8px 0;
            background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 5px;
        }
        button {
            width: 100%; padding: 12px; margin-top: 5px;
            background: #333; color: white; border: none; border-radius: 5px;
            font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        button:hover { background: #555; }
        .hidden { display: none; }

        /* --- ğŸ†• ì˜ì›… ì„ íƒ UI ìŠ¤íƒ€ì¼ --- */
        .deck-preview {
            display: flex; gap: 5px; justify-content: center; margin: 10px 0; min-height: 50px;
            background: #252525; padding: 10px; border-radius: 8px; flex-wrap: wrap;
        }
        .hero-slot {
            width: 50px; height: 50px; border-radius: 50%; background: #444;
            display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid #555;
            font-size: 10px; text-align: center; cursor: pointer;
        }
        .hero-slot img { width: 100%; height: 100%; object-fit: cover; }

        /* ëª¨ë‹¬ (íŒì—…) ìŠ¤íƒ€ì¼ */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #1e1e1e; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px;
            max-height: 80vh; overflow-y: auto; text-align: center; border: 1px solid #444;
        }
        .hero-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 15px;
        }
        .hero-item {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
        }
        .hero-circle {
            width: 45px; height: 45px; border-radius: 50%; background: #333; border: 2px solid #555;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .hero-circle.selected { border-color: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .hero-name { font-size: 10px; margin-top: 3px; color: #ccc; }

        .close-btn { background: #c62828; margin-top: 15px; }
        .confirm-btn { background: #2e7d32; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>âš”ï¸ ê¸¸ë“œì „ ì‘ì „ìƒí™©ì‹¤</h2>

    <div id="loginArea" class="box neon-blue">
        <h3>ğŸ” ë¡œê·¸ì¸</h3>
        <input type="text" id="myNick" placeholder="ë‹‰ë„¤ì„">
        <button onclick="login()">ì ‘ì†í•˜ê¸°</button>
    </div>

    <div id="mainArea" class="hidden">

        <div class="box neon-green">
            <h3>ğŸ¯ íƒ€ê²Ÿ ì„¤ì •</h3>
            <select id="enemySelect" onchange="showStrategy()">
                <option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
            </select>
            <div id="enemyDeckVisual" class="deck-preview">
                <span style="color:#666; font-size:0.9em; line-height:50px;">ìƒëŒ€ë¥¼ ì„ íƒí•˜ë©´ ë°©ì–´ë±ì´ ë³´ì…ë‹ˆë‹¤.</span>
            </div>
        </div>

        <div id="strategyBox" class="box" style="border-left: 5px solid gold;">
            <h3>ğŸ’¡ ì¶”ì²œ ê³µëµ</h3>
            <div id="strategyDisplay" style="text-align: left; padding: 10px;"></div>
        </div>

        <div class="box neon-red">
            <h3>ğŸ“ ê²°ê³¼ ë³´ê³ </h3>
            <button onclick="record('WIN')" style="background:#2e7d32;">â­â­â­ ì™„íŒŒ (ìŠ¹ë¦¬)</button>
            <button onclick="record('LOSE')" style="background:#c62828;">âŒ ì‹¤íŒ¨ (íŒ¨ë°°)</button>
        </div>

        <button onclick="toggleAdmin()" style="background:#444;">ğŸ› ï¸ ë± ë“±ë¡ / ê³µëµ ì¶”ê°€ (ê´€ë¦¬ì)</button>

        <div id="adminArea" class="hidden" style="margin-top:20px;">

            <div class="box neon-blue">
                <h3>ğŸ‘¾ ì‹ ê·œ ì êµ° ë“±ë¡</h3>
                <input type="text" id="newEnemyName" placeholder="ì  ë‹‰ë„¤ì„">

                <p style="margin:5px 0; font-size:0.9em;">ğŸ”» ë°©ì–´ë± êµ¬ì„± (í´ë¦­í•´ì„œ ì„ íƒ)</p>
                <div class="deck-preview" onclick="openHeroSelector('enemy')">
                    <div id="preview_enemy_1" class="hero-slot">+</div>
                    <div id="preview_enemy_2" class="hero-slot">+</div>
                    <div id="preview_enemy_3" class="hero-slot">+</div>
                    <div id="preview_enemy_4" class="hero-slot">+</div>
                    <div id="preview_enemy_5" class="hero-slot">+</div>
                </div>
                <input type="hidden" id="newEnemyDeckResult"> <button onclick="addNewEnemy()">ì êµ° ë“±ë¡ ì™„ë£Œ</button>
            </div>

            <div class="box neon-blue">
                <h3>ğŸ“œ ê³µëµë²• ì¶”ê°€</h3>
                <select id="targetEnemySelect"></select>

                <p style="margin:5px 0; font-size:0.9em;">ğŸ”» ì¶”ì²œ ê³µê²©ë± êµ¬ì„±</p>
                <div class="deck-preview" onclick="openHeroSelector('attack')">
                    <div id="preview_attack_1" class="hero-slot">+</div>
                    <div id="preview_attack_2" class="hero-slot">+</div>
                    <div id="preview_attack_3" class="hero-slot">+</div>
                    <div id="preview_attack_4" class="hero-slot">+</div>
                    <div id="preview_attack_5" class="hero-slot">+</div>
                </div>
                <input type="hidden" id="newAttackDeckResult">

                <textarea id="newStrategyNote" placeholder="ìƒì„¸ ê³µëµ (í«, ì§„í˜•, ì£¼ì˜ì‚¬í•­ ë“±)"></textarea>
                <button onclick="addStrategy()">ê³µëµ ë“±ë¡ ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<div id="heroModal" class="modal">
    <div class="modal-content">
        <h3>ì˜ì›… ì„ íƒ (ìµœëŒ€ 5ëª…)</h3>
        <div id="heroGrid" class="hero-grid">
        </div>
        <button class="confirm-btn" onclick="confirmSelection()">ì„ íƒ ì™„ë£Œ</button>
        <button class="close-btn" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxz_Y0rXv7uAJ1cdoxyn_pka8lFyee-VqhQbxUlx2WxGc_2i_OcxWBtLQdAY4iYBbP0/exec"; // Apps Script URL ì…ë ¥

    // ğŸŒŸ ì˜ì›… ë°ì´í„°ë² ì´ìŠ¤ (ì—¬ê¸°ì— ì˜ì›…ì„ ê³„ì† ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤)
    const HEROES = [
        "ë£¨ë””", "ì—ë°˜", "ì œì´ë¸Œ", "ìŠ¤íŒŒì´í¬", "ì•„ì¼ë¦°", "ë ˆì´ì²¼", "ë¸ë¡ ì¦ˆ", "í¬ë¦¬ìŠ¤", // ì„¸ë¸ë‚˜ì´ì¸ 
        "ì—ì´ìŠ¤", "ì˜¤ê³µ", "ì—¬í¬", "ë¦°", "íƒœì˜¤", "ì¹´ë¥´ë§ˆ", "ì—°í¬", "ì¹´ì¼", // ì‚¬í™©/êµ¬ì‚¬í™©
        "ì¹´ë¦°", "ìœ ë¦¬", "í—¬ë ˆë‹ˆì•„", "í—¤ë¸Œë‹ˆì•„", "ìŠ¤ë‹ˆí¼", "ì¥¬í”¼", "ë¦¬", "ë¹…í† ë¦¬ì•„" // ì¼ë°˜
    ];

    let currentUser = "";
    let globalData = { enemies: [], strategies: [] };
    let currentSelectionMode = ""; // 'enemy' or 'attack'
    let tempSelectedHeroes = []; // ëª¨ë‹¬ì—ì„œ ì„ íƒ ì¤‘ì¸ ì˜ì›…ë“¤

    // --- ì´ˆê¸°í™” ë° ë¡œê·¸ì¸ ---
    function login() {
        const nick = document.getElementById('myNick').value;
        if (!nick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        currentUser = nick;
        document.getElementById('loginArea').classList.add('hidden');
        document.getElementById('mainArea').classList.remove('hidden');
        loadData();
    }

    // --- ì˜ì›… ì„ íƒ ëª¨ë‹¬ ê´€ë ¨ ë¡œì§ ---
    function openHeroSelector(mode) {
        currentSelectionMode = mode; // ì êµ° ë±ì¸ì§€ ì•„êµ° ë±ì¸ì§€ êµ¬ë¶„
        tempSelectedHeroes = [];
        renderHeroGrid();
        document.getElementById('heroModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('heroModal').style.display = 'none';
    }

    // ì˜ì›… ê·¸ë¦¬ë“œ ìƒì„± (ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ìƒ‰ê¹” ì›ìœ¼ë¡œ ëŒ€ì²´)
    function renderHeroGrid() {
        const grid = document.getElementById('heroGrid');
        grid.innerHTML = "";

        HEROES.forEach(hero => {
            const item = document.createElement('div');
            item.className = 'hero-item';
            item.onclick = () => toggleHeroSelect(hero, item);

            // ì´ë¯¸ì§€ ê²½ë¡œ: images/ë£¨ë””.png (ì—†ìœ¼ë©´ alt í…ìŠ¤íŠ¸ í‘œì‹œ)
            item.innerHTML = `
                <div class="hero-circle" id="hero_${hero}">
                    <img src="images/${hero}.png" alt="${hero}" onerror="this.style.display='none'; this.parentNode.innerText='${hero.substring(0,2)}'">
                </div>
                <div class="hero-name">${hero}</div>
            `;
            grid.appendChild(item);
        });
    }

    function toggleHeroSelect(heroName, element) {
        const circle = element.querySelector('.hero-circle');

        if (tempSelectedHeroes.includes(heroName)) {
            // ì´ë¯¸ ì„ íƒë¨ -> ì·¨ì†Œ
            tempSelectedHeroes = tempSelectedHeroes.filter(h => h !== heroName);
            circle.classList.remove('selected');
        } else {
            // ì„ íƒ ì•ˆë¨ -> ì¶”ê°€ (ìµœëŒ€ 5ëª…)
            if (tempSelectedHeroes.length >= 5) return alert("ìµœëŒ€ 5ëª…ê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            tempSelectedHeroes.push(heroName);
            circle.classList.add('selected');
        }
    }

    function confirmSelection() {
        // ì„ íƒí•œ ì˜ì›…ë“¤ì„ í™”ë©´ì— ë°˜ì˜
        const resultString = tempSelectedHeroes.join(","); // "ë£¨ë””,ì—ë°˜" í˜•íƒœë¡œ ë³€í™˜

        // hidden inputì— ê°’ ì €ì¥ (DB ì „ì†¡ìš©)
        document.getElementById(currentSelectionMode === 'enemy' ? 'newEnemyDeckResult' : 'newAttackDeckResult').value = resultString;

        // í”„ë¦¬ë·° ìŠ¬ë¡¯ ì—…ë°ì´íŠ¸ (UIìš©)
        updatePreviewSlots(currentSelectionMode, tempSelectedHeroes);

        closeModal();
    }

    function updatePreviewSlots(mode, heroList) {
        // ìŠ¬ë¡¯ 1~5 ì´ˆê¸°í™”
        for(let i=1; i<=5; i++) {
            const slot = document.getElementById(`preview_${mode}_${i}`);
            slot.innerHTML = "+";
            slot.style.border = "2px solid #555";
        }

        // ì„ íƒëœ ì˜ì›… ì±„ìš°ê¸°
        heroList.forEach((hero, index) => {
            if(index >= 5) return;
            const slot = document.getElementById(`preview_${mode}_${index+1}`);
            // ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„, ì‹¤íŒ¨í•˜ë©´ í…ìŠ¤íŠ¸
            slot.innerHTML = `<img src="images/${hero}.png" onerror="this.style.display='none'; this.parentNode.innerText='${hero.substring(0,2)}'">`;
            slot.style.border = "2px solid #00ff00";
        });
    }

    // --- ê¸°ì¡´ ë¡œì§ (ë°ì´í„° ë¡œë“œ & ì „ì†¡) ---

    function loadData() {
        fetch(GAS_URL)
            .then(res => res.json())
            .then(data => {
                globalData = data;
                renderDropdowns();
            });
    }

    function renderDropdowns() {
        const select = document.getElementById('enemySelect');
        const adminSelect = document.getElementById('targetEnemySelect');
        select.innerHTML = '<option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
        adminSelect.innerHTML = '<option value="">-- ê³µëµí•  ëŒ€ìƒ ì„ íƒ --</option>';

        globalData.enemies.forEach(e => {
            select.add(new Option(e.name, e.name));
            adminSelect.add(new Option(e.name, e.name));
        });
    }

    function showStrategy() {
        const name = document.getElementById('enemySelect').value;
        const visualBox = document.getElementById('enemyDeckVisual');
        const strategyBox = document.getElementById('strategyDisplay');

        const enemy = globalData.enemies.find(e => e.name === name);
        if(!enemy) {
            visualBox.innerHTML = '<span style="color:#666; line-height:50px;">ìƒëŒ€ë¥¼ ì„ íƒí•˜ë©´ ë°©ì–´ë±ì´ ë³´ì…ë‹ˆë‹¤.</span>';
            strategyBox.innerText = "";
            return;
        }

        // í…ìŠ¤íŠ¸("ë£¨ë””,ì—ë°˜")ë¥¼ ë¶„ë¦¬í•´ì„œ ì•„ì´ì½˜ìœ¼ë¡œ ë³´ì—¬ì£¼ê¸°
        const heroes = enemy.deck.split(',');
        let html = "";
        heroes.forEach(h => {
            html += `<div class="hero-slot" style="border-color:red;">
                        <img src="images/${h.trim()}.png" onerror="this.style.display='none'; this.parentNode.innerText='${h.trim().substring(0,2)}'">
                      </div>`;
        });
        visualBox.innerHTML = html;

        // ê³µëµ í‘œì‹œ
        const strategies = globalData.strategies.filter(s => s.target === name);
        if(strategies.length > 0) {
            let sHtml = "";
            strategies.forEach(s => {
                // ê³µê²©ë± í…ìŠ¤íŠ¸ë„ ì•„ì´ì½˜ìœ¼ë¡œ ë³€í™˜
                const attHeroes = s.attack.split(',');
                let attIcons = "";
                attHeroes.forEach(h => {
                    attIcons += `<span style="display:inline-block; width:30px; height:30px; border-radius:50%; background:#444; vertical-align:middle; overflow:hidden; margin-right:2px; text-align:center; font-size:9px; line-height:30px; border:1px solid gold;">
                        <img src="images/${h.trim()}.png" style="width:100%; height:100%;" onerror="this.style.display='none'; this.parentNode.innerText='${h.trim().substring(0,2)}'">
                    </span>`;
                });

                sHtml += `<div style="margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
                            <div style="margin-bottom:5px;">âš”ï¸ ì¶”ì²œ: ${attIcons}</div>
                            <span style="color:#bbb; font-size:0.9em;">Tip: ${s.note}</span>
                         </div>`;
            });
            strategyBox.innerHTML = sHtml;
        } else {
            strategyBox.innerText = "ë“±ë¡ëœ ê³µëµì´ ì—†ìŠµë‹ˆë‹¤.";
        }
    }

    // --- ë°ì´í„° ì „ì†¡ (ì´ë¯¸ì§€ ì„ íƒê°’ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•´ì„œ ë³´ëƒ„) ---
    function addNewEnemy() {
        const name = document.getElementById('newEnemyName').value;
        const deck = document.getElementById('newEnemyDeckResult').value; // hidden input ê°’ ì‚¬ìš©

        if(!name || !deck) return alert("ì´ë¦„ê³¼ ë°©ì–´ë±ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");

        fetch(GAS_URL, {
            method: "POST", mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "add_enemy", enemyName: name, defenseDeck: deck })
        }).then(() => { alert("ë“±ë¡ ì™„ë£Œ!"); location.reload(); });
    }

    function addStrategy() {
        const target = document.getElementById('targetEnemySelect').value;
        const deck = document.getElementById('newAttackDeckResult').value; // hidden input ê°’ ì‚¬ìš©
        const note = document.getElementById('newStrategyNote').value;

        if(!target || !deck) return alert("ëŒ€ìƒê³¼ ê³µê²©ë±ì„ ì„ íƒí•˜ì„¸ìš”.");

        fetch(GAS_URL, {
            method: "POST", mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "add_strategy", targetEnemy: target, attackDeck: deck, note: note, author: currentUser })
        }).then(() => { alert("ê³µëµ ë“±ë¡ ì™„ë£Œ!"); location.reload(); });
    }

    function record(result) {
        // ê¸°ì¡´ê³¼ ë™ì¼ (ìƒëµ)
        const target = document.getElementById('enemySelect').value;
        if(!target) return alert("ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
        fetch(GAS_URL, {
            method: "POST", mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "record", nickname: currentUser, enemyName: target, result: result })
        }).then(() => alert("ê¸°ë¡ ì™„ë£Œ!"));
    }

    function toggleAdmin() {
        document.getElementById('adminArea').classList.toggle('hidden');
    }
</script>

</body>
</html>