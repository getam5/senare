<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê¸¸ë“œì „ ì‘ì „ìƒí™©ì‹¤ Final v2</title>
    <script src="gamedata.js"></script>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding-bottom: 100px; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        .box { background: #1e1e1e; border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .neon-blue { border-left: 4px solid #00ffff; }
        .neon-green { border-left: 4px solid #00ff00; }
        .neon-purple { border-left: 4px solid #d500f9; }
        .neon-red { border-left: 4px solid #ff4444; }

        input, select, textarea { width: 95%; padding: 12px; margin: 5px 0; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 6px; font-size: 14px; }
        button { width: 100%; padding: 12px; margin-top: 5px; background: #333; color: white; border: 1px solid #444; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }

        /* --- ë± ì»¨í…Œì´ë„ˆ --- */
        .deck-container {
            display: flex; gap: 6px; justify-content: flex-start; align-items: flex-start;
            background: #252525; padding: 10px; border-radius: 8px; margin: 10px 0;
            overflow-x: auto; min-height: 120px;
        }

        .hero-card {
            display: flex; flex-direction: column; align-items: center;
            width: 100px; flex-shrink: 0; background: #202020; border-radius: 8px; padding: 5px; border: 1px solid #333;
        }

        .hero-slot {
            width: 50px; height: 50px; border-radius: 50%; background: #444; border: 2px solid #555;
            display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; margin-bottom: 5px;
            font-size: 14px; font-weight: bold; color: #aaa; /* í…ìŠ¤íŠ¸ í´ë°±ìš© ìŠ¤íƒ€ì¼ */
        }
        .hero-slot img { width: 100%; height: 100%; object-fit: cover; object-position: top 10%; }

        .equipment-grid { display: grid; width: 100%; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 2px; grid-template-areas: "w1 a1 acc" "w2 a2 acc"; }
        .gear-slot, .acc-slot { background: #333; border: 1px solid #444; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #ccc; cursor: pointer; text-align: center; line-height: 1.1; padding: 2px; word-break: keep-all; }
        .slot-w1 { grid-area: w1; border-color: #552222; color: #ffcccc; height: 24px; }
        .slot-a1 { grid-area: a1; border-color: #222255; color: #ccccff; height: 24px; }
        .slot-w2 { grid-area: w2; border-color: #552222; color: #ffcccc; height: 24px; }
        .slot-a2 { grid-area: a2; border-color: #222255; color: #ccccff; height: 24px; }
        .acc-slot { grid-area: acc; border-color: #554400; color: #ffffcc; height: 50px; writing-mode: horizontal-tb; }

        .pet-wrapper { margin-left: 5px; padding-left: 5px; border-left: 1px solid #444; display:flex; align-items:center; }
        .pet-slot {
            width: 45px; height: 45px; border-radius: 8px; background: #333; border: 2px dashed #666; overflow: hidden;
            display:flex; align-items:center; justify-content:center; cursor: pointer;
            font-size: 10px; color: #888; text-align: center;
        }
        .pet-slot img { width: 100%; height: 100%; object-fit: cover; }

        /* ê³µëµ ì¹´ë“œ */
        .strategy-card { background: #2a2a2a; border: 1px solid #444; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; text-align: left; }
        .strategy-deck-preview { display: flex; gap: 4px; margin: 8px 0; flex-wrap: wrap; }

        /* ë± ë¯¸ë¦¬ë³´ê¸° ì•„ì´ì½˜ (ì‘ì€ ì›) */
        .strategy-icon {
            width: 32px; height: 32px; border-radius: 50%; border: 1px solid #666; overflow: hidden; background: #333;
            display: flex; align-items: center; justify-content: center; font-size: 10px; color: #aaa;
        }
        .strategy-icon img { width: 100%; height: 100%; object-fit: cover; object-position: top 10%; }

        /* [NEW] í˜„ì¬ ì ìš©ëœ ê³µëµ ë©”ëª¨ ë°•ìŠ¤ */
        #activeStrategyNote {
            background: #333; color: #ffd700; border: 1px solid gold;
            padding: 10px; margin-bottom: 10px; border-radius: 6px;
            text-align: left; font-size: 0.9em; display: none;
        }

        /* ëª¨ë‹¬ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .modal-content { background-color: #1e1e1e; padding: 15px; border-radius: 12px; width: 90%; max-width: 450px; max-height: 80vh; display: flex; flex-direction: column; border: 1px solid #444; }

        .hero-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; overflow-y: auto; padding: 10px; align-content: start; }
        .hero-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .hero-circle {
            width: 48px; height: 48px; border-radius: 50%; border: 2px solid #555; overflow: hidden; background: #333; position: relative;
            display: flex; align-items: center; justify-content: center; font-size: 11px; color: #aaa;
        }
        .hero-circle img { width: 100%; height: 100%; object-fit: cover; object-position: top 15%; }
        .hero-name { font-size: 11px; color: #ccc; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 50px;}

        /* ì¥ë¹„ ëª¨ë‹¬ */
        .gear-modal-grid { display: flex; gap: 5px; height: 300px; }
        .gear-col { flex: 1; overflow-y: auto; background: #222; border: 1px solid #444; border-radius: 4px; display:flex; flex-direction:column;}
        .gear-btn, .acc-btn { padding: 12px; background: transparent; color: #aaa; border: none; border-bottom: 1px solid #333; text-align: left; cursor: pointer; }
        .gear-btn.selected { background: #004d40; color: #fff; font-weight: bold; }
        .acc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; overflow-y: auto; max-height: 300px; margin-top:10px;}
        .acc-btn { border:1px solid #444; background:#333; border-radius:4px; text-align:center;}

    </style>
</head>
<body>

<div class="container">
    <h2 style="color:gold; text-shadow:0 0 10px gold;">âš”ï¸ ê¸¸ë“œì „ ì‘ì „ìƒí™©ì‹¤</h2>

    <div id="loginArea" class="box neon-blue">
        <h3>ğŸ” ë¡œê·¸ì¸</h3>
        <input type="text" id="myNick" placeholder="ë‹‰ë„¤ì„">
        <input type="password" id="myKey" placeholder="í‚¤ (ë¹„ë°€ë²ˆí˜¸)">
        <p id="loginMsg" style="color:#aaa; display:none;">ì ‘ì† ì¤‘...</p>
        <button onclick="tryLogin()">ì ‘ì†í•˜ê¸°</button>
    </div>

    <div id="mainArea" class="hidden">

        <div class="box neon-green">
            <h3>1. íƒ€ê²Ÿ ë° ê³µëµ í™•ì¸</h3>
            <select id="enemySelect" onchange="selectEnemy()">
                <option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
            </select>

            <div id="enemyDeckVisual" class="deck-container" style="justify-content: center; min-height: 60px;">
                <span style="color:#666; line-height:60px;">ìƒëŒ€ ì •ë³´ ëŒ€ê¸° ì¤‘</span>
            </div>
            <input type="hidden" id="currentEnemyDeck">

            <div id="strategyBox" style="margin-top:10px;"></div>
        </div>

        <div class="box neon-purple">
            <h3>2. ë‚´ ê³µê²©íŒ€ êµ¬ì„±</h3>

            <div id="activeStrategyNote"></div>

            <div class="info-row">
                <select id="myFormation">
                    <option value="ê¸°ë³¸">ê¸°ë³¸ ì§„í˜•</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option>
                </select>
                <input type="text" id="myKeyItems" placeholder="ë©”ëª¨ (í« ìŠ¤í‚¬ ë“±)">
            </div>
            <div class="deck-container" id="myBattleDeckContainer"></div>
            <input type="hidden" id="myBattleDeckResult">
            <input type="hidden" id="myBattlePetResult">
        </div>

        <div class="box neon-red">
            <h3>3. ê²°ê³¼ ê¸°ë¡</h3>
            <div style="display:flex; gap:10px;">
                <button onclick="record('WIN')" style="background:#2e7d32;">â­â­â­ ìŠ¹ë¦¬</button>
                <button onclick="record('LOSE')" style="background:#c62828;">âŒ íŒ¨ë°°</button>
            </div>
        </div>

        <button onclick="toggleAdmin()" style="background:#444; margin-top:20px;">ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë“œ</button>

        <div id="adminArea" class="hidden" style="margin-top:20px;">
            <div class="box neon-blue">
                <h3>ğŸ“œ ì‹ ê·œ ê³µëµ ë“±ë¡</h3>
                <select id="targetEnemySelect"></select>
                <div class="info-row">
                    <select id="newFormation"><option value="ê¸°ë³¸">ê¸°ë³¸</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option></select>
                    <input type="text" id="newKeyItems" placeholder="íŠ¹ì´ì‚¬í•­">
                </div>
                <div class="deck-container" id="newAttackDeckContainer"></div>
                <input type="hidden" id="newAttackDeckResult"><input type="hidden" id="newAttackPetResult">
                <textarea id="newStrategyNote" placeholder="ìƒì„¸ ê³µëµ ì‘ì„±" style="height:60px;"></textarea>
                <button onclick="addStrategy()">ê³µëµ ë“±ë¡ ì™„ë£Œ</button>
            </div>
            <div class="box neon-blue">
                <h3>ğŸ‘¾ ì êµ° ì¶”ê°€</h3>
                <input type="text" id="newEnemyName" placeholder="ì  ë‹‰ë„¤ì„">
                <div class="deck-container" onclick="openSelector('enemy', 'HERO')" style="justify-content:center; cursor:pointer;">
                    <div id="preview_enemy_1" class="hero-slot">+</div><div id="preview_enemy_2" class="hero-slot">+</div><div id="preview_enemy_3" class="hero-slot">+</div><div id="preview_enemy_4" class="hero-slot">+</div><div id="preview_enemy_5" class="hero-slot">+</div>
                </div>
                <input type="hidden" id="newEnemyDeckResult">
                <button onclick="addNewEnemy()">ì êµ° ë“±ë¡ ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<div id="selectorModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">ì„ íƒ</h3>
        <input type="text" id="searchBox" onkeyup="filterItems()" placeholder="ê²€ìƒ‰...">
        <div id="itemGrid" class="hero-grid"></div>
        <button onclick="closeSelectorModal()" style="background:#c62828; margin-top:10px;">ì·¨ì†Œ</button>
    </div>
</div>

<div id="gearModal" class="modal">
    <div class="modal-content">
        <h3 id="gearModalTitle" style="margin-top:0;">ì¥ë¹„ ì„¤ì •</h3>
        <div class="gear-modal-grid">
            <div class="gear-col"><h4>ì„¸íŠ¸</h4><div id="gearSetList"></div></div>
            <div class="gear-col"><h4>ì£¼ì˜µì…˜</h4><div id="gearOptionList"></div></div>
        </div>
        <div style="padding:10px; background:#333; text-align:center;"><span id="gearPreviewText" style="color:#00ff00;">-</span></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="confirmGear()" style="background:#2e7d32;">í™•ì¸</button>
            <button onclick="closeGearModal()" style="background:#c62828;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="accModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">ì¥ì‹ êµ¬ ì„ íƒ</h3>
        <input type="text" id="customAccInput" placeholder="ì§ì ‘ ì…ë ¥" style="border:1px solid gold;">
        <button onclick="confirmCustomAcc()" style="background:#444; border:1px solid gold;">ì…ë ¥ ì ìš©</button>
        <hr style="width:100%; border-color:#444; margin:15px 0;">
        <div id="accList" class="acc-grid"></div>
        <button onclick="closeAccModal()" style="background:#c62828; margin-top:15px;">ì·¨ì†Œ</button>
    </div>
</div>

<script>
    // âš ï¸ ë³¸ì¸ì˜ GAS URL ì…ë ¥ âš ï¸
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzCecgjx4EPD1JkWhKFAw_3GZgnFK5jtUeWYwfK6Y0FGW320OgGIBrP-UKbyzViAURy/exec";

    // ë°ì´í„° ì •ì˜
    const DATA_HEROES = (typeof HEROES !== 'undefined') ? HEROES : ["ë£¨ë””", "ì—ë°˜", "ì œì´ë¸Œ"];
    const DATA_PETS = ["ë£¨", "ì´ë¦°", "ë¦¬ì²¼", "í¬ë¦¬", "íŒŒì´í¬", "ë¸ë¡œ", "ìœˆë””", "ìœ ", "ì—°ì§€", "ì¹´ëŒ", "ë©œíŒ¨ë¡œ", "ì•„ì´ë°˜", "ì¹´ë Œ", "ë¦¬ì¿ ", "ì¥¬ì‹œ", "í—¬ë ˆí•€", "í—¤ë¦¬í•€", "ì œë‹ˆí¼", "ìœ ìš°", "í¬ë¡œì•„", "íŒŒë¼ê³¤", "ë…¸íŠ¸", "ë² ì´", "ë‹ˆí‚¤", "ì„¸ë¦¬", "R-rl", "í‘¸ë¦¬", "ì•„ì•¼", "ë¼êµ¬ë¦¬", "í•´ë¥´í”¼", "ì‚¬ë€", "ë‹ˆë‚˜", "í’ì†Œí˜‘", "ë®¤ë®¤", "ë¯¹", "ë”ì§€", "ì—ë¦¬", "ë¯¸ë¯¹", "ë‘"];

    const GEAR_SETS = ["ì„ ë´‰ì¥", "ì¶”ì ì", "ì„±ê¸°ì‚¬", "ìˆ˜ë¬¸ì¥", "ìˆ˜í˜¸ì", "ì•”ì‚´ì", "ë³µìˆ˜ì", "ì£¼ìˆ ì‚¬", "ì¡°ìœ¨ì"];
    const OPTS_WEAPON = ["ì•½ì  ê³µê²© í™•ë¥ ", "ì¹˜ëª…íƒ€ í™•ë¥ ", "ì¹˜ëª…íƒ€ í”¼í•´", "ëª¨ë“  ê³µê²©ë ¥(%)", "ëª¨ë“  ê³µê²©ë ¥", "ë°©ì–´ë ¥(%)", "ë°©ì–´ë ¥", "ìƒëª…ë ¥(%)", "ìƒëª…ë ¥", "íš¨ê³¼ì ì¤‘"];
    const OPTS_ARMOR = ["ë°›ëŠ”í”¼í•´ê°ì†Œ", "ë§‰ê¸°í™•ë¥ ", "ëª¨ë“  ê³µê²©ë ¥(%)", "ëª¨ë“  ê³µê²©ë ¥", "ë°©ì–´ë ¥(%)", "ë°©ì–´ë ¥", "ìƒëª…ë ¥(%)", "ìƒëª…ë ¥", "íš¨ê³¼ì €í•­"];
    const GEAR_ACCESSORIES = ["ë¶€í™œì˜ ë°˜ì§€", "ë¶ˆì‚¬ì˜ ë°˜ì§€", "ê¶ŒëŠ¥ì˜ ë°˜ì§€", "ê¸°í•©ì˜ ë°˜ì§€", "ì² ë²½ì˜ ë°˜ì§€", "ê±´ê°•ì˜ ë°˜ì§€", "í† ë²Œì˜ ë°˜ì§€", "ê³µì„±ì˜ ë°˜ì§€", "ì„¬ë©¸ì˜ ë°˜ì§€", "ê·¼ì„±ì˜ ë°˜ì§€"];

    // ë³€ìˆ˜
    let myDeckState = Array(5).fill().map(()=>({name:"", w1:"", a1:"", w2:"", a2:"", acc:""}));
    let adminDeckState = Array(5).fill().map(()=>({name:"", w1:"", a1:"", w2:"", a2:"", acc:""}));
    let myPetState = "", adminPetState = "", tempEnemyHeroes = [];
    let globalData = { members: [], enemies: [], strategies: [] };
    let currentMode = "", currentGearIndex = 0, currentGearSlot = "", tempGearSet = "", tempGearOpt = "", tempHeroIndex = 0;

    // --- ì‹¤í–‰ ---
    window.onload = function() {
        if(localStorage.getItem("guildWarNick")) {
            document.getElementById('myNick').value = localStorage.getItem("guildWarNick");
            tryLogin(true);
        }
        renderInteractiveDeck('myBattle'); renderInteractiveDeck('attack');
    };

    function tryLogin(isAuto=false) {
        const nick = document.getElementById('myNick').value, key = document.getElementById('myKey').value;
        const msg = document.getElementById('loginMsg');
        if(!isAuto && (!nick||!key)) return alert("ì…ë ¥í•˜ì„¸ìš”");
        msg.style.display='block';
        fetch(GAS_URL).then(r=>r.json()).then(d => {
            globalData = d;
            let valid = true;
            if(d.members && d.members.length > 0 && !isAuto) {
                valid = d.members.find(m => String(m.nick)===nick && String(m.key)===key);
            }
            if(valid) {
                localStorage.setItem("guildWarNick", nick);
                document.getElementById('loginArea').classList.add('hidden');
                document.getElementById('mainArea').classList.remove('hidden');
                renderDropdowns();
            } else { msg.innerText = "ë¶ˆì¼ì¹˜"; msg.style.color = "red"; }
        }).catch(e=>{ msg.innerText="í†µì‹ ì˜¤ë¥˜"; });
    }

    function renderDropdowns() {
        const sel = document.getElementById('enemySelect'), adm = document.getElementById('targetEnemySelect');
        const v = sel.value;
        sel.innerHTML='<option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>'; adm.innerHTML='<option value="">-- ëŒ€ìƒ ì„ íƒ --</option>';
        globalData.enemies.forEach(e => { sel.add(new Option(e.name, e.name)); adm.add(new Option(e.name, e.name)); });
        if(v) sel.value = v;
    }

    // --- í…ìŠ¤íŠ¸ ì²˜ë¦¬ (ì¤„ì„ë§ ë° í¬ë§·) ---
    function getAbbr(t) {
        if(!t) return "";
        const m = {
            "ì„ ë´‰ì¥":"ì„ ë´‰", "ì¶”ì ì":"ì¶”ì ", "ì„±ê¸°ì‚¬":"ì„±ê¸°", "ìˆ˜ë¬¸ì¥":"ìˆ˜ë¬¸", "ìˆ˜í˜¸ì":"ìˆ˜í˜¸", "ì•”ì‚´ì":"ì•”ì‚´", "ë³µìˆ˜ì":"ë³µìˆ˜", "ì£¼ìˆ ì‚¬":"ì£¼ìˆ ", "ì¡°ìœ¨ì":"ì¡°ìœ¨",
            "ì•½ì  ê³µê²© í™•ë¥ ":"ì•½ê³µ", "ì¹˜ëª…íƒ€ í™•ë¥ ":"ì¹˜í™•", "ì¹˜ëª…íƒ€ í”¼í•´":"ì¹˜í”¼", "ëª¨ë“  ê³µê²©ë ¥(%)":"ê³µ%", "ëª¨ë“  ê³µê²©ë ¥":"ê³µ",
            "ë°©ì–´ë ¥(%)":"ë°©%", "ë°©ì–´ë ¥":"ë°©", "ìƒëª…ë ¥(%)":"ìƒ%", "ìƒëª…ë ¥":"ìƒ", "íš¨ê³¼ì ì¤‘":"íš¨ì ", "íš¨ê³¼ì €í•­":"íš¨ì €", "ë°›ëŠ”í”¼í•´ê°ì†Œ":"ë°›í”¼", "ë§‰ê¸°í™•ë¥ ":"ë§‰ê¸°",
            "ë¶€í™œì˜ ë°˜ì§€":"ë¶€í™œ", "ë¶ˆì‚¬ì˜ ë°˜ì§€":"ë¶ˆì‚¬", "ê¶ŒëŠ¥ì˜ ë°˜ì§€":"ê¶ŒëŠ¥", "ê¸°í•©ì˜ ë°˜ì§€":"ê¸°í•©", "ì² ë²½ì˜ ë°˜ì§€":"ì² ë²½",
            "ê±´ê°•ì˜ ë°˜ì§€":"ê±´ê°•", "í† ë²Œì˜ ë°˜ì§€":"í† ë²Œ", "ê³µì„±ì˜ ë°˜ì§€":"ê³µì„±", "ì„¬ë©¸ì˜ ë°˜ì§€":"ì„¬ë©¸", "ê·¼ì„±ì˜ ë°˜ì§€":"ê·¼ì„±"
        };
        return m[t] || t;
    }

    function formatGearSlot(fullText) {
        if(!fullText) return "";
        // ê´„í˜¸ ì¤‘ì²© íŒŒì‹± (ex: ì•”ì‚´ì(ì•½ì ...))
        const first = fullText.indexOf('(');
        const last = fullText.lastIndexOf(')');
        if(first > 0 && last > first) {
            const set = fullText.substring(0, first);
            const opt = fullText.substring(first+1, last);
            return `${getAbbr(set)}(${getAbbr(opt)})`;
        }
        return getAbbr(fullText);
    }

    // --- ë± ë Œë”ë§ (ì´ë¯¸ì§€ í´ë°± ì²˜ë¦¬ ì¶”ê°€) ---
    function renderInteractiveDeck(mode) {
        const container = document.getElementById(mode==='myBattle'?'myBattleDeckContainer':'newAttackDeckContainer');
        const state = mode==='myBattle'?myDeckState:adminDeckState;
        const pState = mode==='myBattle'?myPetState:adminPetState;

        let h = "";
        state.forEach((o, i) => {
            // [ìˆ˜ì •] ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì´ë¦„ í…ìŠ¤íŠ¸ í‘œì‹œ
            const img = o.name ?
                `<img src="images/${o.name}.png" onerror="this.style.display='none'; this.parentNode.innerText='${o.name[0]}'">`
                : "+";

            h += `<div class="hero-card">
                    <div class="hero-slot" onclick="openSelector('${mode}','HERO',${i})">${img}</div>
                    <div class="equipment-grid">
                        <div class="gear-slot slot-w1" onclick="openGear('${mode}',${i},'w1')">${formatGearSlot(o.w1)||"W1"}</div>
                        <div class="gear-slot slot-a1" onclick="openGear('${mode}',${i},'a1')">${formatGearSlot(o.a1)||"A1"}</div>
                        <div class="acc-slot" onclick="openAcc('${mode}',${i})">${getAbbr(o.acc)||"Acc"}</div>
                        <div class="gear-slot slot-w2" onclick="openGear('${mode}',${i},'w2')">${formatGearSlot(o.w2)||"W2"}</div>
                        <div class="gear-slot slot-a2" onclick="openGear('${mode}',${i},'a2')">${formatGearSlot(o.a2)||"A2"}</div>
                    </div>
                  </div>`;
        });

        // [ìˆ˜ì •] í« ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì´ë¦„ í…ìŠ¤íŠ¸ í‘œì‹œ
        const pImg = pState ?
            `<img src="images/${pState}.png" onerror="this.style.display='none'; this.parentNode.innerText='${pState}'">`
            : "<span style='font-size:10px;color:#888'>PET</span>";

        h += `<div class="pet-wrapper"><div class="pet-slot" onclick="openSelector('${mode}','PET')">${pImg}</div></div>`;
        container.innerHTML = h;

        // ì €ì¥ìš© í…ìŠ¤íŠ¸ ìƒì„±
        const res = state.filter(x=>x.name).map(x => {
            if(x.w1||x.a1||x.w2||x.a2||x.acc) return `${x.name}(${x.w1||"-"}/${x.a1||"-"}/${x.w2||"-"}/${x.a2||"-"}/${x.acc||"-"})`;
            return x.name;
        }).join(", ");
        document.getElementById(mode==='myBattle'?'myBattleDeckResult':'newAttackDeckResult').value = res;
        document.getElementById(mode==='myBattle'?'myBattlePetResult':'newAttackPetResult').value = pState;
    }

    // --- ëª¨ë‹¬ ë¡œì§ ---
    function openSelector(mode, type, idx=0) {
        if(mode==='enemy') { currentMode=mode; openCommonModal('HERO'); return; }
        currentMode=mode; tempHeroIndex=idx;
        document.getElementById('modalTitle').innerText = type==='HERO'?"ì˜ì›… ì„ íƒ":"í« ì„ íƒ";
        openCommonModal(type);
    }
    function openCommonModal(type) {
        document.getElementById('searchBox').value=""; renderItemGrid(type);
        document.getElementById('selectorModal').style.display='flex';
    }
    function renderItemGrid(type, filter="") {
        const g = document.getElementById('itemGrid'); g.innerHTML="";
        const src = type==='HERO'?DATA_HEROES:DATA_PETS;
        src.filter(x=>x.includes(filter)).forEach(item => {
            const d = document.createElement('div'); d.className='hero-item';
            d.onclick=()=>{confirmSel(type,item)};
            d.innerHTML=`<div class="hero-circle"><img src="images/${item}.png" onerror="this.style.display='none'; this.parentNode.innerText='${item[0]}'"></div><div class="hero-name">${item}</div>`;
            g.appendChild(d);
        });
    }
    function filterItems() { renderItemGrid(document.getElementById('modalTitle').innerText.includes("ì˜ì›…")?'HERO':'PET', document.getElementById('searchBox').value); }
    function confirmSel(type, val) {
        if(currentMode==='enemy') { if(tempEnemyHeroes.length>=5) return alert("5ëª…ê¹Œì§€"); tempEnemyHeroes.push(val); updateEnemyPrev(); }
        else {
            if(type==='HERO') (currentMode==='myBattle'?myDeckState:adminDeckState)[tempHeroIndex].name=val;
            else (currentMode==='myBattle'?myPetState=val:adminPetState=val);
            renderInteractiveDeck(currentMode);
        }
        closeSelectorModal();
    }
    function closeSelectorModal() { document.getElementById('selectorModal').style.display='none'; }

    // ì¥ë¹„
    function openGear(mode, idx, slot) {
        const s = mode==='myBattle'?myDeckState:adminDeckState; if(!s[idx].name) return alert("ì˜ì›… ë¨¼ì €");
        currentMode=mode; currentGearIndex=idx; currentGearSlot=slot; tempGearSet=""; tempGearOpt="";
        document.getElementById('gearPreviewText').innerText="-";
        const sd=document.getElementById('gearSetList'); sd.innerHTML="";
        GEAR_SETS.forEach(x=>{
            const b=document.createElement('button'); b.className="gear-btn"; b.innerText=x;
            b.onclick=()=>{tempGearSet=x; hl(sd,b); upG();}; sd.appendChild(b);
        });
        const od=document.getElementById('gearOptionList'); od.innerHTML="";
        (slot.includes('w')?OPTS_WEAPON:OPTS_ARMOR).forEach(x=>{
            const b=document.createElement('button'); b.className="gear-btn"; b.innerText=x;
            b.onclick=()=>{tempGearOpt=x; hl(od,b); upG();}; od.appendChild(b);
        });
        const r=document.createElement('button'); r.className="gear-btn"; r.innerText="(í•´ì œ)"; r.style.color="red";
        r.onclick=()=>{tempGearSet="EMPTY"; confirmGear();}; od.appendChild(r);
        document.getElementById('gearModal').style.display='flex';
    }
    function hl(p,t) { Array.from(p.children).forEach(c=>c.classList.remove('selected')); t.classList.add('selected'); }
    function upG() { document.getElementById('gearPreviewText').innerText = `${tempGearSet}(${tempGearOpt})`; }
    function confirmGear() {
        const s = currentMode==='myBattle'?myDeckState:adminDeckState;
        if(tempGearSet==="EMPTY") s[currentGearIndex][currentGearSlot]="";
        else { if(!tempGearSet||!tempGearOpt) return alert("ë‘˜ ë‹¤ ì„ íƒ"); s[currentGearIndex][currentGearSlot]=`${tempGearSet}(${tempGearOpt})`; }
        renderInteractiveDeck(currentMode); closeGearModal();
    }
    function closeGearModal() { document.getElementById('gearModal').style.display='none'; }

    // ì¥ì‹ êµ¬
    function openAcc(mode, idx) {
        const s=mode==='myBattle'?myDeckState:adminDeckState; if(!s[idx].name) return alert("ì˜ì›… ë¨¼ì €");
        currentMode=mode; currentGearIndex=idx;
        const l=document.getElementById('accList'); l.innerHTML="";
        GEAR_ACCESSORIES.forEach(x=>{
            const b=document.createElement('button'); b.className="acc-btn"; b.innerText=x;
            b.onclick=()=>{s[currentGearIndex].acc=x; renderInteractiveDeck(currentMode); closeAccModal();};
            l.appendChild(b);
        });
        const r=document.createElement('button'); r.className="acc-btn"; r.innerText="(í•´ì œ)"; r.style.borderColor="red";
        r.onclick=()=>{s[currentGearIndex].acc=""; renderInteractiveDeck(currentMode); closeAccModal();}; l.appendChild(r);
        document.getElementById('accModal').style.display='flex';
    }
    function confirmCustomAcc() {
        const v=document.getElementById('customAccInput').value; if(v) {
            (currentMode==='myBattle'?myDeckState:adminDeckState)[currentGearIndex].acc=v; renderInteractiveDeck(currentMode); closeAccModal();
        }
    }
    function closeAccModal() { document.getElementById('accModal').style.display='none'; }

    // --- ê³µëµ ì„ íƒ ë° ì ìš© (ìˆ˜ì •ëœ íŒŒì‹± ë¡œì§) ---
    function selectEnemy() {
        const n=document.getElementById('enemySelect').value; const e=globalData.enemies.find(x=>x.name===n);
        const v=document.getElementById('enemyDeckVisual');
        document.getElementById('activeStrategyNote').style.display = 'none'; // íƒ€ê²Ÿ ë³€ê²½ì‹œ ë…¸íŠ¸ ìˆ¨ê¹€

        if(!e) return v.innerHTML="<span style='color:#666;line-height:60px'>ì •ë³´ ì—†ìŒ</span>";
        document.getElementById('currentEnemyDeck').value=e.deck;

        let h="";
        e.deck.split(',').forEach(x=>{
            const name=x.split('(')[0].trim();
            h+=`<div class="hero-slot" style="margin:0 2px; border-color:#f55;"><img src="images/${name}.png" onerror="this.style.display='none';this.parentNode.innerText='${name[0]}'"></div>`;
        });
        v.innerHTML=h;

        const sb=document.getElementById('strategyBox');
        const list=globalData.strategies.filter(x=>x.target===n);
        if(list.length>0) {
            let sh="";
            list.forEach((s,i)=>{
                let icons="";
                s.attack.split(',').forEach(k=>{
                    const name=k.split('(')[0].trim();
                    icons+=`<div class="strategy-icon"><img src="images/${name}.png" onerror="this.style.display='none';"></div>`;
                });
                sh+=`<div class="strategy-card" onclick='applyStrategy(${JSON.stringify(s)})'>
                        <div style="display:flex;justify-content:space-between;"><span style="color:gold">ì¶”ì²œ #${i+1} (${s.formation})</span><span style="font-size:0.8em;color:#aaa">${s.pet}</span></div>
                        <div class="strategy-deck-preview">${icons}</div>
                        <div style="font-size:0.8em;color:#8f8">ğŸ’¡ ${s.items||""}</div>
                     </div>`;
            });
            sb.innerHTML=sh;
        } else sb.innerHTML="<p style='color:#666'>ê³µëµ ì—†ìŒ</p>";
    }

    // [ìˆ˜ì •] applyStrategy: ì¤‘ì²© ê´„í˜¸ íŒŒì‹± ë¡œì§ ê°œì„ 
    function applyStrategy(s) {
        myDeckState = Array(5).fill().map(()=>({name:"", w1:"", a1:"", w2:"", a2:"", acc:""}));

        // ë°ì´í„° í¬ë§·: "ë£¨ë””(ì„ ë´‰(ì¹˜í™•)/...)" 
        // ì‰¼í‘œë¡œ ë‚˜ëˆŒ ë•Œ ê´„í˜¸ ì•ˆì˜ ì‰¼í‘œëŠ” ë¬´ì‹œí•´ì•¼ í•˜ì§€ë§Œ, í˜„ì¬ ë± ì €ì¥ í¬ë§·ì€ ì˜ì›…ê°„ êµ¬ë¶„ì„ ', 'ë¡œ í•˜ê³ 
        // ë‚´ë¶€ ì¥ë¹„ êµ¬ë¶„ì€ '/'ë¡œ í•˜ë¯€ë¡œ ',' splitì€ ì•ˆì „í•˜ë‹¤ê³  ê°€ì •. (ë‹¨, ì¥ë¹„ ì´ë¦„ì— ,ê°€ ì—†ì–´ì•¼ í•¨)
        // ë§Œì•½ ì•ˆì „í•˜ì§€ ì•Šë‹¤ë©´ ì •ê·œì‹ í•„ìš”. ì—¬ê¸°ì„  ê°„ë‹¨í•˜ê²Œ split ì²˜ë¦¬.

        const parts = s.attack.split(',').map(p=>p.trim());
        parts.forEach((p, i) => {
            if(i>=5) return;

            // "Name(Data)" í˜•íƒœ ì°¾ê¸°. 
            // ê´„í˜¸ê°€ ì¤‘ì²©ë˜ì–´ ìˆìœ¼ë¯€ë¡œ indexOf ì‚¬ìš©
            const firstParen = p.indexOf('(');
            const lastParen = p.lastIndexOf(')');

            if(firstParen > 0 && lastParen > firstParen) {
                myDeckState[i].name = p.substring(0, firstParen).trim();
                const content = p.substring(firstParen + 1, lastParen);
                const g = content.split('/'); // ì¥ë¹„ êµ¬ë¶„

                myDeckState[i].w1 = g[0] || "";
                myDeckState[i].a1 = g[1] || "";
                myDeckState[i].w2 = g[2] || "";
                myDeckState[i].a2 = g[3] || "";
                myDeckState[i].acc = g[4] || "";
            } else {
                myDeckState[i].name = p;
            }
        });

        myPetState = s.pet || "";
        document.getElementById('myFormation').value = s.formation || "ê¸°ë³¸";
        document.getElementById('myKeyItems').value = s.items || "";

        // [NEW] ìƒì„¸ ê³µëµ í‘œì‹œ
        const noteBox = document.getElementById('activeStrategyNote');
        if(s.note) {
            noteBox.style.display = 'block';
            noteBox.innerHTML = `<strong>ğŸ“ ê³µëµ ë…¸íŠ¸:</strong><br>${s.note.replace(/\n/g, '<br>')}`;
        } else {
            noteBox.style.display = 'none';
        }

        renderInteractiveDeck('myBattle');
        document.querySelector('.neon-purple').scrollIntoView({behavior:'smooth'});
    }

    // ì„œë²„ ì „ì†¡
    function send(p, m) {
        fetch(GAS_URL, {method:"POST", mode:"no-cors", headers:{"Content-Type":"application/json"}, body:JSON.stringify(p)})
            .then(()=>{alert(m);location.reload();});
    }
    function addStrategy() {
        const t=document.getElementById('targetEnemySelect').value, d=document.getElementById('newAttackDeckResult').value;
        if(!t||!d) return alert("ì…ë ¥ ëˆ„ë½");
        send({action:"add_strategy", targetEnemy:t, attackDeck:d, pet:document.getElementById('newAttackPetResult').value, formation:document.getElementById('newFormation').value, keyItems:document.getElementById('newKeyItems').value, note:document.getElementById('newStrategyNote').value, author:document.getElementById('myNick').value}, "ë“±ë¡ ì™„ë£Œ");
    }
    function record(r) {
        const t=document.getElementById('enemySelect').value, d=document.getElementById('myBattleDeckResult').value;
        if(!t||!d) return alert("ì…ë ¥ ëˆ„ë½");
        send({action:"record", nickname:document.getElementById('myNick').value, enemyName:t, enemyDeck:document.getElementById('currentEnemyDeck').value, myDeck:d, pet:document.getElementById('myBattlePetResult').value, formation:document.getElementById('myFormation').value, result:r}, "ê¸°ë¡ ì™„ë£Œ");
    }
    function addNewEnemy() {
        const n=document.getElementById('newEnemyName').value, d=document.getElementById('newEnemyDeckResult').value;
        if(!n||!d) return alert("ì…ë ¥ ëˆ„ë½");
        send({action:"add_enemy", enemyName:n, defenseDeck:d}, "ë“±ë¡ ì™„ë£Œ");
    }
    function updateEnemyPrev() {
        for(let i=1; i<=5; i++) document.getElementById(`preview_enemy_${i}`).innerHTML=tempEnemyHeroes[i-1]?`<img src="images/${tempEnemyHeroes[i-1]}.png" style="width:100%;height:100%;object-fit:cover;">`:"+";
        document.getElementById('newEnemyDeckResult').value=tempEnemyHeroes.join(',');
    }
    function toggleAdmin() { document.getElementById('adminArea').classList.toggle('hidden'); }

</script>
</body>
</html>