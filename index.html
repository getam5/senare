<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸¸ë“œì „ ì‘ì „ìƒí™©ì‹¤ vFinal</title>
    <script src="gamedata.js"></script>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ë‹¤í¬ ëª¨ë“œ & ë„¤ì˜¨) --- */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; text-align: center; padding-bottom: 100px; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }

        /* ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .box {
            background: #1e1e1e; border: 1px solid #333; border-radius: 12px;
            padding: 15px; margin-bottom: 20px; position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .neon-blue { border-left: 4px solid #00ffff; }
        .neon-green { border-left: 4px solid #00ff00; }
        .neon-purple { border-left: 4px solid #d500f9; }
        .neon-red { border-left: 4px solid #ff4444; }

        h3 { margin-top: 0; color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.2); }

        /* ì…ë ¥ í¼ */
        input, select, textarea {
            width: 95%; padding: 12px; margin: 5px 0;
            background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 6px;
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus { border-color: gold; outline: none; }

        /* ë²„íŠ¼ */
        button {
            width: 100%; padding: 12px; margin-top: 5px;
            background: #333; color: white; border: 1px solid #444; border-radius: 6px;
            font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        button:hover { background: #444; border-color: #888; }
        .hidden { display: none; }

        /* --- ë± ì»¨í…Œì´ë„ˆ (ì˜ì›…+ì¥ë¹„+í«) --- */
        .deck-container {
            display: flex; gap: 5px; justify-content: center; align-items: flex-start;
            background: #252525; padding: 10px 5px; border-radius: 8px; margin: 10px 0;
            overflow-x: auto; /* í™”ë©´ ì‘ìœ¼ë©´ ìŠ¤í¬ë¡¤ */
            min-height: 85px;
        }

        /* ì˜ì›… ì¹´ë“œ (ì˜ì›… 1ëª… + ì¥ë¹„ 4ê°œ) */
        .hero-card {
            display: flex; flex-direction: column; align-items: center;
            width: 60px; flex-shrink: 0;
        }

        /* ì˜ì›… ì´ë¯¸ì§€ ìŠ¬ë¡¯ */
        .hero-slot {
            width: 50px; height: 50px; border-radius: 50%; background: #444; border: 2px solid #555;
            display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer;
            margin-bottom: 5px; position: relative;
        }
        .hero-slot img { width: 100%; height: 100%; object-fit: cover; object-position: top 15%; }
        .hero-slot:hover { border-color: gold; }

        /* ì¥ë¹„ ê·¸ë¦¬ë“œ (2x2) */
        .gear-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 2px; width: 50px;
        }
        .gear-slot {
            height: 22px; background: #333; border: 1px solid #555; border-radius: 3px;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; color: #888; cursor: pointer;
            overflow: hidden; white-space: nowrap; letter-spacing: -0.5px;
        }
        .gear-slot.weapon { border-color: #552222; color: #ffcccc; }
        .gear-slot.armor { border-color: #222255; color: #ccccff; }
        .gear-slot:hover { border-color: gold; color: gold; }

        /* í« ìŠ¬ë¡¯ */
        .pet-wrapper {
            display: flex; flex-direction: column; align-items: center;
            margin-left: 5px; padding-left: 5px; border-left: 1px solid #444;
        }
        .pet-slot {
            width: 40px; height: 40px; border-radius: 8px; background: #333; border: 2px dashed #666;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            margin-bottom: 5px; overflow: hidden;
        }
        .pet-slot img { width: 100%; height: 100%; object-fit: cover; }

        /* ì •ë³´ í–‰ (ì§„í˜•/ì•„ì´í…œ) */
        .info-row { display: flex; gap: 5px; justify-content: space-between; margin-bottom: 5px; }
        .info-row select { width: 40%; }
        .info-row input { width: 58%; }

        /* ê³µëµ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .strategy-card {
            background: #2a2a2a; border: 1px solid #444; border-radius: 8px;
            padding: 12px; margin-bottom: 10px; cursor: pointer; text-align: left; transition: 0.2s;
        }
        .strategy-card:hover { border-color: gold; background: #333; transform: translateY(-2px); }
        .strategy-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .strategy-deck-preview { display: flex; gap: 2px; margin: 5px 0; }
        .strategy-deck-preview img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; object-position: top 15%; border: 1px solid #555; }

        /* --- ëª¨ë‹¬ ê³µí†µ --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-content { background-color: #1e1e1e; padding: 20px; border-radius: 12px; width: 90%; max-width: 450px; max-height: 80vh; display: flex; flex-direction: column; border: 1px solid #444; }

        /* ì˜ì›… ì„ íƒ ê·¸ë¦¬ë“œ */
        .hero-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; overflow-y: auto; flex-grow: 1; padding: 5px; }
        .hero-item { text-align: center; cursor: pointer; }
        .hero-circle { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #555; overflow: hidden; margin: 0 auto; background: #333; }
        .hero-circle.selected { border-color: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .hero-circle img { width: 100%; height: 100%; object-fit: cover; object-position: top 15%; }
        .hero-name { font-size: 10px; color: #ccc; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- ì¥ë¹„ ì„ íƒ ëª¨ë‹¬ (2ë‹¨) --- */
        .gear-modal-grid { display: flex; gap: 10px; height: 300px; margin-bottom: 10px; }
        .gear-col { flex: 1; display: flex; flex-direction: column; border: 1px solid #444; border-radius: 5px; background: #222; overflow-y: auto; }
        .gear-col h4 { margin: 0; padding: 8px; background: #333; text-align: center; border-bottom: 1px solid #444; position: sticky; top: 0; font-size: 0.9em; color: #ddd; }
        .gear-btn { padding: 10px; border: none; background: transparent; color: #aaa; text-align: left; border-bottom: 1px solid #333; cursor: pointer; font-size: 0.85em; }
        .gear-btn:hover { background: #2a2a2a; color: white; }
        .gear-btn.selected { background: #004d40; color: #4db6ac; border-left: 3px solid #009688; font-weight: bold; }

    </style>
</head>
<body>

<div class="container">
    <h2 style="color:gold; text-shadow:0 0 10px gold;">âš”ï¸ ê¸¸ë“œì „ ì‘ì „ìƒí™©ì‹¤</h2>

    <div id="loginArea" class="box neon-blue">
        <h3>ğŸ” ë¡œê·¸ì¸</h3>
        <input type="text" id="myNick" placeholder="ë³¸ì¸ ë‹‰ë„¤ì„ ì…ë ¥">
        <button onclick="login()">ì ‘ì†í•˜ê¸°</button>
    </div>

    <div id="mainArea" class="hidden">

        <div class="box neon-green">
            <h3>1. íƒ€ê²Ÿ ë° ê³µëµ í™•ì¸</h3>
            <select id="enemySelect" onchange="selectEnemy()">
                <option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
            </select>

            <div id="enemyDeckVisual" class="deck-container" style="justify-content: center; min-height: 60px;">
                <span style="color:#666; font-size:0.9em; line-height:60px;">ìƒëŒ€ë¥¼ ì„ íƒí•˜ë©´ ì •ë³´ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</span>
            </div>
            <input type="hidden" id="currentEnemyDeck">

            <div id="strategyBox" style="margin-top:10px;"></div>
        </div>

        <div class="box neon-purple">
            <h3>2. ë‚´ ê³µê²©íŒ€ êµ¬ì„±</h3>
            <div class="info-row">
                <select id="myFormation">
                    <option value="ê¸°ë³¸">ê¸°ë³¸ ì§„í˜•</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option>
                </select>
                <input type="text" id="myKeyItems" placeholder="íŠ¹ì´ì‚¬í•­ ë©”ëª¨ (í« ìŠ¤í‚¬ ë“±)">
            </div>

            <div class="deck-container" id="myBattleDeckContainer">
            </div>

            <input type="hidden" id="myBattleDeckResult">
            <input type="hidden" id="myBattlePetResult">
        </div>

        <div class="box neon-red">
            <h3>3. ê²°ê³¼ ê¸°ë¡</h3>
            <div style="display:flex; gap:10px;">
                <button onclick="record('WIN')" style="background:#2e7d32; border-color:#1b5e20;">â­â­â­ ìŠ¹ë¦¬</button>
                <button onclick="record('LOSE')" style="background:#c62828; border-color:#b71c1c;">âŒ íŒ¨ë°°</button>
            </div>
        </div>

        <button onclick="toggleAdmin()" style="background:#444; margin-top:20px;">ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë“œ (ê³µëµ/ì êµ° ë“±ë¡)</button>

        <div id="adminArea" class="hidden" style="margin-top:20px;">

            <div class="box neon-blue">
                <h3>ğŸ“œ ì‹ ê·œ ê³µëµ ë“±ë¡</h3>
                <select id="targetEnemySelect"></select>
                <div class="info-row">
                    <select id="newFormation"><option value="ê¸°ë³¸">ê¸°ë³¸</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option></select>
                    <input type="text" id="newKeyItems" placeholder="íŠ¹ì´ì‚¬í•­ ë©”ëª¨">
                </div>

                <div class="deck-container" id="newAttackDeckContainer"></div> <input type="hidden" id="newAttackDeckResult">
                <input type="hidden" id="newAttackPetResult">
                <textarea id="newStrategyNote" placeholder="ìƒì„¸ ê³µëµ ì‘ì„± (ìš´ì˜ë²• ë“±)" style="height:60px;"></textarea>
                <button onclick="addStrategy()">ê³µëµ ë“±ë¡ ì™„ë£Œ</button>
            </div>

            <div class="box neon-blue">
                <h3>ğŸ‘¾ ì‹ ê·œ ì êµ° ì¶”ê°€</h3>
                <input type="text" id="newEnemyName" placeholder="ì  ë‹‰ë„¤ì„">
                <div class="deck-container" onclick="openSelector('enemy', 'HERO')" style="cursor:pointer;">
                    <div id="preview_enemy_1" class="hero-slot" style="margin:0;">+</div>
                    <div id="preview_enemy_2" class="hero-slot" style="margin:0;">+</div>
                    <div id="preview_enemy_3" class="hero-slot" style="margin:0;">+</div>
                    <div id="preview_enemy_4" class="hero-slot" style="margin:0;">+</div>
                    <div id="preview_enemy_5" class="hero-slot" style="margin:0;">+</div>
                </div>
                <input type="hidden" id="newEnemyDeckResult">
                <button onclick="addNewEnemy()">ì êµ° ë“±ë¡ ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<div id="selectorModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">ì„ íƒ</h3>
        <input type="text" id="searchBox" onkeyup="filterItems()" placeholder="ì´ë¦„ ê²€ìƒ‰...">
        <div id="itemGrid" class="hero-grid"></div>
        <button onclick="closeSelectorModal()" style="background:#c62828; margin-top:10px;">ì·¨ì†Œ</button>
    </div>
</div>

<div id="gearModal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 500px; height: auto;">
        <h3 id="gearModalTitle" style="margin-top:0; font-size:1.1em;">ì¥ë¹„ ì„¤ì •</h3>

        <div class="gear-modal-grid">
            <div class="gear-col">
                <h4>ì„¸íŠ¸</h4>
                <div id="gearSetList"></div>
            </div>
            <div class="gear-col">
                <h4>ì£¼ì˜µì…˜</h4>
                <div id="gearOptionList"></div>
            </div>
        </div>

        <div style="padding:10px; background:#333; border-radius:5px; text-align:center; font-size:0.9em;">
            <span style="color:#aaa;">ì„ íƒ: </span>
            <span id="gearPreviewText" style="color:#00ff00; font-weight:bold;">-</span>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="confirmGear()" style="background:#2e7d32;">í™•ì¸</button>
            <button onclick="closeGearModal()" style="background:#c62828;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    // âš ï¸ [ì¤‘ìš”] ë°°í¬í•œ Google Apps Script URLì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš” âš ï¸
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxcfZ8GN_hHkBMefYdeQg5MG-SPQ8cLg2lW_A8F-9azQj5lOkVQp57m6WFa97IHDvHn/exec";

    // ë°ì´í„° ë¡œë“œ í™•ì¸ ë° ê¸°ë³¸ê°’
    const DATA_HEROES = (typeof HEROES !== 'undefined') ? HEROES : ["ë£¨ë””", "ì—ë°˜", "ì œì´ë¸Œ", "ì•„ì¼ë¦°", "ë ˆì´ì²¼", "ë¸ë¡ ì¦ˆ", "í¬ë¦¬ìŠ¤", "ìŠ¤íŒŒì´í¬"];
    const DATA_PETS = (typeof PETS !== 'undefined' && PETS.length > 0) ? PETS : ["ìœ ", "ë¦¬ì²¼", "í¬ë¦¬", "ì œë¸Œ", "íŒŒì´í¬", "ë¦°"];

    // ì¥ë¹„ ë°ì´í„° ìƒìˆ˜
    const GEAR_SETS = ["ì„ ë´‰ì¥", "ì¶”ì ì", "ì„±ê¸°ì‚¬", "ìˆ˜ë¬¸ì¥", "ìˆ˜í˜¸ì", "ì•”ì‚´ì", "ë³µìˆ˜ì", "ì£¼ìˆ ì‚¬", "ì¡°ìœ¨ì"];
    const OPTS_WEAPON = ["ì•½ì  ê³µê²© í™•ë¥ ", "ì¹˜ëª…íƒ€ í™•ë¥ ", "ì¹˜ëª…íƒ€ í”¼í•´", "ëª¨ë“  ê³µê²©ë ¥(%)", "ëª¨ë“  ê³µê²©ë ¥", "ë°©ì–´ë ¥(%)", "ë°©ì–´ë ¥", "ìƒëª…ë ¥(%)", "ìƒëª…ë ¥", "íš¨ê³¼ì ì¤‘"];
    const OPTS_ARMOR = ["ë°›ëŠ”í”¼í•´ê°ì†Œ", "ë§‰ê¸°í™•ë¥ ", "ëª¨ë“  ê³µê²©ë ¥(%)", "ëª¨ë“  ê³µê²©ë ¥", "ë°©ì–´ë ¥(%)", "ë°©ì–´ë ¥", "ìƒëª…ë ¥(%)", "ìƒëª…ë ¥", "íš¨ê³¼ì €í•­"];

    // ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜
    // ë± ìƒíƒœ: [{name:"ë£¨ë””", w1:"ì„ ë´‰ì¥(ì¹˜í™•)", a1:"...", ...}, ...] (5ê°œ)
    let myDeckState = Array(5).fill().map(()=>({name:"", w1:"", a1:"", w2:"", a2:""}));
    let adminDeckState = Array(5).fill().map(()=>({name:"", w1:"", a1:"", w2:"", a2:""}));
    let myPetState = "";
    let adminPetState = "";

    // ì êµ° ë“±ë¡ìš© ì„ì‹œ ì˜ì›… ë°°ì—´
    let tempEnemyHeroes = [];

    let globalData = { enemies: [], strategies: [] };

    // ëª¨ë‹¬ ê´€ë ¨ ìƒíƒœ
    let currentMode = ""; // 'myBattle', 'attack', 'enemy'
    let currentGearIndex = 0;
    let currentGearSlot = "";
    let tempGearSet = "";
    let tempGearOpt = "";
    let tempHeroIndex = 0; // ì˜ì›… ì„ íƒ ì‹œ ëª‡ ë²ˆì§¸ ìŠ¬ë¡¯ì¸ì§€

    // --- ì´ˆê¸°í™” ---
    window.onload = function() {
        if(localStorage.getItem("guildWarNick")) {
            document.getElementById('myNick').value = localStorage.getItem("guildWarNick");
            login();
        }
        renderInteractiveDeck('myBattle');
        renderInteractiveDeck('attack');
    };

    function login() {
        const nick = document.getElementById('myNick').value;
        if(!nick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        localStorage.setItem("guildWarNick", nick);
        document.getElementById('loginArea').classList.add('hidden');
        document.getElementById('mainArea').classList.remove('hidden');
        loadData();
    }

    function loadData() {
        fetch(GAS_URL).then(r=>r.json()).then(d => {
            globalData = d;
            renderDropdowns();
        }).catch(e => console.log("ë°ì´í„° ë¡œë“œ ëŒ€ê¸°ì¤‘..."));
    }

    function renderDropdowns() {
        const sel = document.getElementById('enemySelect');
        const admSel = document.getElementById('targetEnemySelect');
        const cur = sel.value;
        sel.innerHTML = '<option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
        admSel.innerHTML = '<option value="">-- ëŒ€ìƒ ì„ íƒ --</option>';
        globalData.enemies.forEach(e => {
            sel.add(new Option(e.name, e.name));
            admSel.add(new Option(e.name, e.name));
        });
        if(cur) sel.value = cur;
    }

    // --- 1. ì¤„ì„ë§ ë³€í™˜ í•¨ìˆ˜ (í™”ë©´ í‘œì‹œìš©) ---
    function getAbbr(text) {
        if(!text) return "";
        const map = {
            "ì„ ë´‰ì¥":"ì„ ë´‰", "ì¶”ì ì":"ì¶”ì ", "ì„±ê¸°ì‚¬":"ì„±ê¸°", "ìˆ˜ë¬¸ì¥":"ìˆ˜ë¬¸", "ìˆ˜í˜¸ì":"ìˆ˜í˜¸", "ì•”ì‚´ì":"ì•”ì‚´", "ë³µìˆ˜ì":"ë³µìˆ˜", "ì£¼ìˆ ì‚¬":"ì£¼ìˆ ", "ì¡°ìœ¨ì":"ì¡°ìœ¨",
            "ì•½ì  ê³µê²© í™•ë¥ ":"ì•½ê³µ", "ì¹˜ëª…íƒ€ í™•ë¥ ":"ì¹˜í™•", "ì¹˜ëª…íƒ€ í”¼í•´":"ì¹˜í”¼", "ëª¨ë“  ê³µê²©ë ¥(%)":"ê³µ%", "ëª¨ë“  ê³µê²©ë ¥":"ê³µ",
            "ë°©ì–´ë ¥(%)":"ë°©%", "ë°©ì–´ë ¥":"ë°©", "ìƒëª…ë ¥(%)":"ìƒ%", "ìƒëª…ë ¥":"ìƒ", "íš¨ê³¼ì ì¤‘":"íš¨ì ", "íš¨ê³¼ì €í•­":"íš¨ì €", "ë°›ëŠ”í”¼í•´ê°ì†Œ":"ë°›í”¼", "ë§‰ê¸°í™•ë¥ ":"ë§‰ê¸°"
        };
        return map[text] || text;
    }

    function formatGearSlot(fullText) {
        if(!fullText) return "";
        // ì…ë ¥: "ì•”ì‚´ì(ì•½ì  ê³µê²© í™•ë¥ )" -> ì¶œë ¥: "ì•”ì‚´(ì•½ê³µ)"
        const match = fullText.match(/^([^(]+)\(([^)]+)\)$/);
        if(match) return `${getAbbr(match[1])}(${getAbbr(match[2])})`;
        return getAbbr(fullText);
    }

    // --- 2. ëŒ€í™”í˜• ë± ë Œë”ë§ (í•µì‹¬ UI) ---
    function renderInteractiveDeck(mode) {
        const containerId = mode === 'myBattle' ? 'myBattleDeckContainer' : 'newAttackDeckContainer';
        const container = document.getElementById(containerId);
        const state = mode === 'myBattle' ? myDeckState : adminDeckState;
        const petState = mode === 'myBattle' ? myPetState : adminPetState;

        let html = "";
        state.forEach((h, idx) => {
            const imgHtml = h.name ? `<img src="images/${h.name}.png" onerror="this.parentNode.innerText='${h.name[0]}'">` : "+";

            html += `
            <div class="hero-card">
                <div class="hero-slot" onclick="openSelector('${mode}', 'HERO', ${idx})">${imgHtml}</div>
                <div class="gear-grid">
                    <div class="gear-slot weapon" onclick="openGearSelector('${mode}', ${idx}, 'w1')">${formatGearSlot(h.w1) || "W1"}</div>
                    <div class="gear-slot armor" onclick="openGearSelector('${mode}', ${idx}, 'a1')">${formatGearSlot(h.a1) || "A1"}</div>
                    <div class="gear-slot weapon" onclick="openGearSelector('${mode}', ${idx}, 'w2')">${formatGearSlot(h.w2) || "W2"}</div>
                    <div class="gear-slot armor" onclick="openGearSelector('${mode}', ${idx}, 'a2')">${formatGearSlot(h.a2) || "A2"}</div>
                </div>
            </div>`;
        });

        const petImg = petState ? `<img src="images/${petState}.png">` : "<span style='font-size:10px; color:#888'>PET</span>";
        html += `
        <div class="pet-wrapper">
            <div class="pet-slot" onclick="openSelector('${mode}', 'PET')">${petImg}</div>
        </div>`;

        container.innerHTML = html;

        // DB ì €ì¥ìš© í…ìŠ¤íŠ¸ ë³€í™˜: "ì´ë¦„(ì¥ë¹„/ì¥ë¹„/ì¥ë¹„/ì¥ë¹„)"
        const textResult = state.filter(h=>h.name).map(h => {
            if(h.w1||h.a1||h.w2||h.a2) return `${h.name}(${h.w1||"-"}/${h.a1||"-"}/${h.w2||"-"}/${h.a2||"-"})`;
            return h.name;
        }).join(", ");

        const targetDeckId = mode === 'myBattle' ? 'myBattleDeckResult' : 'newAttackDeckResult';
        const targetPetId = mode === 'myBattle' ? 'myBattlePetResult' : 'newAttackPetResult';
        document.getElementById(targetDeckId).value = textResult;
        document.getElementById(targetPetId).value = petState;
    }

    // --- 3. ì˜ì›…/í« ì„ íƒ ëª¨ë‹¬ ---
    function openSelector(mode, type, idx=0) {
        // ì êµ° ë“±ë¡ì€ ë³„ë„ ë¡œì§ (ë‹¨ìˆœ ë°°ì—´)
        if(mode === 'enemy') {
            currentMode = mode;
            openCommonModal('HERO');
            return;
        }

        currentMode = mode;
        tempHeroIndex = idx;
        const title = type === 'HERO' ? "ì˜ì›… ì„ íƒ" : "í« ì„ íƒ";
        document.getElementById('modalTitle').innerText = title;
        openCommonModal(type);
    }

    function openCommonModal(type) {
        document.getElementById('searchBox').value = "";
        renderItemGrid(type);
        document.getElementById('selectorModal').style.display = 'flex';
    }

    function renderItemGrid(type, filter="") {
        const grid = document.getElementById('itemGrid');
        grid.innerHTML = "";
        const source = type === 'HERO' ? DATA_HEROES : DATA_PETS;

        source.filter(i => i.toLowerCase().includes(filter.toLowerCase())).forEach(item => {
            const div = document.createElement('div');
            div.className = 'hero-item';
            div.onclick = () => confirmCommonSelection(type, item);
            div.innerHTML = `
                <div class="hero-circle"><img src="images/${item}.png" onerror="this.parentNode.innerText='${item[0]}'"></div>
                <div class="hero-name">${item}</div>`;
            grid.appendChild(div);
        });
    }

    function filterItems() {
        const type = document.getElementById('modalTitle').innerText.includes("ì˜ì›…") ? 'HERO' : 'PET';
        renderItemGrid(type, document.getElementById('searchBox').value);
    }

    function confirmCommonSelection(type, val) {
        if(currentMode === 'enemy') {
            // ì êµ° ë“±ë¡ ëª¨ë“œì¼ ë•Œ
            if(tempEnemyHeroes.length >= 5) return alert("ìµœëŒ€ 5ëª…ì…ë‹ˆë‹¤.");
            tempEnemyHeroes.push(val);
            updateEnemyPreview();
        } else {
            // ë‚´ ë± / ê³µëµ ë“±ë¡ ëª¨ë“œì¼ ë•Œ
            if(type === 'HERO') {
                const state = currentMode === 'myBattle' ? myDeckState : adminDeckState;
                state[tempHeroIndex].name = val;
            } else {
                if(currentMode === 'myBattle') myPetState = val;
                else adminPetState = val;
            }
            renderInteractiveDeck(currentMode);
        }
        closeSelectorModal();
    }

    function closeSelectorModal() { document.getElementById('selectorModal').style.display = 'none'; }

    // --- 4. ì¥ë¹„ ì„ íƒ ëª¨ë‹¬ (2ë‹¨) ---
    function openGearSelector(mode, idx, slot) {
        const state = mode === 'myBattle' ? myDeckState : adminDeckState;
        if(!state[idx].name) return alert("ì˜ì›…ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");

        currentMode = mode;
        currentGearIndex = idx;
        currentGearSlot = slot;
        tempGearSet = "";
        tempGearOpt = "";
        updateGearPreview();

        const isWeapon = slot.includes('w');
        document.getElementById('gearModalTitle').innerText = `${state[idx].name} - ${isWeapon?"ë¬´ê¸°":"ë°©ì–´êµ¬"} ì„¤ì •`;

        // ì„¸íŠ¸ ë¦¬ìŠ¤íŠ¸
        const setDiv = document.getElementById('gearSetList');
        setDiv.innerHTML = "";
        GEAR_SETS.forEach(s => {
            const b = document.createElement('button');
            b.className = "gear-btn";
            b.innerText = s;
            b.onclick = () => { tempGearSet = s; updateGearSelection(setDiv, b); };
            setDiv.appendChild(b);
        });

        // ì˜µì…˜ ë¦¬ìŠ¤íŠ¸
        const optDiv = document.getElementById('gearOptionList');
        optDiv.innerHTML = "";
        const options = isWeapon ? OPTS_WEAPON : OPTS_ARMOR;
        options.forEach(o => {
            const b = document.createElement('button');
            b.className = "gear-btn";
            b.innerText = o;
            b.onclick = () => { tempGearOpt = o; updateGearSelection(optDiv, b); };
            optDiv.appendChild(b);
        });

        // ì´ˆê¸°í™” ë²„íŠ¼ ì¶”ê°€
        const resetBtn = document.createElement('button');
        resetBtn.className = "gear-btn";
        resetBtn.innerText = "(ì„ íƒ í•´ì œ)";
        resetBtn.style.color = "#ff4444";
        resetBtn.onclick = () => { tempGearSet="EMPTY"; tempGearOpt="EMPTY"; confirmGear(); };
        optDiv.appendChild(resetBtn);

        document.getElementById('gearModal').style.display = 'flex';
    }

    function updateGearSelection(container, targetBtn) {
        Array.from(container.children).forEach(c => c.classList.remove('selected'));
        targetBtn.classList.add('selected');
        updateGearPreview();
    }

    function updateGearPreview() {
        const txt = document.getElementById('gearPreviewText');
        if(!tempGearSet && !tempGearOpt) txt.innerText = "ì„ íƒí•´ì£¼ì„¸ìš”";
        else txt.innerText = `${tempGearSet||"?"}(${tempGearOpt||"?"})`;
    }

    function confirmGear() {
        const state = currentMode === 'myBattle' ? myDeckState : adminDeckState;
        if(tempGearSet==="EMPTY") {
            state[currentGearIndex][currentGearSlot] = "";
        } else {
            if(!tempGearSet || !tempGearOpt) return alert("ì„¸íŠ¸ì™€ ì˜µì…˜ì„ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.");
            state[currentGearIndex][currentGearSlot] = `${tempGearSet}(${tempGearOpt})`;
        }
        renderInteractiveDeck(currentMode);
        closeGearModal();
    }

    function closeGearModal() { document.getElementById('gearModal').style.display = 'none'; }


    // --- 5. íƒ€ê²Ÿ ì„ íƒ ë° ê³µëµ ì ìš© ë¡œì§ ---
    function selectEnemy() {
        const name = document.getElementById('enemySelect').value;
        const enemy = globalData.enemies.find(e => e.name === name);
        const deckBox = document.getElementById('enemyDeckVisual');

        if(!enemy) return deckBox.innerHTML = "<span style='line-height:60px; color:#888'>ì •ë³´ ì—†ìŒ</span>";
        document.getElementById('currentEnemyDeck').value = enemy.deck;

        // ì  ë± í‘œì‹œ (ì˜ì›…ë§Œ)
        let html = "";
        enemy.deck.split(',').forEach(h => {
            const cleanName = h.split('(')[0].trim();
            html += `<div class="hero-slot" style="margin:0 2px; border-color:#ff5555;"><img src="images/${cleanName}.png" onerror="this.parentNode.innerText='${cleanName[0]}'"></div>`;
        });
        deckBox.innerHTML = html;

        // ê³µëµ ë¦¬ìŠ¤íŠ¸
        const stratBox = document.getElementById('strategyBox');
        const strats = globalData.strategies.filter(s => s.target === name);
        if(strats.length > 0) {
            let sHtml = "";
            strats.forEach((s, i) => {
                const petIcon = s.pet ? `<img src="images/${s.pet}.png" style="width:20px; border-radius:50%; vertical-align:middle;">` : "";

                // ë± ë¯¸ë¦¬ë³´ê¸° ì•„ì´ì½˜ ìƒì„±
                let deckIcons = "";
                s.attack.split(',').forEach(item => {
                    const hName = item.split('(')[0].trim();
                    deckIcons += `<img src="images/${hName}.png" onerror="this.style.display='none'">`;
                });

                sHtml += `<div class="strategy-card" onclick='applyStrategy(${JSON.stringify(s)})'>
                            <div class="strategy-header">
                                <span style="color:gold; font-weight:bold;">ì¶”ì²œ #${i+1} (${s.formation})</span>
                                <span style="font-size:0.8em; color:#bbb;">${petIcon} ${s.pet||""}</span>
                            </div>
                            <div class="strategy-deck-preview">${deckIcons}</div>
                            <div style="font-size:0.8em; color:#88ff88; margin-top:5px;">ğŸ’¡ ${s.items||"íŠ¹ì´ì‚¬í•­ ì—†ìŒ"}</div>
                            <div style="font-size:0.8em; color:#ccc; margin-top:2px;">${s.note}</div>
                          </div>`;
            });
            stratBox.innerHTML = sHtml;
        } else {
            stratBox.innerHTML = "<p style='color:#666; font-size:0.9em;'>ë“±ë¡ëœ ê³µëµì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        }
    }

    function applyStrategy(s) {
        // ê³µëµ ë°ì´í„°ë¥¼ íŒŒì‹±í•´ì„œ myDeckStateì— ì£¼ì…
        myDeckState = Array(5).fill().map(()=>({name:"", w1:"", a1:"", w2:"", a2:""}));

        const parts = s.attack.split(',').map(p=>p.trim());
        parts.forEach((p, i) => {
            if(i>=5) return;
            const match = p.match(/^([^(]+)(?:\(([^)]+)\))?$/);
            if(match) {
                myDeckState[i].name = match[1].trim();
                if(match[2]) {
                    const g = match[2].split('/');
                    myDeckState[i].w1 = g[0] || ""; myDeckState[i].a1 = g[1] || "";
                    myDeckState[i].w2 = g[2] || ""; myDeckState[i].a2 = g[3] || "";
                }
            } else {
                myDeckState[i].name = p;
            }
        });

        myPetState = s.pet || "";
        document.getElementById('myFormation').value = s.formation || "ê¸°ë³¸";
        document.getElementById('myKeyItems').value = s.items || "";

        renderInteractiveDeck('myBattle');
        document.querySelector('.neon-purple').scrollIntoView({behavior:'smooth'});
    }

    // --- 6. ë°ì´í„° ì „ì†¡ (ë“±ë¡/ê¸°ë¡) ---
    function sendData(payload, msg) {
        const btn = event.target;
        const orgText = btn.innerText;
        btn.disabled = true; btn.innerText = "ì „ì†¡ ì¤‘...";

        fetch(GAS_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type":"application/json"},
            body: JSON.stringify(payload)
        }).then(() => {
            alert(msg);
            location.reload();
        }).catch(err => {
            alert("ì˜¤ë¥˜ ë°œìƒ");
            btn.disabled = false; btn.innerText = orgText;
        });
    }

    function addStrategy() {
        const target = document.getElementById('targetEnemySelect').value;
        const deck = document.getElementById('newAttackDeckResult').value;
        if(!target || !deck) return alert("ëŒ€ìƒê³¼ ë±ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

        sendData({
            action: "add_strategy",
            targetEnemy: target,
            attackDeck: deck,
            pet: document.getElementById('newAttackPetResult').value,
            formation: document.getElementById('newFormation').value,
            keyItems: document.getElementById('newKeyItems').value,
            note: document.getElementById('newStrategyNote').value,
            author: document.getElementById('myNick').value
        }, "ê³µëµì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function record(result) {
        const target = document.getElementById('enemySelect').value;
        const myDeck = document.getElementById('myBattleDeckResult').value;
        if(!target || !myDeck) return alert("íƒ€ê²Ÿê³¼ ë± ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        // ë¹„ë™ê¸° ê°±ì‹  (ë¦¬ë¡œë“œ ì—†ì´)
        const btn = event.target;
        btn.disabled = true; btn.innerText = "ê¸°ë¡ ì¤‘...";

        fetch(GAS_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type":"application/json"},
            body: JSON.stringify({
                action: "record",
                nickname: document.getElementById('myNick').value,
                enemyName: target,
                enemyDeck: document.getElementById('currentEnemyDeck').value,
                myDeck: myDeck,
                pet: document.getElementById('myBattlePetResult').value,
                formation: document.getElementById('myFormation').value,
                result: result
            })
        }).then(() => {
            alert("ì „íˆ¬ ê²°ê³¼ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            btn.disabled = false;
            btn.innerText = result==='WIN'?"â­â­â­ ìŠ¹ë¦¬":"âŒ íŒ¨ë°°";
        });
    }

    // ì êµ° ë“±ë¡ ê´€ë ¨ (ë‹¨ìˆœ ë°°ì—´ ì‚¬ìš©)
    function updateEnemyPreview() {
        for(let i=1; i<=5; i++) {
            const slot = document.getElementById(`preview_enemy_${i}`);
            if(tempEnemyHeroes[i-1]) {
                slot.innerHTML = `<img src="images/${tempEnemyHeroes[i-1]}.png" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                slot.innerHTML = "+";
            }
        }
        document.getElementById('newEnemyDeckResult').value = tempEnemyHeroes.join(',');
    }

    function addNewEnemy() {
        const name = document.getElementById('newEnemyName').value;
        const deck = document.getElementById('newEnemyDeckResult').value;
        if(!name || !deck) return alert("ì´ë¦„ê³¼ ë±ì„ ì…ë ¥í•˜ì„¸ìš”.");
        sendData({
            action: "add_enemy", enemyName: name, defenseDeck: deck
        }, "ì êµ°ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function toggleAdmin() { document.getElementById('adminArea').classList.toggle('hidden'); }
    function closeSelectorModal() { document.getElementById('selectorModal').style.display = 'none'; }

</script>
</body>
</html>