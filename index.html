<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸¸ë“œì „ ì‘ì „ìƒí™©ì‹¤ v4</title>
    <script src="gamedata.js"></script>
    <style>
        /* --- ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ë˜, í´ë¦­ ê°€ëŠ¥í•œ ìš”ì†Œ ê°•ì¡° --- */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; text-align: center; padding-bottom: 80px;}
        .container { max-width: 450px; margin: 0 auto; padding: 15px; }

        .box {
            background: #1e1e1e; border: 1px solid #333; border-radius: 12px;
            padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            position: relative;
        }
        .neon-blue { border-left: 5px solid #00ffff; }
        .neon-green { border-left: 5px solid #00ff00; }
        .neon-red { border-left: 5px solid #ff4444; }
        .neon-purple { border-left: 5px solid #d500f9; }

        input, select, textarea {
            width: 90%; padding: 12px; margin: 8px 0;
            background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 5px;
        }
        button {
            width: 100%; padding: 12px; margin-top: 5px;
            background: #333; color: white; border: none; border-radius: 5px;
            font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        button:hover { background: #555; }
        .hidden { display: none; }

        /* í”„ë¦¬ë·° ìŠ¬ë¡¯ */
        .deck-preview {
            display: flex; gap: 5px; justify-content: center; margin: 10px 0; min-height: 50px;
            background: #252525; padding: 10px; border-radius: 8px; flex-wrap: wrap;
        }
        .hero-slot {
            width: 50px; height: 50px; border-radius: 50%; background: #444;
            display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid #555;
            font-size: 10px; text-align: center; cursor: pointer; position: relative;
        }
        .hero-slot img { width: 100%; height: 100%; object-fit: cover; object-position: top 20%; }

        /* ê³µëµ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .strategy-card {
            background: #2a2a2a; border: 1px solid #444; border-radius: 8px;
            padding: 10px; margin-bottom: 10px; cursor: pointer; transition: 0.2s;
            text-align: left;
        }
        .strategy-card:hover { border-color: gold; background: #333; }
        .strategy-card h4 { margin: 0 0 5px 0; color: gold; font-size: 0.9em; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background-color: #1e1e1e; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; height: 80vh; display: flex; flex-direction: column; border: 1px solid #444; }
        #heroSearch { margin-bottom: 10px; width: 93%; flex-shrink: 0; }
        .hero-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 5px; overflow-y: auto; flex-grow: 1; padding-right: 5px; min-height: 0; }
        .hero-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .hero-circle { width: 45px; height: 45px; border-radius: 50%; background: #333; border: 2px solid #555; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .hero-circle.selected { border-color: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .hero-circle img { width: 100%; height: 100%; object-fit: cover; object-position: top 20%; }
        .hero-name { font-size: 10px; margin-top: 3px; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 45px; }
        .close-btn { background: #c62828; margin-top: 10px; flex-shrink: 0;}
        .confirm-btn { background: #2e7d32; margin-top: 5px; flex-shrink: 0;}
    </style>
</head>
<body>

<div class="container">
    <h2>âš”ï¸ ê¸¸ë“œì „ ì‘ì „ìƒí™©ì‹¤</h2>

    <div id="loginArea" class="box neon-blue">
        <h3>ğŸ” ë¡œê·¸ì¸</h3>
        <input type="text" id="myNick" placeholder="ë‹‰ë„¤ì„">
        <button onclick="login()">ì ‘ì†í•˜ê¸°</button>
    </div>

    <div id="mainArea" class="hidden">

        <div class="box neon-green">
            <h3>1. íƒ€ê²Ÿ í™•ì¸</h3>
            <select id="enemySelect" onchange="selectEnemy()">
                <option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
            </select>
            <div id="enemyDeckVisual" class="deck-preview">
                <span style="color:#666; font-size:0.9em; line-height:50px;">ìƒëŒ€ ë°©ì–´ë± ì •ë³´</span>
            </div>
            <input type="hidden" id="currentEnemyDeck">
        </div>

        <div id="strategyBox" class="box" style="border-left: 5px solid gold;">
            <h3>2. ì¶”ì²œ ê³µëµ (ì„ íƒ)</h3>
            <div id="strategyDisplay" style="text-align: left; padding: 5px;">
                íƒ€ê²Ÿì„ ì„ íƒí•˜ë©´ ì¶”ì²œ ë±ë“¤ì´ ë‚˜ì˜µë‹ˆë‹¤.
            </div>
        </div>

        <div class="box neon-purple">
            <h3>3. ë‚´ ê³µê²©íŒ€ êµ¬ì„±</h3>
            <p style="font-size:0.8em; color:#aaa; margin:0;">ì¶”ì²œ ê³µëµì„ ëˆ„ë¥´ê±°ë‚˜ ì§ì ‘ ëˆŒëŸ¬ì„œ ì„¸íŒ…í•˜ì„¸ìš”.</p>

            <div class="deck-preview" onclick="openHeroSelector('myBattle')">
                <div id="preview_myBattle_1" class="hero-slot">+</div>
                <div id="preview_myBattle_2" class="hero-slot">+</div>
                <div id="preview_myBattle_3" class="hero-slot">+</div>
                <div id="preview_myBattle_4" class="hero-slot">+</div>
                <div id="preview_myBattle_5" class="hero-slot">+</div>
            </div>
            <input type="hidden" id="myBattleDeckResult">
        </div>

        <div class="box neon-red">
            <h3>4. ê²°ê³¼ ê¸°ë¡</h3>
            <button onclick="record('WIN')" style="background:#2e7d32;">â­â­â­ ìŠ¹ë¦¬ (ì™„íŒŒ)</button>
            <button onclick="record('LOSE')" style="background:#c62828;">âŒ íŒ¨ë°°</button>
        </div>

        <button onclick="toggleAdmin()" style="background:#444;">ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë“œ</button>

        <div id="adminArea" class="hidden" style="margin-top:20px;">
            <div class="box neon-blue">
                <h3>ğŸ‘¾ ì‹ ê·œ ì êµ° ë“±ë¡</h3>
                <input type="text" id="newEnemyName" placeholder="ì  ë‹‰ë„¤ì„">
                <div class="deck-preview" onclick="openHeroSelector('enemy')">
                    <div id="preview_enemy_1" class="hero-slot">+</div><div id="preview_enemy_2" class="hero-slot">+</div><div id="preview_enemy_3" class="hero-slot">+</div><div id="preview_enemy_4" class="hero-slot">+</div><div id="preview_enemy_5" class="hero-slot">+</div>
                </div>
                <input type="hidden" id="newEnemyDeckResult">
                <button onclick="addNewEnemy()">ì êµ° ë“±ë¡ ì™„ë£Œ</button>
            </div>

            <div class="box neon-blue">
                <h3>ğŸ“œ ê³µëµë²• ì¶”ê°€</h3>
                <select id="targetEnemySelect"></select>
                <div class="deck-preview" onclick="openHeroSelector('attack')">
                    <div id="preview_attack_1" class="hero-slot">+</div><div id="preview_attack_2" class="hero-slot">+</div><div id="preview_attack_3" class="hero-slot">+</div><div id="preview_attack_4" class="hero-slot">+</div><div id="preview_attack_5" class="hero-slot">+</div>
                </div>
                <input type="hidden" id="newAttackDeckResult">
                <textarea id="newStrategyNote" placeholder="ìƒì„¸ ê³µëµ"></textarea>
                <button onclick="addStrategy()">ê³µëµ ë“±ë¡ ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<div id="heroModal" class="modal">
    <div class="modal-content">
        <h3>ì˜ì›… ì„ íƒ (ìµœëŒ€ 5ëª…)</h3>
        <input type="text" id="heroSearch" onkeyup="filterHeroes()" placeholder="ì˜ì›… ì´ë¦„ ê²€ìƒ‰...">
        <div id="heroGrid" class="hero-grid"></div>
        <button class="confirm-btn" onclick="confirmSelection()">ì„ íƒ ì™„ë£Œ</button>
        <button class="close-btn" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwVcgvU97-eJpCVb45np2wD1mAhRHYnNgTBZc5A7nOkDRPnyJ9E91Vozt7rE_OCqaBh/exec"; // ë³¸ì¸ URL í•„ìˆ˜!
    const DATA_HEROES = (typeof HEROES !== 'undefined') ? HEROES : ["ë°ì´í„°ë¡œë“œì‹¤íŒ¨"];

    let currentUser = "";
    let globalData = { enemies: [], strategies: [] };
    let currentSelectionMode = "";
    let tempSelectedHeroes = [];

    window.onload = function() {
        const savedNick = localStorage.getItem("guildWarNick");
        if (savedNick) {
            document.getElementById('myNick').value = savedNick;
            login();
        }
    };

    function login() {
        const nick = document.getElementById('myNick').value;
        if (!nick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        currentUser = nick;
        localStorage.setItem("guildWarNick", nick);
        document.getElementById('loginArea').classList.add('hidden');
        document.getElementById('mainArea').classList.remove('hidden');
        loadData();
    }

    function loadData() {
        fetch(GAS_URL)
            .then(res => res.json())
            .then(data => {
                globalData = data;
                renderDropdowns();
            })
            .catch(err => console.error(err));
    }

    function renderDropdowns() {
        const select = document.getElementById('enemySelect');
        const adminSelect = document.getElementById('targetEnemySelect');
        const currentSelection = select.value;

        select.innerHTML = '<option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
        adminSelect.innerHTML = '<option value="">-- ê³µëµí•  ëŒ€ìƒ ì„ íƒ --</option>';

        globalData.enemies.forEach(e => {
            select.add(new Option(e.name, e.name));
            adminSelect.add(new Option(e.name, e.name));
        });

        if(currentSelection) select.value = currentSelection;
    }

    // --- 1. ì  ì„ íƒ ì‹œ ë¡œì§ (ë± ì •ë³´ + ê³µëµ ë¦¬ìŠ¤íŠ¸) ---
    function selectEnemy() {
        const name = document.getElementById('enemySelect').value;
        const visualBox = document.getElementById('enemyDeckVisual');
        const strategyBox = document.getElementById('strategyDisplay');
        const hiddenDeck = document.getElementById('currentEnemyDeck');

        const enemy = globalData.enemies.find(e => e.name === name);
        if(!enemy) {
            visualBox.innerHTML = '<span style="color:#666; line-height:50px;">ìƒëŒ€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>';
            strategyBox.innerText = "";
            hiddenDeck.value = "";
            return;
        }

        // 1-1. ì  ë°©ì–´ë± ì €ì¥ (ë‚˜ì¤‘ì— ì „ì†¡ìš©)
        hiddenDeck.value = enemy.deck;

        // 1-2. ì  ë°©ì–´ë± ë¹„ì£¼ì–¼ í‘œì‹œ
        visualBox.innerHTML = renderDeckIcons(enemy.deck);

        // 1-3. ê³µëµ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ (ì—¬ëŸ¬ ê°œì¼ ê²½ìš° ëª¨ë‘ í‘œì‹œ)
        const strategies = globalData.strategies.filter(s => s.target === name);
        if(strategies.length > 0) {
            let html = "";
            strategies.forEach((s, idx) => {
                // ê³µëµ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ 'applyStrategy' í•¨ìˆ˜ê°€ ì‹¤í–‰ë¨
                html += `<div class="strategy-card" onclick="applyStrategy('${s.attack}')">
                            <h4>ğŸ’¡ ê³µëµ #${idx+1} (í´ë¦­í•˜ì—¬ ì ìš©)</h4>
                            <div style="margin-bottom:5px;">${renderDeckIcons(s.attack, 30)}</div>
                            <span style="color:#bbb; font-size:0.9em;">Tip: ${s.note}</span>
                         </div>`;
            });
            strategyBox.innerHTML = html;
        } else {
            strategyBox.innerHTML = "<p style='color:#666;'>ë“±ë¡ëœ ê³µëµì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        }
    }

    // --- 2. ê³µëµ í´ë¦­ ì‹œ ë‚´ ë±ìœ¼ë¡œ ì ìš© ---
    function applyStrategy(deckString) {
        document.getElementById('myBattleDeckResult').value = deckString;

        // ì‹œê°ì  ì—…ë°ì´íŠ¸
        const heroes = deckString.split(',');
        updatePreviewSlots('myBattle', heroes);

        // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ ì´ë™
        document.querySelector('.neon-purple').scrollIntoView({ behavior: 'smooth' });
    }

    // --- 3. ë± ì•„ì´ì½˜ ë Œë”ë§ í—¬í¼ í•¨ìˆ˜ ---
    function renderDeckIcons(deckStr, size=50) {
        if(!deckStr) return "";
        const heroes = deckStr.split(',');
        let html = "";
        heroes.forEach(h => {
            const cleanName = h.trim();
            // ì‚¬ì´ì¦ˆ ì¡°ì ˆ ê°€ëŠ¥í•˜ê²Œ style ì ìš©
            html += `<div style="width:${size}px; height:${size}px; border-radius:50%; background:#444;
                      display:inline-flex; align-items:center; justify-content:center; overflow:hidden;
                      border:1px solid #777; margin:2px;">
                        <img src="images/${cleanName}.png" style="width:100%; height:100%; object-fit:cover; object-position:top 20%;"
                        onerror="this.style.display='none'; this.parentNode.innerText='${cleanName.substring(0,1)}'">
                      </div>`;
        });
        return html;
    }

    // --- 4. ê²°ê³¼ ê¸°ë¡ (ìˆ˜ì •ë¨: ë± ì •ë³´ í¬í•¨ ì „ì†¡) ---
    function record(result) {
        const target = document.getElementById('enemySelect').value;
        const enemyDeck = document.getElementById('currentEnemyDeck').value;
        const myDeck = document.getElementById('myBattleDeckResult').value;

        if(!target) return alert("ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
        if(!myDeck) return alert("ê³µëµ ë±ì„ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ êµ¬ì„±í•´ì£¼ì„¸ìš”. (3ë²ˆ í•­ëª©)");

        const btn = event.target;
        btn.disabled = true;
        btn.innerText = "ê¸°ë¡ ì¤‘...";

        fetch(GAS_URL, {
            method: "POST", mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                action: "record",
                nickname: currentUser,
                enemyName: target,
                enemyDeck: enemyDeck, // ì  ë±
                myDeck: myDeck,       // ë‚´ ë±
                result: result
            })
        }).then(() => {
            alert("âœ… ê²°ê³¼ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            btn.disabled = false;
            if(result === 'WIN') btn.innerText = "â­â­â­ ìŠ¹ë¦¬ (ì™„íŒŒ)";
            else btn.innerText = "âŒ íŒ¨ë°°";

            // ì…ë ¥ì¹¸ ì¼ë¶€ ì´ˆê¸°í™” (ì—°ì† ê¸°ë¡ í¸ì˜ë¥¼ ìœ„í•´ íƒ€ê²Ÿì€ ìœ ì§€)
            // document.getElementById('myBattleDeckResult').value = "";
            // resetPreviewSlots('myBattle');
        });
    }

    // --- (ì´í•˜ ê¸°ì¡´ í•¨ìˆ˜ë“¤: ëª¨ë‹¬, ë“±ë¡ ë“±ì€ ë™ì¼) ---
    function openHeroSelector(mode) {
        currentSelectionMode = mode;
        tempSelectedHeroes = [];
        document.getElementById('heroSearch').value = "";
        renderHeroGrid(DATA_HEROES);
        document.getElementById('heroModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('heroModal').style.display = 'none'; }

    function filterHeroes() {
        const query = document.getElementById('heroSearch').value.toLowerCase();
        renderHeroGrid(DATA_HEROES.filter(h => h.toLowerCase().includes(query)));
    }

    function renderHeroGrid(list) {
        const grid = document.getElementById('heroGrid');
        grid.innerHTML = "";
        list.forEach(hero => {
            const item = document.createElement('div');
            item.className = 'hero-item';
            item.onclick = () => toggleHeroSelect(hero, item);
            const isSelected = tempSelectedHeroes.includes(hero);
            item.innerHTML = `<div class="hero-circle ${isSelected?'selected':''}">
                    <img src="images/${hero}.png" onerror="this.parentNode.innerText='${hero.substring(0,2)}'">
                </div><div class="hero-name">${hero}</div>`;
            grid.appendChild(item);
        });
    }

    function toggleHeroSelect(heroName, element) {
        const circle = element.querySelector('.hero-circle');
        if (tempSelectedHeroes.includes(heroName)) {
            tempSelectedHeroes = tempSelectedHeroes.filter(h => h !== heroName);
            circle.classList.remove('selected');
        } else {
            if (tempSelectedHeroes.length >= 5) return alert("5ëª…ê¹Œì§€ì…ë‹ˆë‹¤.");
            tempSelectedHeroes.push(heroName);
            circle.classList.add('selected');
        }
    }

    function confirmSelection() {
        const resultString = tempSelectedHeroes.join(",");
        const targetId =
            currentSelectionMode === 'enemy' ? 'newEnemyDeckResult' :
                currentSelectionMode === 'attack' ? 'newAttackDeckResult' : 'myBattleDeckResult';

        document.getElementById(targetId).value = resultString;
        updatePreviewSlots(currentSelectionMode, tempSelectedHeroes);
        closeModal();
    }

    function updatePreviewSlots(mode, heroList) {
        for(let i=1; i<=5; i++) {
            const slot = document.getElementById(`preview_${mode}_${i}`);
            slot.innerHTML = "+"; slot.style.border = "2px solid #555";
        }
        heroList.forEach((hero, index) => {
            if(index >= 5) return;
            const slot = document.getElementById(`preview_${mode}_${index+1}`);
            slot.innerHTML = `<img src="images/${hero}.png" style="width:100%; height:100%; object-fit:cover; object-position:top 20%;">`;
            slot.style.border = "2px solid #00ff00";
        });
    }

    function resetPreviewSlots(mode) {
        for(let i=1; i<=5; i++) {
            document.getElementById(`preview_${mode}_${i}`).innerHTML = "+";
        }
    }

    // ì êµ°/ê³µëµ ë“±ë¡ (ë¹„ë™ê¸°)
    function addNewEnemy() {
        const name = document.getElementById('newEnemyName').value;
        const deck = document.getElementById('newEnemyDeckResult').value;
        if(!name || !deck) return alert("í•„ìˆ˜ ì…ë ¥");
        fetch(GAS_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "add_enemy", enemyName: name, defenseDeck: deck })
        }).then(() => {
            globalData.enemies.push({ name: name, deck: deck });
            renderDropdowns();
            alert("ë“±ë¡ ì™„ë£Œ");
            document.getElementById('newEnemyName').value = "";
            resetPreviewSlots('enemy');
        });
    }

    function addStrategy() {
        const target = document.getElementById('targetEnemySelect').value;
        const deck = document.getElementById('newAttackDeckResult').value;
        const note = document.getElementById('newStrategyNote').value;
        if(!target || !deck) return alert("í•„ìˆ˜ ì…ë ¥");
        fetch(GAS_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "add_strategy", targetEnemy: target, attackDeck: deck, note: note, author: currentUser })
        }).then(() => {
            globalData.strategies.push({ target: target, attack: deck, note: note });
            if(document.getElementById('enemySelect').value === target) selectEnemy();
            alert("ë“±ë¡ ì™„ë£Œ");
            document.getElementById('newAttackDeckResult').value = "";
            document.getElementById('newStrategyNote').value = "";
            resetPreviewSlots('attack');
        });
    }

    function toggleAdmin() { document.getElementById('adminArea').classList.toggle('hidden'); }
</script>

</body>
</html>