<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì‘ì „ìƒí™©ì‹¤</title>
    <script src="gamedata.js"></script>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        body { background-color: #1e2330; color: #d8dce6; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding-bottom: 100px; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        .box { background: #2a3040; border: 1px solid #3d4a5c; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .neon-blue { border-left: 4px solid #5ba8c8; }
        .neon-green { border-left: 4px solid #6bbd7a; }
        .neon-purple { border-left: 4px solid #a87ccf; }
        .neon-red { border-left: 4px solid #d47474; }

        input, select, textarea { width: 95%; padding: 12px; margin: 5px 0; background: #354050; border: 1px solid #4d5a6e; color: #e0e4ec; border-radius: 6px; font-size: 14px; }
        button { width: 100%; padding: 12px; margin-top: 5px; background: #3a4758; color: #e0e4ec; border: 1px solid #4d5a6e; border-radius: 6px; font-weight: bold; cursor: pointer; }
        button:disabled { color: #6a7080; border-color: #3d4a5c; cursor: not-allowed; }
        .hidden { display: none; }

        /* --- ë± ì»¨í…Œì´ë„ˆ --- */
        .deck-container {
            display: flex; gap: 6px; justify-content: flex-start; align-items: flex-start;
            background: #323d50; padding: 10px; border-radius: 8px; margin: 10px 0;
            overflow-x: auto; min-height: 120px;
        }

        .hero-card { display: flex; flex-direction: column; align-items: center; width: 100px; flex-shrink: 0; background: #2a3444; border-radius: 8px; padding: 5px; border: 1px solid #3d4a5c; }
        .hero-slot { width: 50px; height: 50px; border-radius: 50%; background: #4a5568; border: 2px solid #5f6d82; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; margin-bottom: 5px; }
        .hero-slot img { width: 100%; height: 100%; object-fit: cover; object-position: top 10%; }

        .equipment-grid { display: grid; width: 100%; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 2px; grid-template-areas: "w1 a1 acc" "w2 a2 acc"; }
        .gear-slot, .acc-slot { background: #3a4758; border: 1px solid #4d5a6e; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #c0c8d8; cursor: pointer; text-align: center; line-height: 1.1; padding: 2px; word-break: keep-all; }
        .slot-w1 { grid-area: w1; border-color: #7a4a4a; color: #f0c0c0; height: 24px; }
        .slot-a1 { grid-area: a1; border-color: #4a4a7a; color: #c0c0f0; height: 24px; }
        .slot-w2 { grid-area: w2; border-color: #7a4a4a; color: #f0c0c0; height: 24px; }
        .slot-a2 { grid-area: a2; border-color: #4a4a7a; color: #c0c0f0; height: 24px; }
        .acc-slot { grid-area: acc; border-color: #7a6a3a; color: #f0e8c0; height: 50px; writing-mode: horizontal-tb; }

        .pet-wrapper { margin-left: 5px; padding-left: 5px; border-left: 1px solid #4d5a6e; display:flex; align-items:center; }
        .pet-slot { width: 45px; height: 45px; border-radius: 8px; background: #3a4758; border: 2px dashed #5f6d82; overflow: hidden; display:flex; align-items:center; justify-content:center; cursor: pointer; font-size: 10px; color: #8090a8; text-align: center; }
        .pet-slot img { width: 100%; height: 100%; object-fit: cover; }

        /* ê³µëµ ì¹´ë“œ */
        .strategy-card { background: #323d50; border: 1px solid #4d5a6e; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; text-align: left; }
        .strategy-deck-preview { display: flex; gap: 4px; margin: 8px 0; flex-wrap: wrap; }
        .strategy-icon { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #5f6d82; overflow: hidden; background: #3a4758; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #a0a8b8; }
        .strategy-icon img { width: 100%; height: 100%; object-fit: cover; object-position: top 10%; }

        #activeStrategyNote { background: #3a4758; color: #f0d060; border: 1px solid #c8a840; padding: 10px; margin-bottom: 10px; border-radius: 6px; text-align: left; font-size: 0.9em; display: none; }

        /* ëª¨ë‹¬ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(15,20,30,0.85); align-items: center; justify-content: center; }
        .modal-content { background-color: #2a3040; padding: 15px; border-radius: 12px; width: 90%; max-width: 450px; max-height: 80vh; display: flex; flex-direction: column; border: 1px solid #4d5a6e; }
        .hero-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; overflow-y: auto; padding: 10px; align-content: start; }
        .hero-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .hero-circle { width: 48px; height: 48px; border-radius: 50%; border: 2px solid #5f6d82; overflow: hidden; background: #3a4758; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #a0a8b8; }
        .hero-circle img { width: 100%; height: 100%; object-fit: cover; object-position: top 15%; }
        .hero-name { font-size: 11px; color: #c0c8d8; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 50px;}

        .gear-modal-grid { display: flex; gap: 5px; height: 300px; }
        .gear-col { flex: 1; overflow-y: auto; background: #2a3444; border: 1px solid #4d5a6e; border-radius: 4px; display:flex; flex-direction:column;}
        .gear-btn, .acc-btn { padding: 12px; background: transparent; color: #a0a8b8; border: none; border-bottom: 1px solid #3d4a5c; text-align: left; cursor: pointer; }
        .gear-btn.selected { background: #2a6058; color: #fff; font-weight: bold; }
        .acc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; overflow-y: auto; max-height: 300px; margin-top:10px;}
        .acc-btn { border:1px solid #4d5a6e; background:#3a4758; border-radius:4px; text-align:center;}

        /* --- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ --- */
        .tab-nav { display: flex; gap: 0; margin-bottom: 20px; border-radius: 8px; overflow: hidden; border: 1px solid #4d5a6e; }
        .tab-btn { flex: 1; padding: 14px; background: #2a3040; color: #8090a8; border: none; font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { background: #3a4758; color: #f0d060; border-bottom: 3px solid #f0d060; }

        /* --- ê³µì„±ì „ ìŠ¤í‚¬ ë²„íŠ¼ --- */
        .skill-btns { display: flex; gap: 2px; margin-top: 3px; width: 100%; }
        .skill-btn { flex: 1; padding: 4px 2px; font-size: 9px; font-weight: bold; border-radius: 3px; border: 1px solid #5f6d82; background: #323d50; color: #a0a8b8; cursor: pointer; text-align: center; width: auto; }
        .skill-btn:hover { background: #4a5568; color: #fff; }
        .skill-btn.s1 { border-color: #c89840; color: #f0c860; }
        .skill-btn.s2 { border-color: #4090c0; color: #60b8e8; }

        /* --- ìŠ¤í‚¬ íŒŒì´í”„ë¼ì¸ --- */
        .pipeline-area { background: #253040; border: 1px solid #4d5a6e; border-radius: 8px; padding: 12px; margin-top: 10px; }
        .pipeline-display { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; min-height: 36px; padding: 8px; background: #1e2830; border-radius: 6px; }
        .pipeline-item { display: inline-flex; align-items: center; gap: 3px; background: #2e3a50; border: 1px solid #5f6d82; border-radius: 4px; padding: 4px 8px; font-size: 11px; color: #d8dce6; }
        .pipeline-item .pi-icon { width: 20px; height: 20px; border-radius: 50%; overflow: hidden; flex-shrink: 0; }
        .pipeline-item .pi-icon img { width: 100%; height: 100%; object-fit: cover; object-position: top 10%; }
        .pipeline-item.s1 { border-color: #c89840; }
        .pipeline-item.s2 { border-color: #4090c0; }
        .pipeline-arrow { color: #6a7a90; font-size: 14px; }
        .pipeline-controls { display: flex; gap: 8px; margin-top: 8px; }
        .pipeline-controls button { width: auto; flex: 1; padding: 8px; font-size: 12px; }

        /* --- ìš”ì¼ ì„ íƒ --- */
        .day-nav { display: flex; gap: 4px; margin-bottom: 12px; }
        .day-btn { flex: 1; padding: 10px 4px; background: #323d50; color: #8090a8; border: 1px solid #4d5a6e; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; }
        .day-btn.active { background: #a87ccf; color: #fff; border-color: #a87ccf; }
        .day-btn.sat { }
        .day-btn.sun { }
        .day-btn.sat.active { background: #4090c0; border-color: #4090c0; }
        .day-btn.sun.active { background: #d47474; border-color: #d47474; }

        /* --- íŒŒê´´ì‹  ì‚¬í™© ì„ íƒ --- */
        .sahwang-nav { display: flex; gap: 6px; margin-bottom: 12px; }
        .sahwang-btn { flex: 1; padding: 10px 4px; background: #323d50; color: #8090a8; border: 2px solid #4d5a6e; border-radius: 8px; font-size: 13px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .sahwang-btn .sh-icon { width: 36px; height: 36px; border-radius: 50%; overflow: hidden; border: 2px solid #5f6d82; }
        .sahwang-btn .sh-icon img { width: 100%; height: 100%; object-fit: cover; object-position: top 10%; }
        .sahwang-btn.active { background: #4a3060; border-color: #a87ccf; color: #e0d0f0; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color:#f0d060; text-shadow:0 0 8px rgba(240,208,96,0.3);">âš”ï¸ ì‘ì „ìƒí™©ì‹¤</h2>

    <div id="loginArea" class="box neon-blue">
        <h3>ğŸ” ë¡œê·¸ì¸</h3>
        <input type="text" id="myNick" placeholder="ë‹‰ë„¤ì„">
        <input type="password" id="myKey" placeholder="í‚¤ (ë¹„ë°€ë²ˆí˜¸)">
        <p id="loginMsg" style="color:#8090a8; display:none;">ì ‘ì† ì¤‘...</p>
        <button onclick="tryLogin()">ì ‘ì†í•˜ê¸°</button>
    </div>

    <div id="mainArea" class="hidden">

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('guild')">ê¸¸ë“œì „</button>
            <button class="tab-btn" onclick="switchTab('siege')">ê³µì„±ì „</button>
        </div>

        <div id="guildWarTab">
        <div class="box neon-green">
            <h3>1. íƒ€ê²Ÿ ë° ê³µëµ í™•ì¸</h3>
            <select id="enemySelect" onchange="selectEnemy()">
                <option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
            </select>

            <div id="enemyDeckVisual" class="deck-container" style="justify-content: center; min-height: 60px;">
                <span style="color:#5f6d82; line-height:60px;">ìƒëŒ€ ì •ë³´ ëŒ€ê¸° ì¤‘</span>
            </div>
            <input type="hidden" id="currentEnemyDeck">

            <div id="strategyBox" style="margin-top:10px;"></div>
        </div>

        <div class="box neon-purple">
            <h3>2. ë‚´ ê³µê²©íŒ€ êµ¬ì„±</h3>
            <div id="activeStrategyNote"></div>
            <div class="info-row">
                <select id="myFormation">
                    <option value="ê¸°ë³¸">ê¸°ë³¸ ì§„í˜•</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option>
                </select>
                <input type="text" id="myKeyItems" placeholder="ë©”ëª¨ (í« ìŠ¤í‚¬ ë“±)">
            </div>
            <div class="deck-container" id="myBattleDeckContainer"></div>
            <input type="hidden" id="myBattleDeckResult"><input type="hidden" id="myBattlePetResult">
        </div>

        <div class="box neon-red">
            <h3>3. ê²°ê³¼ ê¸°ë¡</h3>
            <div style="display:flex; gap:10px;">
                <button onclick="record('WIN')" style="background:#3a7a50;">â­â­â­ ìŠ¹ë¦¬</button>
                <button onclick="record('LOSE')" style="background:#8a4040;">âŒ íŒ¨ë°°</button>
            </div>
        </div>

        <button onclick="toggleAdmin()" style="background:#3a4758; margin-top:20px;">ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë“œ</button>

        <div id="adminArea" class="hidden" style="margin-top:20px;">
            <div class="box neon-blue">
                <h3>ğŸ“œ ì‹ ê·œ ê³µëµ ë“±ë¡</h3>
                <select id="targetEnemySelect"></select>
                <div class="info-row">
                    <select id="newFormation"><option value="ê¸°ë³¸">ê¸°ë³¸</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option></select>
                    <input type="text" id="newKeyItems" placeholder="íŠ¹ì´ì‚¬í•­">
                </div>
                <div class="deck-container" id="newAttackDeckContainer"></div>
                <input type="hidden" id="newAttackDeckResult"><input type="hidden" id="newAttackPetResult">
                <textarea id="newStrategyNote" placeholder="ìƒì„¸ ê³µëµ ì‘ì„±" style="height:60px;"></textarea>
                <button onclick="addStrategy()">ê³µëµ ë“±ë¡ ì™„ë£Œ</button>
            </div>
            <div class="box neon-blue">
                <h3>ğŸ‘¾ ì êµ° ì¶”ê°€</h3>
                <input type="text" id="newEnemyName" placeholder="ì  ë‹‰ë„¤ì„">
                <div class="deck-container" onclick="openSelector('enemy', 'HERO')" style="justify-content:center; cursor:pointer;">
                    <div id="preview_enemy_1" class="hero-slot">+</div><div id="preview_enemy_2" class="hero-slot">+</div><div id="preview_enemy_3" class="hero-slot">+</div><div id="preview_enemy_4" class="hero-slot">+</div><div id="preview_enemy_5" class="hero-slot">+</div>
                </div>
                <input type="hidden" id="newEnemyDeckResult">
                <button onclick="addNewEnemy()">ì êµ° ë“±ë¡ ì™„ë£Œ</button>
            </div>
        </div>
        </div><!-- /guildWarTab -->

        <div id="siegeWarTab" class="hidden">

        <div class="day-nav">
            <button class="day-btn" onclick="switchSiegeDay('mon')">ì›”</button>
            <button class="day-btn" onclick="switchSiegeDay('tue')">í™”</button>
            <button class="day-btn" onclick="switchSiegeDay('wed')">ìˆ˜</button>
            <button class="day-btn" onclick="switchSiegeDay('thu')">ëª©</button>
            <button class="day-btn" onclick="switchSiegeDay('fri')">ê¸ˆ</button>
            <button class="day-btn sat" onclick="switchSiegeDay('sat')">í† </button>
            <button class="day-btn sun" onclick="switchSiegeDay('sun')">ì¼</button>
        </div>

        <div class="box neon-purple">
            <h3 id="siegeDayTitle">ê³µì„±ì „ íŒ€ êµ¬ì„±</h3>
            <div class="info-row">
                <select id="siegeFormation">
                    <option value="ê¸°ë³¸">ê¸°ë³¸ ì§„í˜•</option><option value="ë°¸ëŸ°ìŠ¤">ë°¸ëŸ°ìŠ¤</option><option value="ê³µê²©">ê³µê²©</option><option value="ë³´í˜¸">ë³´í˜¸</option>
                </select>
                <input type="text" id="siegeKeyItems" placeholder="ë©”ëª¨">
            </div>
            <div class="deck-container" id="siegeDeckContainer"></div>

            <div class="pipeline-area">
                <h4 style="color:#a0a8b8; margin:0 0 8px 0;">ìŠ¤í‚¬ íŒŒì´í”„ë¼ì¸</h4>
                <div class="pipeline-display" id="pipelineDisplay">
                    <span style="color:#5f6d82;">ìŠ¤í‚¬ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìˆœì„œë¥¼ ì§€ì •í•˜ì„¸ìš”</span>
                </div>
                <div class="pipeline-controls">
                    <button onclick="undoPipeline()" style="background:#4a5568;">ë˜ëŒë¦¬ê¸°</button>
                    <button onclick="clearPipeline()" style="background:#8a4040;">ì´ˆê¸°í™”</button>
                </div>
                <div style="margin-top:8px; padding:6px; background:#2a3444; border-radius:4px;">
                    <span style="font-size:11px; color:#8090a8;">ê²°ê³¼: </span>
                    <span id="pipelineText" style="font-size:11px; color:#6bbd7a;"></span>
                </div>
            </div>

            <button onclick="saveSiege()" style="background:#3a7a50; margin-top:10px;">ì €ì¥</button>
        </div>
        </div><!-- /siegeWarTab -->

    </div>
</div>

<div id="selectorModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">ì„ íƒ</h3>
        <input type="text" id="searchBox" onkeyup="filterItems()" placeholder="ê²€ìƒ‰...">
        <div id="itemGrid" class="hero-grid"></div>
        <button onclick="closeSelectorModal()" style="background:#8a4040; margin-top:10px;">ì·¨ì†Œ</button>
    </div>
</div>

<div id="gearModal" class="modal">
    <div class="modal-content">
        <h3 id="gearModalTitle" style="margin-top:0;">ì¥ë¹„ ì„¤ì •</h3>
        <div class="gear-modal-grid">
            <div class="gear-col"><h4>ì„¸íŠ¸</h4><div id="gearSetList"></div></div>
            <div class="gear-col"><h4>ì£¼ì˜µì…˜</h4><div id="gearOptionList"></div></div>
        </div>
        <div style="padding:10px; background:#3a4758; text-align:center;"><span id="gearPreviewText" style="color:#6bbd7a;">-</span></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="confirmGear()" style="background:#3a7a50;">í™•ì¸</button>
            <button onclick="closeGearModal()" style="background:#8a4040;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="accModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">ì¥ì‹ êµ¬ ì„ íƒ</h3>
        <input type="text" id="customAccInput" placeholder="ì§ì ‘ ì…ë ¥" style="border:1px solid #c8a840;">
        <button onclick="confirmCustomAcc()" style="background:#3a4758; border:1px solid #c8a840;">ì…ë ¥ ì ìš©</button>
        <hr style="width:100%; border-color:#4d5a6e; margin:15px 0;">
        <div id="accList" class="acc-grid"></div>
        <button onclick="closeAccModal()" style="background:#8a4040; margin-top:15px;">ì·¨ì†Œ</button>
    </div>
</div>

<script>
    // âš ï¸ ë³¸ì¸ì˜ GAS URL ì…ë ¥ âš ï¸
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzCecgjx4EPD1JkWhKFAw_3GZgnFK5jtUeWYwfK6Y0FGW320OgGIBrP-UKbyzViAURy/exec";

    // --- ì„¤ì •ê°’ ---
    // â³ ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ ì‹œê°„ ì„¤ì • (ê¸°ë³¸ 60ë¶„: 60 * 60 * 1000)
    const SESSION_TIMEOUT = 60 * 60 * 1000;

    // ë°ì´í„° ì •ì˜
    const DATA_HEROES = (typeof HEROES !== 'undefined') ? HEROES : ["ë£¨ë””", "ì—ë°˜", "ì œì´ë¸Œ"];
    const DATA_PETS = ["ë£¨", "ì´ë¦°", "ë¦¬ì²¼", "í¬ë¦¬", "íŒŒì´í¬", "ë¸ë¡œ", "ìœˆë””", "ìœ ", "ì—°ì§€", "ì¹´ëŒ", "ë©œíŒ¨ë¡œ", "ì•„ì´ë°˜", "ì¹´ë Œ", "ë¦¬ì¿ ", "ì¥¬ì‹œ", "í—¬ë ˆí•€", "í—¤ë¦¬í•€", "ì œë‹ˆí¼", "ìœ ìš°", "í¬ë¡œì•„", "íŒŒë¼ê³¤", "ë…¸íŠ¸", "ë² ì´", "ë‹ˆí‚¤", "ì„¸ë¦¬", "R-rl", "í‘¸ë¦¬", "ì•„ì•¼", "ë¼êµ¬ë¦¬", "í•´ë¥´í”¼", "ì‚¬ë€", "ë‹ˆë‚˜", "í’ì†Œí˜‘", "ë®¤ë®¤", "ë¯¹", "ë”ì§€", "ì—ë¦¬", "ë¯¸ë¯¹", "ë‘"];

    const GEAR_SETS = ["ì„ ë´‰ì¥", "ì¶”ì ì", "ì„±ê¸°ì‚¬", "ìˆ˜ë¬¸ì¥", "ìˆ˜í˜¸ì", "ì•”ì‚´ì", "ë³µìˆ˜ì", "ì£¼ìˆ ì‚¬", "ì¡°ìœ¨ì"];
    const OPTS_WEAPON = ["ì•½ì  ê³µê²© í™•ë¥ ", "ì¹˜ëª…íƒ€ í™•ë¥ ", "ì¹˜ëª…íƒ€ í”¼í•´", "ëª¨ë“  ê³µê²©ë ¥(%)", "ëª¨ë“  ê³µê²©ë ¥", "ë°©ì–´ë ¥(%)", "ë°©ì–´ë ¥", "ìƒëª…ë ¥(%)", "ìƒëª…ë ¥", "íš¨ê³¼ì ì¤‘"];
    const OPTS_ARMOR = ["ë°›ëŠ”í”¼í•´ê°ì†Œ", "ë§‰ê¸°í™•ë¥ ", "ëª¨ë“  ê³µê²©ë ¥(%)", "ëª¨ë“  ê³µê²©ë ¥", "ë°©ì–´ë ¥(%)", "ë°©ì–´ë ¥", "ìƒëª…ë ¥(%)", "ìƒëª…ë ¥", "íš¨ê³¼ì €í•­"];
    const GEAR_ACCESSORIES = ["ë¶€í™œì˜ ë°˜ì§€", "ë¶ˆì‚¬ì˜ ë°˜ì§€", "ê¶ŒëŠ¥ì˜ ë°˜ì§€", "ê¸°í•©ì˜ ë°˜ì§€", "ì² ë²½ì˜ ë°˜ì§€", "ê±´ê°•ì˜ ë°˜ì§€", "í† ë²Œì˜ ë°˜ì§€", "ê³µì„±ì˜ ë°˜ì§€", "ì„¬ë©¸ì˜ ë°˜ì§€", "ê·¼ì„±ì˜ ë°˜ì§€"];

    // ë³€ìˆ˜
    let myDeckState = Array(5).fill().map(()=>({name:"", w1:"", a1:"", w2:"", a2:"", acc:""}));
    let adminDeckState = Array(5).fill().map(()=>({name:"", w1:"", a1:"", w2:"", a2:"", acc:""}));
    let myPetState = "", adminPetState = "", tempEnemyHeroes = [];
    let globalData = { members: [], enemies: [], strategies: [] };
    let currentMode = "", currentGearIndex = 0, currentGearSlot = "", tempGearSet = "", tempGearOpt = "", tempHeroIndex = 0;

    // ê³µì„±ì „ ë³€ìˆ˜
    const DAYS = ['mon','tue','wed','thu','fri','sat','sun'];
    const DAY_LABELS = {mon:'ì›”',tue:'í™”',wed:'ìˆ˜',thu:'ëª©',fri:'ê¸ˆ',sat:'í† ',sun:'ì¼'};
    let currentSiegeDay = "";
    let siegeData = {};
    DAYS.forEach(d => { siegeData[d] = { deck: Array(5).fill().map(()=>({name:"",w1:"",a1:"",w2:"",a2:"",acc:""})), pet:"", pipeline:[], formation:"ê¸°ë³¸", memo:"" }; });
    // í˜„ì¬ ìš”ì¼ í™œì„± ìƒíƒœ (ì°¸ì¡°ìš©)
    let siegeDeckState = siegeData.mon.deck;
    let siegePetState = "";
    let skillPipeline = [];

    // --- ì´ˆê¸°í™” ë° ì„¸ì…˜ ì²´í¬ ---
    window.onload = function() {
        checkSession(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ í™•ì¸

        // Keep Alive: ì‚¬ìš©ìê°€ í´ë¦­ì´ë‚˜ í‚¤ ì…ë ¥ì„ í•  ë•Œë§ˆë‹¤ ì„¸ì…˜ ì—°ì¥
        document.addEventListener('click', refreshSession);
        document.addEventListener('keydown', refreshSession);
        document.addEventListener('touchstart', refreshSession);

        renderInteractiveDeck('myBattle');
        renderInteractiveDeck('attack');

        // ì˜¤ëŠ˜ ìš”ì¼ ìë™ ì„ íƒ (JS: 0=ì¼,1=ì›”,...6=í† )
        const jsDay = new Date().getDay();
        const dayMap = [6,0,1,2,3,4,5]; // JSìš”ì¼â†’DAYSì¸ë±ìŠ¤
        switchSiegeDay(DAYS[dayMap[jsDay]]);
    };

    // ğŸ•’ ì„¸ì…˜ í™•ì¸ ë¡œì§
    function checkSession() {
        const savedNick = localStorage.getItem("guildWarNick");
        const expiryTime = localStorage.getItem("guildWarExpiry"); // ë§Œë£Œ ì˜ˆì • ì‹œê°„

        if (savedNick && expiryTime) {
            const now = new Date().getTime();

            if (now > parseInt(expiryTime)) {
                // ì‹œê°„ ë§Œë£Œë¨
                logout("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
            } else {
                // ìœ íš¨í•¨ -> ìë™ ë¡œê·¸ì¸ ì§„í–‰
                document.getElementById('myNick').value = savedNick;
                tryLogin(true);
            }
        }
    }

    // ğŸ•’ ì„¸ì…˜ ì—°ì¥ (Keep Alive)
    function refreshSession() {
        // ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œë§Œ ì—°ì¥
        if (!document.getElementById('mainArea').classList.contains('hidden')) {
            const newExpiry = new Date().getTime() + SESSION_TIMEOUT;
            localStorage.setItem("guildWarExpiry", newExpiry);
        }
    }

    // ğŸšª ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    function logout(msg = "") {
        localStorage.removeItem("guildWarNick");
        localStorage.removeItem("guildWarExpiry");
        if(msg) alert(msg);
        location.reload();
    }

    // --- ë¡œê·¸ì¸ ---
    function tryLogin(isAuto=false) {
        const nick = document.getElementById('myNick').value, key = document.getElementById('myKey').value;
        const msg = document.getElementById('loginMsg');

        if(!isAuto && (!nick||!key)) return alert("ì…ë ¥í•˜ì„¸ìš”");

        msg.style.display='block';
        if(!isAuto) msg.innerText = "ì„œë²„ ì—°ê²° ì¤‘...";

        fetch(GAS_URL).then(r=>r.json()).then(d => {
            globalData = d;

            let valid = true;
            // ìˆ˜ë™ ë¡œê·¸ì¸ì¼ ë•Œë§Œ í‚¤ ê²€ì‚¬ (ìë™ ë¡œê·¸ì¸ì€ ì´ë¯¸ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì‹ ë¢°)
            if(d.members && d.members.length > 0 && !isAuto) {
                valid = d.members.find(m => String(m.nick)===nick && String(m.key)===key);
            }

            if(valid) {
                // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì„¸ì…˜ ì €ì¥ (í˜„ì¬ì‹œê°„ + íƒ€ì„ì•„ì›ƒ)
                localStorage.setItem("guildWarNick", nick);
                refreshSession(); // ì‹œê°„ ì„¤ì •

                document.getElementById('loginArea').classList.add('hidden');
                document.getElementById('mainArea').classList.remove('hidden');
                renderDropdowns();
                loadSiegeFromServer(nick);
            } else {
                msg.innerText = "ë¶ˆì¼ì¹˜"; msg.style.color = "#d47474";
            }
        }).catch(e=>{ msg.innerText="í†µì‹ ì˜¤ë¥˜"; });
    }

    function renderDropdowns() {
        const sel = document.getElementById('enemySelect'), adm = document.getElementById('targetEnemySelect');
        const v = sel.value;
        sel.innerHTML='<option value="">-- ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>'; adm.innerHTML='<option value="">-- ëŒ€ìƒ ì„ íƒ --</option>';
        globalData.enemies.forEach(e => { sel.add(new Option(e.name, e.name)); adm.add(new Option(e.name, e.name)); });
        if(v) sel.value = v;
    }

    // --- í…ìŠ¤íŠ¸ ì²˜ë¦¬ ---
    function getAbbr(t) {
        if(!t) return "";
        const m = {
            "ì„ ë´‰ì¥":"ì„ ë´‰", "ì¶”ì ì":"ì¶”ì ", "ì„±ê¸°ì‚¬":"ì„±ê¸°", "ìˆ˜ë¬¸ì¥":"ìˆ˜ë¬¸", "ìˆ˜í˜¸ì":"ìˆ˜í˜¸", "ì•”ì‚´ì":"ì•”ì‚´", "ë³µìˆ˜ì":"ë³µìˆ˜", "ì£¼ìˆ ì‚¬":"ì£¼ìˆ ", "ì¡°ìœ¨ì":"ì¡°ìœ¨",
            "ì•½ì  ê³µê²© í™•ë¥ ":"ì•½ê³µ", "ì¹˜ëª…íƒ€ í™•ë¥ ":"ì¹˜í™•", "ì¹˜ëª…íƒ€ í”¼í•´":"ì¹˜í”¼", "ëª¨ë“  ê³µê²©ë ¥(%)":"ê³µ%", "ëª¨ë“  ê³µê²©ë ¥":"ê³µ",
            "ë°©ì–´ë ¥(%)":"ë°©%", "ë°©ì–´ë ¥":"ë°©", "ìƒëª…ë ¥(%)":"ìƒ%", "ìƒëª…ë ¥":"ìƒ", "íš¨ê³¼ì ì¤‘":"íš¨ì ", "íš¨ê³¼ì €í•­":"íš¨ì €", "ë°›ëŠ”í”¼í•´ê°ì†Œ":"ë°›í”¼", "ë§‰ê¸°í™•ë¥ ":"ë§‰ê¸°",
            "ë¶€í™œì˜ ë°˜ì§€":"ë¶€í™œ", "ë¶ˆì‚¬ì˜ ë°˜ì§€":"ë¶ˆì‚¬", "ê¶ŒëŠ¥ì˜ ë°˜ì§€":"ê¶ŒëŠ¥", "ê¸°í•©ì˜ ë°˜ì§€":"ê¸°í•©", "ì² ë²½ì˜ ë°˜ì§€":"ì² ë²½",
            "ê±´ê°•ì˜ ë°˜ì§€":"ê±´ê°•", "í† ë²Œì˜ ë°˜ì§€":"í† ë²Œ", "ê³µì„±ì˜ ë°˜ì§€":"ê³µì„±", "ì„¬ë©¸ì˜ ë°˜ì§€":"ì„¬ë©¸", "ê·¼ì„±ì˜ ë°˜ì§€":"ê·¼ì„±"
        };
        return m[t] || t;
    }

    function formatGearSlot(fullText) {
        if(!fullText) return "";
        const firstParen = fullText.indexOf('(');
        const lastParen = fullText.lastIndexOf(')');
        if(firstParen > 0 && lastParen > firstParen) {
            const set = fullText.substring(0, firstParen);
            const opt = fullText.substring(firstParen + 1, lastParen);
            return `${getAbbr(set)}(${getAbbr(opt)})`;
        }
        return getAbbr(fullText);
    }

    // --- ë± ë Œë”ë§ ---
    function renderInteractiveDeck(mode) {
        const container = document.getElementById(mode==='myBattle'?'myBattleDeckContainer':'newAttackDeckContainer');
        const state = mode==='myBattle'?myDeckState:adminDeckState;
        const pState = mode==='myBattle'?myPetState:adminPetState;

        let h = "";
        state.forEach((o, i) => {
            const img = o.name ?
                `<img src="images/${o.name}.png" onerror="this.style.display='none'; this.parentNode.innerText='${o.name[0]}'">`
                : "+";

            h += `<div class="hero-card">
                    <div class="hero-slot" onclick="openSelector('${mode}','HERO',${i})">${img}</div>
                    <div class="equipment-grid">
                        <div class="gear-slot slot-w1" onclick="openGear('${mode}',${i},'w1')">${formatGearSlot(o.w1)||"W1"}</div>
                        <div class="gear-slot slot-a1" onclick="openGear('${mode}',${i},'a1')">${formatGearSlot(o.a1)||"A1"}</div>
                        <div class="acc-slot" onclick="openAcc('${mode}',${i})">${getAbbr(o.acc)||"Acc"}</div>
                        <div class="gear-slot slot-w2" onclick="openGear('${mode}',${i},'w2')">${formatGearSlot(o.w2)||"W2"}</div>
                        <div class="gear-slot slot-a2" onclick="openGear('${mode}',${i},'a2')">${formatGearSlot(o.a2)||"A2"}</div>
                    </div>
                  </div>`;
        });

        const pImg = pState ?
            `<img src="images/${pState}.png" onerror="this.style.display='none'; this.parentNode.innerText='${pState}'">`
            : "<span style='font-size:10px;color:#888'>PET</span>";

        h += `<div class="pet-wrapper"><div class="pet-slot" onclick="openSelector('${mode}','PET')">${pImg}</div></div>`;
        container.innerHTML = h;

        const res = state.filter(x=>x.name).map(x => {
            if(x.w1||x.a1||x.w2||x.a2||x.acc) return `${x.name}(${x.w1||"-"}/${x.a1||"-"}/${x.w2||"-"}/${x.a2||"-"}/${x.acc||"-"})`;
            return x.name;
        }).join(", ");
        document.getElementById(mode==='myBattle'?'myBattleDeckResult':'newAttackDeckResult').value = res;
        document.getElementById(mode==='myBattle'?'myBattlePetResult':'newAttackPetResult').value = pState;
    }

    // --- ê°ì¢… ëª¨ë‹¬ ---
    function openSelector(mode, type, idx=0) {
        if(mode==='enemy') { currentMode=mode; openCommonModal('HERO'); return; }
        currentMode=mode; tempHeroIndex=idx;
        document.getElementById('modalTitle').innerText = type==='HERO'?"ì˜ì›… ì„ íƒ":"í« ì„ íƒ";
        openCommonModal(type);
    }
    function openCommonModal(type) {
        document.getElementById('searchBox').value=""; renderItemGrid(type);
        document.getElementById('selectorModal').style.display='flex';
    }
    function renderItemGrid(type, filter="") {
        const g = document.getElementById('itemGrid'); g.innerHTML="";
        const src = type==='HERO'?DATA_HEROES:DATA_PETS;
        src.filter(x=>x.includes(filter)).forEach(item => {
            const d = document.createElement('div'); d.className='hero-item';
            d.onclick=()=>{confirmSel(type,item)};
            d.innerHTML=`<div class="hero-circle"><img src="images/${item}.png" onerror="this.style.display='none'; this.parentNode.innerText='${item[0]}'"></div><div class="hero-name">${item}</div>`;
            g.appendChild(d);
        });
    }
    function filterItems() { renderItemGrid(document.getElementById('modalTitle').innerText.includes("ì˜ì›…")?'HERO':'PET', document.getElementById('searchBox').value); }
    function getDeckState(mode) {
        if(mode==='myBattle') return myDeckState;
        if(mode==='siege') return siegeDeckState;
        return adminDeckState;
    }
    function renderDeckByMode(mode) {
        if(mode==='siege') renderSiegeDeck();
        else renderInteractiveDeck(mode);
    }

    function confirmSel(type, val) {
        if(currentMode==='enemy') { if(tempEnemyHeroes.length>=5) return alert("5ëª…ê¹Œì§€"); tempEnemyHeroes.push(val); updateEnemyPrev(); }
        else {
            if(type==='HERO') getDeckState(currentMode)[tempHeroIndex].name=val;
            else {
                if(currentMode==='myBattle') myPetState=val;
                else if(currentMode==='siege') siegePetState=val;
                else adminPetState=val;
            }
            renderDeckByMode(currentMode);
        }
        closeSelectorModal();
    }
    function closeSelectorModal() { document.getElementById('selectorModal').style.display='none'; }

    // ì¥ë¹„
    function openGear(mode, idx, slot) {
        const s = getDeckState(mode); if(!s[idx].name) return alert("ì˜ì›… ë¨¼ì €");
        currentMode=mode; currentGearIndex=idx; currentGearSlot=slot; tempGearSet=""; tempGearOpt="";
        document.getElementById('gearPreviewText').innerText="-";
        const sd=document.getElementById('gearSetList'); sd.innerHTML="";
        GEAR_SETS.forEach(x=>{
            const b=document.createElement('button'); b.className="gear-btn"; b.innerText=x;
            b.onclick=()=>{tempGearSet=x; hl(sd,b); upG();}; sd.appendChild(b);
        });
        const od=document.getElementById('gearOptionList'); od.innerHTML="";
        (slot.includes('w')?OPTS_WEAPON:OPTS_ARMOR).forEach(x=>{
            const b=document.createElement('button'); b.className="gear-btn"; b.innerText=x;
            b.onclick=()=>{tempGearOpt=x; hl(od,b); upG();}; od.appendChild(b);
        });
        const r=document.createElement('button'); r.className="gear-btn"; r.innerText="(í•´ì œ)"; r.style.color="#d47474";
        r.onclick=()=>{tempGearSet="EMPTY"; confirmGear();}; od.appendChild(r);
        document.getElementById('gearModal').style.display='flex';
    }
    function hl(p,t) { Array.from(p.children).forEach(c=>c.classList.remove('selected')); t.classList.add('selected'); }
    function upG() { document.getElementById('gearPreviewText').innerText = `${tempGearSet}(${tempGearOpt})`; }
    function confirmGear() {
        const s = getDeckState(currentMode);
        if(tempGearSet==="EMPTY") s[currentGearIndex][currentGearSlot]="";
        else { if(!tempGearSet||!tempGearOpt) return alert("ë‘˜ ë‹¤ ì„ íƒ"); s[currentGearIndex][currentGearSlot]=`${tempGearSet}(${tempGearOpt})`; }
        renderDeckByMode(currentMode); closeGearModal();
    }
    function closeGearModal() { document.getElementById('gearModal').style.display='none'; }

    // ì¥ì‹ êµ¬
    function openAcc(mode, idx) {
        const s=getDeckState(mode); if(!s[idx].name) return alert("ì˜ì›… ë¨¼ì €");
        currentMode=mode; currentGearIndex=idx;
        const l=document.getElementById('accList'); l.innerHTML="";
        GEAR_ACCESSORIES.forEach(x=>{
            const b=document.createElement('button'); b.className="acc-btn"; b.innerText=x;
            b.onclick=()=>{s[currentGearIndex].acc=x; renderDeckByMode(currentMode); closeAccModal();};
            l.appendChild(b);
        });
        const r=document.createElement('button'); r.className="acc-btn"; r.innerText="(í•´ì œ)"; r.style.borderColor="red";
        r.onclick=()=>{s[currentGearIndex].acc=""; renderDeckByMode(currentMode); closeAccModal();}; l.appendChild(r);
        document.getElementById('accModal').style.display='flex';
    }
    function confirmCustomAcc() {
        const v=document.getElementById('customAccInput').value; if(v) {
            getDeckState(currentMode)[currentGearIndex].acc=v; renderDeckByMode(currentMode); closeAccModal();
        }
    }
    function closeAccModal() { document.getElementById('accModal').style.display='none'; }

    // --- ê³µëµ ì ìš© ---
    function selectEnemy() {
        const n=document.getElementById('enemySelect').value; const e=globalData.enemies.find(x=>x.name===n);
        const v=document.getElementById('enemyDeckVisual');
        document.getElementById('activeStrategyNote').style.display = 'none';

        if(!e) return v.innerHTML="<span style='color:#5f6d82;line-height:60px'>ì •ë³´ ì—†ìŒ</span>";
        document.getElementById('currentEnemyDeck').value=e.deck;

        let h="";
        e.deck.split(',').forEach(x=>{
            const name=x.split('(')[0].trim();
            h+=`<div class="hero-slot" style="margin:0 2px; border-color:#d47474;"><img src="images/${name}.png" onerror="this.style.display='none';this.parentNode.innerText='${name[0]}'"></div>`;
        });
        v.innerHTML=h;

        const sb=document.getElementById('strategyBox');
        const list=globalData.strategies.filter(x=>x.target===n);
        if(list.length>0) {
            let sh="";
            list.forEach((s,i)=>{
                let icons="";
                s.attack.split(',').forEach(k=>{
                    const firstParen = k.indexOf('(');
                    const name = firstParen > 0 ? k.substring(0, firstParen).trim() : k.trim();
                    icons+=`<div class="strategy-icon"><img src="images/${name}.png" onerror="this.style.display='none';"></div>`;
                });
                sh+=`<div class="strategy-card" onclick='applyStrategy(${JSON.stringify(s)})'>
                        <div style="display:flex;justify-content:space-between;"><span style="color:#f0d060">ì¶”ì²œ #${i+1} (${s.formation})</span><span style="font-size:0.8em;color:#8090a8">${s.pet}</span></div>
                        <div class="strategy-deck-preview">${icons}</div>
                        <div style="font-size:0.8em;color:#6bbd7a">ğŸ’¡ ${s.items||""}</div>
                     </div>`;
            });
            sb.innerHTML=sh;
        } else sb.innerHTML="<p style='color:#5f6d82'>ê³µëµ ì—†ìŒ</p>";
    }

    function applyStrategy(s) {
        myDeckState = Array(5).fill().map(()=>({name:"", w1:"", a1:"", w2:"", a2:"", acc:""}));
        const parts = s.attack.split(',').map(p=>p.trim());

        parts.forEach((p, i) => {
            if(i>=5) return;
            const firstParen = p.indexOf('(');
            const lastParen = p.lastIndexOf(')');
            if(firstParen > 0 && lastParen > firstParen) {
                myDeckState[i].name = p.substring(0, firstParen).trim();
                const content = p.substring(firstParen + 1, lastParen);
                const g = content.split('/');
                myDeckState[i].w1=g[0]||""; myDeckState[i].a1=g[1]||""; myDeckState[i].w2=g[2]||""; myDeckState[i].a2=g[3]||""; myDeckState[i].acc=g[4]||"";
            } else {
                myDeckState[i].name = p;
            }
        });

        myPetState = s.pet || "";
        document.getElementById('myFormation').value = s.formation || "ê¸°ë³¸";
        document.getElementById('myKeyItems').value = s.items || "";

        const noteBox = document.getElementById('activeStrategyNote');
        if(s.note) {
            noteBox.style.display = 'block';
            noteBox.innerHTML = `<strong>ğŸ“ ê³µëµ ë…¸íŠ¸:</strong><br>${s.note.replace(/\n/g, '<br>')}`;
        } else {
            noteBox.style.display = 'none';
        }

        renderInteractiveDeck('myBattle');
        document.querySelector('.neon-purple').scrollIntoView({behavior:'smooth'});
        refreshSession(); // í™œë™ ê°ì§€
    }

    // --- ë¹„ë™ê¸° ì „ì†¡ (ê¹œë¹¡ì„ í•´ê²°) ---
    function sendData(payload, successCallback) {
        const btn = event.target;
        const originalText = btn.innerText;
        btn.disabled = true; btn.innerText = "ì²˜ë¦¬ ì¤‘...";

        fetch(GAS_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type":"application/json"},
            body: JSON.stringify(payload)
        }).then(() => {
            // ì„±ê³µ ì‹œ ìˆ˜í–‰í•  ì½œë°± í•¨ìˆ˜ ì‹¤í–‰
            if(successCallback) successCallback();

            refreshSession(); // í™œë™ìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ ì„¸ì…˜ ì—°ì¥
            btn.disabled = false; btn.innerText = originalText;
        }).catch(err => {
            alert("ì „ì†¡ ì˜¤ë¥˜");
            btn.disabled = false; btn.innerText = originalText;
        });
    }

    function addStrategy() {
        const t=document.getElementById('targetEnemySelect').value, d=document.getElementById('newAttackDeckResult').value;
        const p=document.getElementById('newAttackPetResult').value, f=document.getElementById('newFormation').value;
        const i=document.getElementById('newKeyItems').value, n=document.getElementById('newStrategyNote').value;
        const a=document.getElementById('myNick').value;

        if(!t||!d) return alert("í•„ìˆ˜ ì…ë ¥ ëˆ„ë½");

        sendData({
            action: "add_strategy", targetEnemy:t, attackDeck:d, pet:p, formation:f, keyItems:i, note:n, author:a
        }, () => {
            alert("ê³µëµ ë“±ë¡ ì™„ë£Œ!");
            // ë¡œì»¬ ë°ì´í„°ì— ì¦‰ì‹œ ì¶”ê°€ (ìƒˆë¡œê³ ì¹¨ ì—†ì´ ë°˜ì˜)
            globalData.strategies.push({target:t, attack:d, pet:p, formation:f, items:i, note:n, author:a});
            // í˜„ì¬ í™”ë©´ì´ í•´ë‹¹ ì ì„ ë³´ê³  ìˆë‹¤ë©´ ë°”ë¡œ ê°±ì‹ 
            if(document.getElementById('enemySelect').value === t) selectEnemy();

            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('newKeyItems').value=""; document.getElementById('newStrategyNote').value="";
            adminDeckState = Array(5).fill().map(()=>({name:"", w1:"", a1:"", w2:"", a2:"", acc:""}));
            adminPetState = "";
            renderInteractiveDeck('attack');
        });
    }

    function addNewEnemy() {
        const n=document.getElementById('newEnemyName').value, d=document.getElementById('newEnemyDeckResult').value;
        if(!n||!d) return alert("ì…ë ¥ ëˆ„ë½");

        sendData({action:"add_enemy", enemyName:n, defenseDeck:d}, () => {
            alert("ì êµ° ë“±ë¡ ì™„ë£Œ!");
            globalData.enemies.push({name:n, deck:d});
            renderDropdowns();
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('newEnemyName').value="";
            tempEnemyHeroes=[]; updateEnemyPrev();
        });
    }

    function record(r) {
        const t=document.getElementById('enemySelect').value, d=document.getElementById('myBattleDeckResult').value;
        if(!t||!d) return alert("í•„ìˆ˜ ì •ë³´ ëˆ„ë½");

        sendData({
            action: "record", nickname:document.getElementById('myNick').value, enemyName:t,
            enemyDeck:document.getElementById('currentEnemyDeck').value, myDeck:d,
            pet:document.getElementById('myBattlePetResult').value, formation:document.getElementById('myFormation').value, result:r
        }, () => {
            alert("ê¸°ë¡ ì™„ë£Œ!");
        });
    }

    function updateEnemyPrev() {
        for(let i=1; i<=5; i++) document.getElementById(`preview_enemy_${i}`).innerHTML=tempEnemyHeroes[i-1]?`<img src="images/${tempEnemyHeroes[i-1]}.png" style="width:100%;height:100%;object-fit:cover;">`:"+";
        document.getElementById('newEnemyDeckResult').value=tempEnemyHeroes.join(',');
    }

    function toggleAdmin() { document.getElementById('adminArea').classList.toggle('hidden'); }
    function closeSelectorModal() { document.getElementById('selectorModal').style.display = 'none'; }

    // --- íƒ­ ì „í™˜ ---
    function switchTab(tab) {
        const btns = document.querySelectorAll('.tab-btn');
        btns[0].classList.toggle('active', tab==='guild');
        btns[1].classList.toggle('active', tab==='siege');
        document.getElementById('guildWarTab').classList.toggle('hidden', tab!=='guild');
        document.getElementById('siegeWarTab').classList.toggle('hidden', tab!=='siege');
    }

    // --- ìš”ì¼ ì „í™˜ ---
    function saveCurrentDayState() {
        if(!currentSiegeDay) return;
        const sd = siegeData[currentSiegeDay];
        sd.deck = siegeDeckState.map(o => ({...o}));
        sd.pet = siegePetState;
        sd.pipeline = skillPipeline.map(p => ({...p}));
        sd.formation = document.getElementById('siegeFormation').value;
        sd.memo = document.getElementById('siegeKeyItems').value;
    }

    function loadDayState(day) {
        const sd = siegeData[day];
        siegeDeckState = sd.deck;
        siegePetState = sd.pet;
        skillPipeline = sd.pipeline;
        document.getElementById('siegeFormation').value = sd.formation || "ê¸°ë³¸";
        document.getElementById('siegeKeyItems').value = sd.memo || "";
        document.getElementById('siegeDayTitle').innerText = `ê³µì„±ì „ íŒ€ êµ¬ì„± (${DAY_LABELS[day]}ìš”ì¼)`;
    }

    function switchSiegeDay(day) {
        saveCurrentDayState();
        currentSiegeDay = day;
        loadDayState(day);

        document.querySelectorAll('.day-btn').forEach((btn, i) => {
            btn.classList.toggle('active', DAYS[i] === day);
        });
        renderSiegeDeck();
        renderPipeline();
    }

    // --- ì„œë²„ì—ì„œ ê³µì„±ì „ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ---
    function loadSiegeFromServer(nick) {
        if(!globalData.siege) return;
        globalData.siege.filter(s => s.nickname === nick).forEach(s => {
            if(!siegeData[s.day]) return;
            const sd = siegeData[s.day];
            sd.formation = s.formation || "ê¸°ë³¸";
            sd.memo = s.memo || "";
            sd.pet = s.pet || "";

            // ë± íŒŒì‹±
            if(s.deck) {
                sd.deck = Array(5).fill().map(()=>({name:"",w1:"",a1:"",w2:"",a2:"",acc:""}));
                s.deck.split(',').map(p=>p.trim()).forEach((p, i) => {
                    if(i>=5) return;
                    const fp = p.indexOf('('), lp = p.lastIndexOf(')');
                    if(fp > 0 && lp > fp) {
                        sd.deck[i].name = p.substring(0, fp).trim();
                        const g = p.substring(fp+1, lp).split('/');
                        sd.deck[i].w1=g[0]||""; sd.deck[i].a1=g[1]||""; sd.deck[i].w2=g[2]||""; sd.deck[i].a2=g[3]||""; sd.deck[i].acc=g[4]||"";
                    } else {
                        sd.deck[i].name = p;
                    }
                });
            }

            // íŒŒì´í”„ë¼ì¸ íŒŒì‹±: "ì˜ì›…A(S1) â†’ ì˜ì›…B(S2)" í˜•ì‹
            sd.pipeline = [];
            if(s.pipeline) {
                s.pipeline.split('â†’').map(x=>x.trim()).filter(x=>x).forEach(token => {
                    const m = token.match(/^(.+)\(S(\d)\)$/);
                    if(m) sd.pipeline.push({hero: m[1], skill: parseInt(m[2])});
                });
            }
        });

        // í˜„ì¬ ì„ íƒëœ ìš”ì¼ ë‹¤ì‹œ ë¡œë“œ
        loadDayState(currentSiegeDay);
        renderSiegeDeck();
        renderPipeline();
    }

    // --- ê³µì„±ì „ ì €ì¥ ---
    function saveSiege() {
        saveCurrentDayState();
        const sd = siegeData[currentSiegeDay];
        const nick = document.getElementById('myNick').value;

        const deckStr = sd.deck.filter(x=>x.name).map(x => {
            if(x.w1||x.a1||x.w2||x.a2||x.acc) return `${x.name}(${x.w1||"-"}/${x.a1||"-"}/${x.w2||"-"}/${x.a2||"-"}/${x.acc||"-"})`;
            return x.name;
        }).join(", ");

        const pipeStr = sd.pipeline.map(p => `${p.hero}(S${p.skill})`).join(" \u2192 ");

        if(!deckStr) return alert("ì˜ì›…ì„ ë°°ì¹˜í•´ì£¼ì„¸ìš”");

        sendData({
            action: "save_siege",
            nickname: nick,
            day: currentSiegeDay,
            deck: deckStr,
            pet: sd.pet,
            formation: sd.formation,
            memo: sd.memo,
            pipeline: pipeStr
        }, () => {
            alert(`${DAY_LABELS[currentSiegeDay]}ìš”ì¼ ê³µì„±ì „ ì €ì¥ ì™„ë£Œ!`);
        });
    }

    // --- ê³µì„±ì „ ë± ë Œë”ë§ ---
    function renderSiegeDeck() {
        const container = document.getElementById('siegeDeckContainer');
        let h = "";
        siegeDeckState.forEach((o, i) => {
            const img = o.name ?
                `<img src="images/${o.name}.png" onerror="this.style.display='none'; this.parentNode.innerText='${o.name[0]}'">`
                : "+";

            h += `<div class="hero-card">
                    <div class="hero-slot" onclick="openSelector('siege','HERO',${i})">${img}</div>
                    <div class="equipment-grid">
                        <div class="gear-slot slot-w1" onclick="openGear('siege',${i},'w1')">${formatGearSlot(o.w1)||"W1"}</div>
                        <div class="gear-slot slot-a1" onclick="openGear('siege',${i},'a1')">${formatGearSlot(o.a1)||"A1"}</div>
                        <div class="acc-slot" onclick="openAcc('siege',${i})">${getAbbr(o.acc)||"Acc"}</div>
                        <div class="gear-slot slot-w2" onclick="openGear('siege',${i},'w2')">${formatGearSlot(o.w2)||"W2"}</div>
                        <div class="gear-slot slot-a2" onclick="openGear('siege',${i},'a2')">${formatGearSlot(o.a2)||"A2"}</div>
                    </div>
                    <div class="skill-btns">
                        <button class="skill-btn s1" onclick="addSkill(${i},1)" ${o.name?'':'disabled'}>ìŠ¤í‚¬1</button>
                        <button class="skill-btn s2" onclick="addSkill(${i},2)" ${o.name?'':'disabled'}>ìŠ¤í‚¬2</button>
                    </div>
                  </div>`;
        });

        const pImg = siegePetState ?
            `<img src="images/${siegePetState}.png" onerror="this.style.display='none'; this.parentNode.innerText='${siegePetState}'">`
            : "<span style='font-size:10px;color:#888'>PET</span>";

        h += `<div class="pet-wrapper"><div class="pet-slot" onclick="openSelector('siege','PET')">${pImg}</div></div>`;
        container.innerHTML = h;
    }

    // --- ìŠ¤í‚¬ íŒŒì´í”„ë¼ì¸ ---
    function addSkill(heroIdx, skillNum) {
        const name = siegeDeckState[heroIdx].name;
        if(!name) return;
        skillPipeline.push({hero: name, skill: skillNum});
        renderPipeline();
    }

    function undoPipeline() {
        skillPipeline.pop();
        renderPipeline();
    }

    function clearPipeline() {
        skillPipeline = [];
        renderPipeline();
    }

    function renderPipeline() {
        const display = document.getElementById('pipelineDisplay');
        const textEl = document.getElementById('pipelineText');

        if(skillPipeline.length === 0) {
            display.innerHTML = "<span style='color:#5f6d82;'>ìŠ¤í‚¬ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìˆœì„œë¥¼ ì§€ì •í•˜ì„¸ìš”</span>";
            textEl.innerText = "";
            return;
        }

        let h = "";
        skillPipeline.forEach((item, i) => {
            if(i > 0) h += `<span class="pipeline-arrow">\u2192</span>`;
            h += `<div class="pipeline-item s${item.skill}">
                    <div class="pi-icon"><img src="images/${item.hero}.png" onerror="this.style.display='none';"></div>
                    ${item.hero}(S${item.skill})
                  </div>`;
        });
        display.innerHTML = h;

        textEl.innerText = skillPipeline.map(item => `${item.hero}(S${item.skill})`).join(" \u2192 ");
    }

</script>
</body>
</html>